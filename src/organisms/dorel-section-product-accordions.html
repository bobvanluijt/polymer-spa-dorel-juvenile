<link rel="import" href="../../bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="../utils/dorel-magento-collect-custom-data.html">

<dom-module id="dorel-section-product-accordions">
  <template>
    <style>

      .accordion-heading {
        @apply(--theme-typography-3);
        margin-top: 0;
        padding: 1.25em;
        transition: color .3s ease;
        color: var(--theme-color-text-link);
      }

      .accordion-heading:focus, .accordion-heading:hover {
        cursor: pointer;
        color: var(--theme-color-text-link-active);
        outline: none;
      }

      .accordion-container {
        box-shadow: inset 0 -2px 0 0 var(--theme-color-monochrome-2);
        position: relative;
        float: left;
        width: 100%;
      }

      .accordion-container:first-child {
        box-shadow: inset 0 -2px 0 0 var(--theme-color-monochrome-2), inset 0 2px 0 0 var(--theme-color-monochrome-2);

      }

      .accordion-content {
        padding: 0 1.5em 1.5em 1.5em;
        float: left;
        width: 100%;
        box-sizing: border-box;
      }

      .accordion-icon {
        position: absolute;
        top: 1.5em;
        right: 1em;
        color: var(--theme-color-text-link);
        z-index: -1;
        transition: .3s ease color, .3s ease transform;
      }

      .accordion-heading:focus + .accordion-icon, .accordion-heading:hover + .accordion-icon {
        color: var(--theme-color-text-link-active);
      }

      .accordion-heading[aria-expanded='true'] + .accordion-icon {
        transform: rotate(180deg);
      }
    </style>


    <dorel-magento-collect-custom-data
      product-id="[[ productId ]]"
      app-cache="[[ appCache ]]"
      data="{{ accordionsData }}"
      type="accordions"></dorel-magento-collect-custom-data>

    <template
      is="dom-if"
      if="[[ accordionsData.accordions.length ]]">

      <dorel-layout-container>
        <dorel-layout-row align="center">
          <dorel-layout-column desktop-column-span="8" tablet-column-span="12" mobile-column-span="12">
            <div class="accordion">
              <template
                is="dom-repeat"
                items="[[ accordionsData.accordions ]]"
                as="accordion">
                <div class="accordion-container">
                  <template
                    is="dom-if"
                    if="[[ _hasValue(accordion.heading) ]]">
                    <h2 class="accordion-heading"
                        aria-expanded="false"
                        tabindex="0"
                        role="button"
                        aria-controls$="#collapse{{ index }}"
                        data-selector$="#collapse{{ index }}"
                        on-click="_toggleCollapse"
                        gtm-parent="[[ gtmParent ]]"
                        gtm-parent-index="[[ gtmParentIndex ]]"
                        gtm-cta-index$="[[ index ]]">[[ accordion.heading ]]</h2>
                    <iron-icon class="accordion-icon"
                               icon="dorel-icons:expand-more"></iron-icon>
                  </template>
                  <iron-collapse id$="collapse{{ index }}">
                    <template
                      is="dom-if"
                      if="[[ _hasValue(accordion.description) ]]">
                      <div class="accordion-content">
                        <dorel-safe-html html="[[ accordion.description ]]"></dorel-safe-html>
                      </div>
                    </template>
                  </iron-collapse>
                </div>
              </template>
            </div>
          </dorel-layout-column>
        </dorel-layout-row>
      </dorel-layout-container>
    </template>
  </template>
  <script>
    Polymer({
      is: 'dorel-section-product-accordions',
      properties: {

        productId: {
          type: Number
        },

        /**
         * @attribute
         * @name accordionsData
         * @description coming from the page-builder this data object is filled
         * with ACF/Wordpress data about the component
         */
        accordionsData: {
          type: Object,
          value: function () {
            return {};
          }
        },

        /**
         * @attribute
         * @name appCache
         * @description the temporary cache of the application,
         * contains data that used to be contained by the globalsManager
         */
        appCache: {
          type: Object
        },
      },

      behaviors: [ConditionalBehaviors],

      /**
       * @name _toggleCollapse
       * @description collapses the right accordion
       *
       */
      _toggleCollapse: function (e) {
        /* Toggle the class and aria attribute  */
        // Get the aria expanded attribute, and convert it to a boolean
        var ariaExpanded = e.target.getAttribute('aria-expanded') == "true";
        // Toggle the aria expanded boolean
        e.target.setAttribute('aria-expanded', !ariaExpanded);

        var selector = e.target.dataset.selector;

        // check state
        var state = (this.$$(selector).classList.contains('iron-collapse-opened'));

        // toggle collapse
        this.$$(selector).toggle();

        // event tracking
        this._eventTracking(e, e.target, state);
      },

      /**
       * @name _eventTracking
       * @description this is for cta tracking only
       * more info http://bit.ly/2nb6I7G
       */
      _eventTracking: function (event, selector, accordionState) {

        var gtmCtaIndex = selector.getAttribute('gtm-cta-index');

        /**
         * Tracking on click for cta
         */
        var event = {
          action: 'toggle-accordion',
          component: 'accordion',
          structure: {
            name: this.gtmParent,
            index: Number(this.gtmParentIndex) + 1,
            event: {
              name: 'accordion-heading',
              index: Number(gtmCtaIndex) + 1,
              state: (accordionState) ? 'closed' : 'open'
            }
          },
          element: selector.innerHTML,
          event: 'polymer_event',
          things: {
            'currentState': (accordionState) ? 'open' : 'closed',
            'targetState': (accordionState) ? 'closed' : 'open'
          }
        };

        this.fire('setAppCache', {value: event, path: 'events'});
      }
    });
  </script>
</dom-module>
