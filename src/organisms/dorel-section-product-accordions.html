<link rel="import" href="../../bower_components/iron-collapse/iron-collapse.html">

<dom-module id="dorel-section-product-accordions">
  <template>
    <style>
      .section-product-accordions {
        float: left;
        width: 100%;
        padding: 4.5em var(--theme-gutter);
        box-sizing: border-box;
      }

      .row {
        @apply(--theme-grid-row);
        @apply(--layout-flex);
      }

      .accordion {
        @apply(--theme-grid-column);
        -ms-flex-preferred-size: calc(var(--theme-column-width) * 6);
        flex-basis: calc(var(--theme-column-width) * 6);
        max-width: calc(var(--theme-column-width) * 6);
        padding: 0 .75em;
        margin: auto;
      }

      .accordion-heading {
        @apply(--theme-typography-3);
        margin-top: 0;
        padding: 1.5rem;
        transition: color .3s ease;
        color: var(--theme-color-text-link);
      }

      .accordion-heading:focus, .accordion-heading:hover {
        cursor: pointer;
        color: var(--theme-color-text-link-active);
      }

      .accordion-container {
        box-shadow: inset 0 -2px 0 0 var(--theme-color-monochrome-2);
        position: relative;
        float: left;
        width: 100%;
      }

      .accordion-content {
        padding: 0 1.5em 1.5em 1.5em;
        margin-top: -1.5em;
        float: left;
        width: 100%;
      }

      .accordion-icon {
        position: absolute;
        top: 1.5em;
        right: 0;
        color: var(--theme-color-text-link);
        transition: .3s ease color, .3s ease transform;
      }

      .accordion-heading:focus + .accordion-icon, .accordion-heading:hover + .accordion-icon {
        color: var(--theme-color-text-link-active);
      }

      .accordion-heading[aria-expanded='true'] + .accordion-icon {
        transform: rotate(180deg);
      }

      /* Responsive Behaviour */
      [mobile-small] .accordion, [mobile-medium] .accordion, [tablets] .accordion {
        -ms-flex-preferred-size: 100%;
        flex-basis: 100%;
        max-width: 100%;
      }

      .section-product-accordions[mobile-medium], .section-product-accordions[mobile-small] {
        padding: 3em var(--theme-gutter-mobile);
      }

      [mobile-small] .accordion-heading, [mobile-medium] .accordion-heading {
        padding-left: 0;
      }

      [mobile-small] .accordion-content, [mobile-medium] .accordion-content {
        padding: 0 0 1.5em 0;
      }

    </style>

    <!-- media queries -->
    <iron-media-query query="(max-width : 479px)"
                      query-matches="{{ mobileSmall }}"></iron-media-query>
    <iron-media-query query="(min-width : 480px) and (max-width : 767px)"
                      query-matches="{{ mobileMedium }}"></iron-media-query>
    <iron-media-query query="(min-width : 768px) and (max-width : 991px)"
                      query-matches="{{ tablets }}"></iron-media-query>
    <iron-media-query query="(min-width : 767px) and (max-width : 1600[x)"
                      query-matches="{{ screenLarge }}"></iron-media-query>

    <section class="section-product-accordions layout horizontal"
             mobile-small$="{{ mobileSmall }}"
             mobile-medium$="{{ mobileMedium }}"
             tablets$="{{ tablets }}">

      <template
        is="dom-if"
        if="[[ accordionsData.accordions.length ]]">
        <div class="row center center-justified">
          <div class="accordion">
            <template
              is="dom-repeat"
              items="[[ accordionsData.accordions ]]"
              as="accordion">
              <div class="accordion-container">
                <template
                  is="dom-if"
                  if="[[ _hasValue(accordion.heading) ]]">
                  <h2 class="accordion-heading"
                      on-tap="_toggleCollapse"
                      aria-expanded="false"
                      aria-controls$="#collapse{{ index }}"
                      tabindex="0"
                      role="button"
                      data-selector$="#collapse{{ index }}">[[ accordion.heading ]]</h2>
                  <iron-icon class="accordion-icon" icon="dorel-icons:expand-more"></iron-icon>
                </template>
                <iron-collapse id$="collapse{{ index }}">
                  <template
                    is="dom-if"
                    if="[[ _hasValue(accordion.content) ]]">
                    <div class="accordion-content">
                      <dorel-safe-html html="[[ accordion.content ]]"></dorel-safe-html>
                    </div>
                  </template>
                </iron-collapse>
              </div>
            </template>
          </div>

        </div>
      </template>

    </section>
  </template>
  <script>
    Polymer({
      is: 'dorel-section-product-accordions',
      properties: {

        /**
         * @attribute
         * @name accordionsData
         * @description coming from the page-builder this data object is filled
         * with ACF/Wordpress data about the component
         */
        accordionsData: {
          type: Object,
          value: function () {
            return {};
          }
        }
      },

      _getIconState: function (selector) {

        return opened;
      },

      /**
       * @name _toggleCollapse
       * @description collapses the right accordion
       *
       */
      _toggleCollapse: function (e) {
        /* Toggle the class and aria attribute  */
        // Get the aria expanded attribute, and convert it to a boolean
        var ariaExpanded = e.target.getAttribute('aria-expanded') == "true";
        // Toggle the aria expanded boolean
        e.target.setAttribute('aria-expanded', !ariaExpanded);

        var selector = e.target.dataset.selector;

        // check state
        var state = (this.$$(selector).classList.contains('iron-collapse-opened'));

        // toggle collapse
        this.$$(selector).toggle();

        // event tracking
        this._eventTracking(e, e.target, state);
      },

      /**
       * @name _hasValue
       * @description checks to see if a value is set
       *
       * @returns Boolean
       */
      _hasValue: function (val) {
        return (typeof val !== 'undefined' || val !== '');
      },

      /**
       * @name _eventTracking
       * @description this is for cta tracking only
       * more info http://bit.ly/2nb6I7G
       */
      _eventTracking: function (event, selector, accordionState) {

        var globals = Polymer.globalsManager.get('Dorel');

        /**
         * Tracking on click for cta
         */
        Polymer.globalsManager.set('Dorel.events', {
          action: 'toggleAccordion',
          component: 'product-accordions',
          element: selector.innerHTML,
          event: 'polymer_event',
          things: {
            'currentState': (accordionState) ? 'open' : 'closed',
            'targetState': (accordionState) ? 'closed' : 'open'
          }
        });
      }
    });
  </script>
</dom-module>
