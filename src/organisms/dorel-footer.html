<link rel="import" href="../atoms/dorel-back-to-top.html">
<link rel="import" href="../atoms/dorel-iconset-simple.html">

<dom-module id="dorel-footer">
  <template>
    <style include="iron-flex iron-flex-alignment">
      footer {
        background-color: var(--theme-brand-color-2);
        padding: var(--theme-gutter);
        float: left;
        width: 100%;
        height: 100%;
        box-sizing: border-box;
      }

      footer[screen-small] {
        padding: var(--theme-gutter) var(--theme-gutter-mobile);
      }

      /**
       * copyright and footer-menu links
       */
      a, .footer-copyright, .footer-heading {
        @apply(--theme-typography-2);
        color: var(--theme-color-white);
        text-decoration: none;
        margin-top: 0;
      }

      .footer-disclaimer {
        margin-top: 1.5em;
      }

      /**
       * footer headings
       */
      .footer-heading {
        color: var(--theme-brand-color-1);
      }

      /**
       * Social media(wrapper)
       */
      .footer-media-links {
        padding: 1.5em;
      }

      .footer-media-link {
        text-align: center;
        padding: 3px 20px;
        font-size: 13px;
        white-space: nowrap;
      }

      .footer-media-link a span {
        line-height: 24px;
        margin-left: 8px;
      }

      /**
       * footer back to top
       */
      .footer-back-to-top {
        padding: 1.5rem 0 0 0;
        width: 100%;
      }

      .footer-menu ul {
        margin: .75em 0;
        padding: 0;
      }

      .footer-menu {
        @apply(--theme-grid-column);
        -ms-flex-preferred-size: calc(var(--theme-column-width) * 2);
        flex-basis: calc(var(--theme-column-width) * 2);
        max-width: calc(var(--theme-column-width) * 2);
      }

      [screen-medium] .footer-menu {
        -ms-flex-preferred-size: calc(var(--theme-column-width) * 3);
        flex-basis: calc(var(--theme-column-width) * 3);
        max-width: calc(var(--theme-column-width) * 3);
      }

      /* lists not enumerated */
      .footer-menu li {
        padding-left: 0;
        list-style-type: none;
      }

      .footer-menu a:hover, .footer-menu a:focus {
        color: var(--theme-color-white);
      }

      /* Layout */
      .footer-info {
        @apply(--theme-grid-row);
      }


      /* Mobile layout */
      [screen-small] .footer-menu {
        -ms-flex-preferred-size: 100%;
        flex-basis: 100%;
        max-width: 100%;
        max-height: 3em;
        overflow: hidden;
        border-bottom: 1px solid var(--theme-color-white);
        box-sizing: border-box;
        transition: max-height .3s ease-in-out;
        max-width: 100%;
        margin-top: 0;
        padding: 0;
      }

      [screen-small] .footer-info {
        margin-top: 1.5em;
        padding: 0 .75em;
      }

      [screen-small] .footer-menu.open {
        max-height: 1000px !important;
      }

      [screen-small] .footer-menu .footer-heading {
        color: var(--theme-color-white);
        height: 3em;
        line-height: 3em;
        margin: 0;
        position: relative;
        cursor: pointer;
      }

      [screen-small] ul {
        margin: 0 0 1.5em 0;
      }

      [screen-small] li {
        padding: .75em 0;
      }

      [screen-small] .menu-item a {
        font-weight: var(--theme-font-weight-light);
      }

      [screen-small] .footer-menu .footer-heading::before {
        content: '';
        position: absolute;
        bottom: 1rem;
        right: .75rem;
        width: .75rem;
        height: .75rem;
        border-bottom: 2px solid var(--theme-white);
        border-left: 2px solid var(--theme-white);
        transform: rotate(-45deg);
        transform-origin: center;
        transition: transform .3s ease;
      }

      [screen-small] .footer-menu.open .footer-heading::before {
        transform: rotate(135deg) translate(0.375rem, -0.375rem);
      }

    </style>

    <iron-media-query query="(max-width : 767px)"
                      query-matches="{{ screenSmall }}"></iron-media-query>
    <iron-media-query query="(min-width : 768px) and (max-width : 991px)"
                      query-matches="{{ screenMedium }}"></iron-media-query>
    <iron-media-query query="(min-width : 992px) and (max-width : 1199px)"
                      query-matches="{{ desktopLarge }}"></iron-media-query>

    <footer screen-small$="{{ screenSmall }}"
            screen-medium$="{{ screenMedium }}"
            desktop-large$="{{ screenLargeUp }}">

      <section id="footer-widget-area" class="footer-info">
        <!-- widget areas are inserted here -->
      </section>


      <div class="footer-disclaimer">
          <span class="footer-copyright">
            Copyright &#9400;
            {{ _getCopyrightYearRange(globals.Dorel.collect.options.footer_year) }}
            [[ globals.Dorel.collect.options.footer_copyright ]]
          </span>
      </div>

      <section class="footer-back-to-top">
        <dorel-back-to-top></dorel-back-to-top>
      </section>

    </footer>

  </template>

  <script>
    Polymer({
      is: 'dorel-footer',

      properties: {},

      /**
       * Check if one of theses globals are changed. These are needed to build
       * up the footer widgets and copyright
       */
      observers: [
        '_areasChanged(globals.Dorel.collect.widgetAreas.footer-widget-area)',
      ],

      /**
       * Listen to all clicks inside the component to define an
       * accordion click
       */
      listeners: {
        'click': 'accordionClick',
      },

      /**
       * @name socialClick
       * @description handle the click event on a social link
       */
      socialClick: function (event) {

        // event tracking when a social link is clicked
        this._eventTracking(event, 'social');
      },

      /**
       * @name accordionClick
       * @description handle the click event on the header tag for the
       * accordions (mobile only)
       *
       * @todo add click event listeners like with the footer-links,
       * use attributes to open/close
       */
      accordionClick: function (event) {

        // return when not clicked on the footer-heading
        if (typeof Polymer.dom(event).rootTarget.parentNode === 'undefined'
          || !Polymer.dom(event).rootTarget.parentNode.classList.contains('footer-menu')) return;

        // if a click on the footer-heading was done
        if (Polymer.dom(event).rootTarget.parentNode.classList.contains('open')) {
          Polymer.dom(event).rootTarget.parentNode.classList.remove('open');
        } else {
          Polymer.dom(event).rootTarget.parentNode.classList.add('open');
        }

        // track open/closing of accordion
        this._eventTracking(event, 'accordionToggle');
      },

      /**
       * @name _getCopyrightYearRange
       * @description returns the copyright range as a string based on a starting year and the current year
       */
      _getCopyrightYearRange: function (startYear) {

        // if no startYear is defined jump out
        if (typeof startYear === 'undefined' || startYear === '' || startYear === null) return;

        // set new array for yearRange
        var yearRange = [];

        // Convert the startYear to a number datatype
        startYear = Number(startYear);

        // Get the current year
        var endYear = new Date().getFullYear();

        // And add startyear to the range if it's an actual number, and smaller then the current year
        if (startYear < endYear) {
          yearRange.push(startYear, endYear);
        } else if (startYear === endYear) {
          yearRange.push(startYear);
        }

        // Return the range as a string
        return yearRange.join(' - ');
      },

      /**
       * @name _areasChanged
       * @description when the areas are set or changed place them
       * in there designated element
       */
      _areasChanged: function (data) {
        // if no data is given jump out
        if (typeof data === 'undefined' || typeof data.widgets === 'undefined') return;

        // set the element
        var self = this;

        if (data.widgets.length) {

          /**
           * iterate over every widget inside the footer-widget-area
           * and append it to the footer-widget-area div
           */
          for (var i = 0, len = data.widgets.length; i < len; i++) {
            var footerColumn = document.createElement("div");
            footerColumn.className = 'footer-menu';
            footerColumn.innerHTML = data.widgets[i].rendered;

            Polymer.dom(self.$['footer-widget-area']).appendChild(footerColumn);
          }
        }

        // alternative ready after whole footer has been build up
        this.__ready();
      },

      /**
       * @name __ready
       * @description because the footer widget areas are placed
       * at runtime the normal ready function doesn't have access
       * to all elements.
       */
      __ready: function () {
        var self = this;

        // define footer links for tracking
        var footerMenuLink = this.$$('#footer-widget-area').querySelectorAll('.footer-menu a');

        // hookup click handlers for every link
        for (var i = 0, len = footerMenuLink.length; i < len; i++) {
          // add eventListener for link
          footerMenuLink[i].addEventListener('click', function (event) {

            // start tracking when clicked
            self._eventTracking(event, 'switch');
          });
        }
      },

      /**
       * @name _eventTracking
       * @description sets the right properties for event tracking
       */
      _eventTracking: function (event, type) {

        /**
         * build up the tracking eventData
         */
        var eventData = {
          action: type,
          component: 'footer',
          event: 'polymer_event'
        };


        /**
         * Check the type and handle accordingly
         */
        switch (type) {

        /**
         * accordion was clicked (mobile)
         */
          case 'accordionToggle':

            // define the rootTarget
            var headingEl = Polymer.dom(event).rootTarget;

            // use rootTarget to get the accordion
            var accordionEl = headingEl.parentNode;

            // check if the accordion is open
            var accordionOpen = accordionEl.classList.contains('open');

            // define the action of the eventData
            eventData.action = (accordionOpen) ? 'open' : 'close';

            // define the event data element for accordions
            eventData.element = accordionEl;

            break;

        /**
         * footer menu link was clicked
         */
          case 'switch':

            // set event data element
            eventData.element = Polymer.dom(event).localTarget;

            // set event data things for switching page
            eventData.things = {
              'currentPage': document.URL,
              'targetPage': Polymer.dom(event).localTarget.href
            }

            break;

        /**
         * social link was clicked
         */
          case 'social':

            // set event data element
            eventData.element = Polymer.dom(event).localTarget.parentNode;

            break;
        }

        // set the tracking data, this will trigger dorel-gtm-events
        Polymer.globalsManager.set('Dorel.events', eventData);
      }
    });
  </script>
</dom-module>
