<link rel="import" href="../molecules/dorel-nav-tabs.html">

<dom-module id="dorel-section-service-faq-detail">
  <template>
    <style>
      h1, h2, h3, h4 {
        @apply(--theme-header-text-transform);
      }

      dorel-nav-tabs {
        margin: 0;
        float: left;
        width: 100%;
      }

      .content {
        margin-top: 1.5em;
        float: left;
        width: 100%;
      }

      p {
        margin: 0 0 1.5em 0;
      }
    </style>

    <app-location route="{{ route }}"></app-location>
    <iron-query-params
      params-string="{{ query }}"
      params-object="{{ queryParams }}"></iron-query-params>
    <app-route-converter
      path="{{ path }}"
      query-params="{{ queryParams }}"
      route="{{ route }}"></app-route-converter>
    <app-route route="{{ route }}"></app-route>

    <dorel-nav-tabs
      selected="{{ selectedSubTab }}"
      tabs="[[ faqDetail.sub_categories ]]"
      title="name"></dorel-nav-tabs>
    <div class="content">
      <template
        is="dom-repeat"
        items="[[ questions ]]"
        as="faq">
        <dorel-accordion-item
          auto-scroll="true"
          heading="[[ faq.question ]]"
          opened$="[[ faq.opened ]]"
          question-id$="[[ faq.id ]]"
          on-click="_addToQueryParams">
          <p>[[ faq.answer ]]</p>
        </dorel-accordion-item>
      </template>
    </div>
  </template>

  <script>
    Polymer({
      is: 'dorel-section-service-faq-detail',
      properties: {

        /**
         * @attribute
         * @name path
         * @description string generated by the component and used to generate queryParams
         * example: ?color=black
         */
        path: {
          type: String,
          notify: true
        },

        /**
         * @attribute
         * @name queryParams
         * @description object that contains the filter options
         */
        queryParams: {
          type: Object,
          notify: true
        },

        /**
         * @attribute
         * @name route
         * @description route object generated and used by the app-route & app-route location component
         */
        route: {
          type: Object,
          notify: true,
          // observer: '_resetQueryParams'
        },

        /**
         * @name selectedSubTab
         * @description the array number of the selected sub category in subCategories
         */
        selectedSubTab: {
          type: Number,
          value: null // needs to be null, otherwise change will not be detected
        },

        /**
         * @attribute
         * @name faqDetail
         * @description contains the object with the main category, sub category and questions
         */
        faqDetail: {
          type: Object
        }
      },

      observers: [
        '_initFaqState(faqDetail, queryParams)',
        '_selectedSubTabChanged(selectedSubTab)'
      ],

      /**
       * @observer
       * @name initFaqState
       * @description checks if the values needed are set
       */
      _initFaqState: function (faqDetail, queryParams) {

        // if no faqDetail is defined or no queryParams sub is given
        if (typeof faqDetail === 'undefined') return;

        var subCategories = faqDetail.sub_categories;
        var subCatId = this.get('queryParams.sub_category_id');
        var questionId = this.get('queryParams.question_id');

        // define the selectedSubTab, will trigger _selectedSubTabChanged
        this.set('selectedSubTab', this._getSelectedTab(subCategories, subCatId));

        var selectedSubTab = this.get('selectedSubTab');

        if (typeof selectedSubTab !== 'undefined') {
          // set the questions model that is used in the dom-repeat
          this._setQuestions(subCategories[selectedSubTab].items, questionId);
        }
      },

      /**
       * @name _getSelectedTab
       * @description takes the faqDetail and route to check if the queryParams subId is set
       * and match it with a sub category id to make that tab selected
       * @params subCategories - Array - array of objects containing all subCategories
       * @params subCatId - String - subCategoryId of the queryParams
       * @returns Number - array number of the tab that is selected
       */
      _getSelectedTab: function (subCategories, subCatId) {
        if (typeof subCategories === 'undefined') return;

        // go over each sub category and match the subCategoryID with the queryParams subID
        for (var i = 0; i < subCategories.length; i++) {
          if (subCategories[i].id === Number(subCatId)) {
            return i;
          }
        }

        return 0;
      },

      /**
       * @observer
       * @name _selectedSubTabChanged
       * @description when a user changes a tab the queryParams.sub_category_id should change to
       * while changing the subCategoryId also change the questionId and set the questions
       * @params selectedSubTab - Number - number of the array category
       */
      _selectedSubTabChanged: function (selectedSubTab) {
        if (typeof this.faqDetail === 'undefined' || selectedSubTab === null || typeof selectedSubTab === 'undefined') return;

        // get the currently selected subCategory
        var selectedSubCat = this.faqDetail.sub_categories[selectedSubTab];
        var queryParams = this.get('queryParams');

        // update the queryParams with the right tab id
        if (selectedSubCat.id !== Number(queryParams.sub_category_id)) {
          this._updateQueryParams(selectedSubCat.id, queryParams.question_id);
        }
      },

      /**
       * @name _setQuestions
       * @description sets the questions model that is used by the dom-repeat
       * @param subCatQuestions - Array of objects
       * @param questionId - String id of the queryParam
       */
      _setQuestions: function (subCatQuestions, questionId) {

        // set the opened property for each question of the subCategory
        subCatQuestions.forEach(function (question) {
          question.opened = (question.id === Number(questionId));
        });

        // set the questions model
        this.set('questions', JSON.parse(JSON.stringify(subCatQuestions)));

      },

      /**
       * @name _updateQueryParams
       * @description update the url queryParams accordingly
       * @param subCategoryId - String - the id of the subCategory
       * @param questionId - String - the id of the question
       */
      _updateQueryParams: function (subCategoryId, questionId) {

        // create empty object to set queryParams later
        var queryParams = {};
        var selectedSubTab = this.get('selectedSubTab');
        var questions = this.faqDetail.sub_categories[selectedSubTab].items;

        // find match in questions of the selected subCategory
        var hasQuestionMatch = questions.find(function (question) {
          return question.id === Number(questionId);
        });

        // if tabId is set
        if (typeof subCategoryId !== 'undefined' || subCategoryId !== '') {
          queryParams.sub_category_id = subCategoryId;
        }

        // if questionId is set and a match has been found, otherwise clear the queryParams
        if (typeof questionId !== 'undefined' && typeof hasQuestionMatch !== 'undefined') {
          queryParams.question_id = questionId;
        }

        // set the defined queryParams
        this.set('queryParams', queryParams);
      },

      /**
       * @onClick
       * @name _addToQueryParams
       * @description update the queryParams when an accordion is clicked
       */
      _addToQueryParams: function (e) {
        var questionId = e.currentTarget.getAttribute('question-id');

        if (typeof questionId === 'undefined') return;

        var selectedSubTab = this.get('selectedSubTab');
        var questions = this.faqDetail.sub_categories[selectedSubTab].items;

        if (questionId === this.get('queryParams.question_id')) {
          this._updateQueryParams(this.get('queryParams.sub_category_id'));
          this._setQuestions(questions);
        } else {
          this._updateQueryParams(this.get('queryParams.sub_category_id'), questionId);
          this._setQuestions(questions, questionId);
        }
      }
    });


  </script>

</dom-module>
