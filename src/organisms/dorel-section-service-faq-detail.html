<link rel="import" href="../molecules/dorel-nav-tabs.html">
<link rel="import" href="../atoms/dorel-accordion-item.html">

<dom-module id="dorel-section-service-faq-detail">
  <template>
    <style>
      :host {
        @apply(--max-width-host);
        --button-margin-spacing: 0;
      }

      section {
        @apply(--max-width-container);
        float: left;
        width: 100%;
        box-sizing: border-box;
        position: relative;
      }

      .row {
        @apply(--theme-grid-row);
        @apply(--theme-grid-row-mobile-margins);
        @apply(--layout-flex);
        justify-content: center;
      }

      dorel-nav-tabs {
        @apply(--theme-grid-column);
        -ms-flex-preferred-size: 100%;
        width: 100%;
        flex-basis: 100%;
        max-width: 100%;
      }

      .faq-questions {
        @apply(--theme-grid-column);
        -ms-flex-preferred-size: 100%;
        width: 100%;
        flex-basis: 100%;
        max-width: 100%;
      }

      p {
        margin: 0 0 1.5em 0;
      }

      [tablet-medium-up] .row {
        @apply(--theme-grid-row-margins);
      }

    </style>
    <dorel-media-query breakpoints="{{ breakpoints }}"></dorel-media-query>
  
    <app-location route="{{ route }}"></app-location>
    <iron-query-params
      params-string="{{ query }}"
      params-object="{{ queryParams }}"></iron-query-params>
    <app-route-converter
      path="{{path}}"
      query-params="{{queryParams}}"
      route="{{route}}"></app-route-converter>
    <app-route route="{{route}}"></app-route>

    <section class="layout horizontal center center-justified wrap"
             tablet-medium-up$="[[ breakpoints.tabletMediumUp ]]">
      <div class="row">
        <dorel-nav-tabs 
          selected="{{ selectedTab }}"
          tabs="[[ faqDetail.sub_categories ]]"></dorel-nav-tabs>
      </div>
      <div class="row">
        <template 
          is="dom-repeat" 
          items="[[ questions ]]"
          as="question">
          <dorel-accordion-item 
            heading="[[ question.title ]]" 
            opened$="[[ question.opened ]]"
            question-id$="[[ question.id ]]"
            on-click="_addToQueryParams">
            <p>[[ question.description ]]</p>
          </dorel-accordion-item>
        </template>
      </div>
    </section>
  </template>

  <script>
    Polymer({
      is: 'dorel-section-service-faq-detail',
      properties: {

        /**
         * @attribute
         * @name path
         * @description string generated by the component and used to generate queryParams
         * example: ?color=black
         */
        path: {
          type: String,
          notify: true
        },

        /**
         * @attribute
         * @name queryParams
         * @description object that contains the filter options
         */
        queryParams: {
          type: Object,
          notify: true
        },

        /**
         * @attribute
         * @name route
         * @description route object generated and used by the app-route & app-route location component
         */
        route: {
          type: Object,
          notify: true,
          // observer: '_resetQueryParams'
        },

        /**
         * @name selectedSubTab
         * @description the array number of the selected sub category in subCategories
         */
        selectedTab: {
          type: Number
        },

        /**
         * @attribute
         * @name faqDetail
         * @description contains the object with the main category, sub category and questions
         */
        faqDetail: {
          type: Object
        }
      },

      observers: [
        '_initFaqState(faqDetail, queryParams)',
        '_selectedTabChanged(selectedTab)'
      ],

      /**
       * @observer
       * @name initFaqState
       * @description checks if the values needed are set
       */
      _initFaqState: function(faqDetail, queryParams) {
        // if no faqDetail is defined or no queryParams sub is given
        if (typeof faqDetail === 'undefined' || typeof queryParams.sub === 'undefined') return;

        var subCategories = faqDetail.sub_categories;
        var subId = queryParams.sub;

        this._setSelectedTab(subCategories, subId);
      },

      /**
       * @name _setSelectedTab
       * @description takes the faqDetail and route to check if the queryParams subId is set
       * and match it with a sub category id to make that tab selected
       */
      _setSelectedTab: function(subCategories, subId) {

        // go over each sub category and match the subCategoryID with the queryParams subID
        for (var i = 0; i < subCategories.length; i++) {
          if (subCategories[i].id === Number(subId)) {
            this.set('selectedTab', i);
            return;
          }
        }

      },

      /**
       * @observer
       * @name _subTabChanged
       * @description when a user changes a tab the queryParams.sub should change to
       */
      _selectedTabChanged: function(selectedTab) {
        if (typeof this.faqDetail === 'undefined' || typeof selectedTab === 'undefined') return;

        // get the currently selected subCategory
        var selectedCat = this.faqDetail.sub_categories[selectedTab];

        // update the queryParams with the right tab id
        this._updateQueryParams(selectedCat.id, this.get('queryParams.id'));

        // set the questions model that is used in the dom-repeat
        this._setQuestions(selectedCat.questions, this.get('queryParams.id'));
      },

      /**
       * @name _setQuestions
       * @description sets the questions model that is used by the dom-repeat
       * @param questions - Array of objects
       * @param qId - String id of the queryParam
       */
      _setQuestions: function(questions, qId) {

        // set the opened property for each question of the subCategory
        questions.forEach(function(question) {
          question.opened = (question.id === Number(qId));
        });

        // set the questions model
        this.questions = JSON.parse(JSON.stringify(questions));

      },

      /**
       * @name _updateQueryParams
       * @description update the url queryParams accordingly
       */
      _updateQueryParams: function(tabId, qId) {

        // create empty object to set queryParams later
        var queryParams = {};
        var questions = this.faqDetail.sub_categories[this.selectedTab].questions;

        // find match in questions of the selected subCategory
        var hasMatch = questions.find(function(question) {
          return question.id === Number(qId);
        });

        // if tabId is set
        if (typeof tabId !== 'undefined' || tabId !== '') {
          queryParams.sub = tabId;
        }

        // if questionId is set and a match has been found, otherwise clear the queryParams
        if (typeof qId !== 'undefined' && typeof hasMatch !== 'undefined') {
          queryParams.id = qId;
        }

        // set the defined queryParams
        this.set('queryParams', queryParams);
      },

      /**
       * @name _addToQueryParams
       * @description update the queryParams when an accordion is clicked
       */
      _addToQueryParams: function(e) {
        var qId = e.target.getAttribute('question-id');
        if (typeof qId === 'undefined') return;

        var questions = this.faqDetail.sub_categories[this.selectedTab].questions;

        if (qId === this.get('queryParams.id')) {
          this._updateQueryParams(this.get('queryParams.sub'));
          this._setQuestions(questions);
        } else {
          this._updateQueryParams(this.get('queryParams.sub'), qId);
          this._setQuestions(questions, qId);
        }
      }
    });


  </script>

</dom-module>
