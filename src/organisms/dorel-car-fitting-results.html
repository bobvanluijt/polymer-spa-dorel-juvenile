<link rel="import" href="../atoms/dorel-cta.html">
<link rel="import" href="../atoms/dorel-bynder-image.html">
<script src="../../node_modules/snapsvg/dist/snap.svg.js"></script>

<dom-module id="dorel-car-fitting-results">
  <template>
    <style>
      [hidden] {
        display: none;
      }
      .inner-col-left-top {
        min-height: 27rem;
      }
      .notification-box {
        background-color: var(--theme-color-monochrome-1);
        border-radius: var(--theme-button-border-radius);
        padding: 1.8rem;
        margin-top: 1.5rem;
      }
      .image {
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        width: 50%;
        display: flex;
        flex: 1;
        z-index: -1000;
      }
      .car-selection, .car-display {
        width: auto;
        height: auto;
        /*background-color: var(--theme-color-monochrome-2);*/
        border-radius: var(--theme-button-border-radius);
        cursor: pointer;
      }
      .car-display {
        background-color: var(--theme-color-monochrome-2);
      }
      .display-container {
        display: flex;
        margin-top: 1.4rem;
      }
      .edit-card {
        padding: 1rem 0.75rem 1rem 0.75rem;
        width: 210px;
      }
      .edit-card h3 {
        margin: 0;
      }
      .edit-icon, .delete-icon {
        padding: 2.1em 1.2rem 2.1rem 1.2rem;
        --iron-icon-height: 30px;
        --iron-icon-width: 30px;
      }
      .edit-icon {
        border-right: 4px solid white;
      }
      .notification-icon {
        --iron-icon-height: 38px;
        --iron-icon-width: 38px;
        color: var(--theme-brand-color-1);
      }
      .step-title {
        font-size: var(--theme-typography-5_-_font-size);
        line-height: var(--theme-typography-5_-_line-height);
        margin-top: var(--theme-typography-5_-_margin-top);
        margin-bottom: var(--theme-typography-5_-_margin-bottom);
        font-weight: var(--theme-typography-5_-_font-weight);
        font-family: var(--theme-typography-5_-_font-family);
      }
      .product-title {
        font-size: var(--theme-typography-5_-_font-size);
        line-height: var(--theme-typography-5_-_line-height);
        margin-top: var(--theme-typography-5_-_margin-top);
        margin-bottom: var(--theme-typography-5_-_margin-bottom);
        font-weight: var(--theme-typography-5_-_font-weight);
        font-family: var(--theme-typography-5_-_font-family);
      }
      .box {
        background-color: #fff;
        border-radius: var(--theme-button-border-radius);
        padding: 2em 1.5em;
      }
      .content-title {
        @apply(--theme-typography-4);
        margin: 0;
      }
      .svg_container {
        width: 100%;
        height: 350px;
      }
      .svg_node {
        width: 100%;
        height: 100%;        
      }
      .cta-wrapper {
        display: flex;
        width: 100%;
        justify-content: flex-end;
      }
      .background-complementary {
        background-color: var(--theme-color-monochrome-2);
        position: absolute;
        top: 0;
        bottom: 0;
        right: 0;
        width: 50%;
        z-index: -1000;
      }
      .post {
        height: 220px;
        width: 370px;
        margin: 20px auto;
        display: flex;
        align-content: center;
        justify-content: flex-start;
      }
      .imgwrap {
        text-align: left;
      }
      .imgwrapicon {
        text-align: left;
        width: 50px;
      }
      .photo {
        width: 125px;
        height: 125px;
        margin: 10px 10px 10px 20px;
      }
      .icon {
        width: 24px;
        height: 24px;
        margin: 10px 10px 0px 20px;
      }
      .info {
        margin: 25px 10px 10px 20px;
      }
      .timeAgo {
        font-size: 11px;
      }
      
      .content p {
        margin: 0;
        padding: 0;
      }
      
      .notification {
        position: absolute;
        width: 270px;
        height: auto;
        border-radius: 10px;
        /*padding: 25px;*/
        top: 0;
        left: 0;
        z-index: 10000;
        display: none;
        @apply(--theme-typography-1);
        /*background-color: white;*/
      	/*-webkit-box-shadow: 10px 10px 10px 10px var(--theme-color-monochrome-3);*/
      	/*-moz-box-shadow: 10px 10px 10px 10px var(--theme-color-monochrome-3);*/
      	/*box-shadow: 10px 10px 10px 10px var(--theme-color-monochrome-3);*/
      }
      .notification-title {
        @apply(--theme-typography-3);
      }
      .effect7
      {
        background:#FFF;
        padding: 25px;
        position:relative;
        -webkit-box-shadow:0 1px 4px rgba(0, 0, 0, 0.3), 0 0 40px rgba(0, 0, 0, 0.1) inset;
           -moz-box-shadow:0 1px 4px rgba(0, 0, 0, 0.3), 0 0 40px rgba(0, 0, 0, 0.1) inset;
                box-shadow:0 1px 4px rgba(0, 0, 0, 0.3), 0 0 40px rgba(0, 0, 0, 0.1) inset;
      }
      .effect7:before, .effect7:after
      {
        content:"";
        position:absolute;
        z-index:-1;
        -webkit-box-shadow:0 0 20px rgba(0,0,0,0.8);
        -moz-box-shadow:0 0 20px rgba(0,0,0,0.8);
        box-shadow:0 0 20px rgba(0,0,0,0.8);
        top:0;
        bottom:0;
        left:10px;
        right:10px;
        -moz-border-radius:100px / 10px;
        border-radius:100px / 10pxpx;
      }
      .effect7:after
      {
        right:10px;
        left:auto;
        -webkit-transform:skew(8deg) rotate(3deg);
           -moz-transform:skew(8deg) rotate(3deg);
            -ms-transform:skew(8deg) rotate(3deg);
             -o-transform:skew(8deg) rotate(3deg);
                transform:skew(8deg) rotate(3deg);
      }
    </style>
    <dorel-media-query breakpoints="{{ breakpoints }}"></dorel-media-query>
    <dorel-layout-container>
      <dorel-layout-row align="left">
        <dorel-layout-column desktop-column-span="12" tablet-column-span="5" mobile-column-span="4" align="left">
            <dorel-cta title="[[ stepData.options.previous ]]" rotate no-margin type="link" link="" size="medium" icon="dorel-icons:chevron-right" on-click="previousStep">
              Back
            </dorel-cta>
        </dorel-layout-column>
      </dorel-layout-row>
      <dorel-layout-row align="middle">
        <dorel-layout-column desktop-column-span="5" tablet-column-span="5" mobile-column-span="4" align="left">
            <dorel-layout-row>
                <dorel-layout-column desktop-column-span="9" tablet-column-span="9" mobile-column-span="8" class="inner-col-left-top">
                  <h1 class="step-title">Car fitting</h1>
                  <template id="carResults" is="dom-repeat" items="[[ carData ]]" as="car" index-as="carIndex" restamp="true">
                    <strong>Car: [[ car.result.car_information_label ]]</strong>
                    <br>
                    <br>                  
                    <!--<object id="fit" data="/assets/images/car-fitting/icon1.svg" type="image/svg+xml"></object>
                    <strong>Fit</strong>-->
                    <br> 
                    <small>[[stepData.main_section.info]]</small>
                    <br>
                    <br>
                    [[ loadImage(car.result, carIndex) ]]
                    <div id="svg_container_[[carIndex]]" class="svg_container"></div>
                  </template>
                </dorel-layout-column>
            </dorel-layout-row>
        </dorel-layout-column>
        <dorel-layout-column desktop-column-span="5" tablet-column-span="5" mobile-column-span="4" align="left" class="col-right-top">
          <dorel-layout-row>
            <dorel-layout-column desktop-column-span="9" tablet-column-span="9" mobile-column-span="8" class="inner-col-left-top">
              <div class="notification-box">
                    <div class="imgwrap">
                      <h2 class="content-title">[[ stepData.selected_product.title ]]</h2>
                      <iron-image src="[[ productImage ]]"
                        class="photo card-image__background"
                        position="center" sizing="contain">
                      </iron-image>
                      <div class="timeAgo">Explore other suitable solutions</div>
                    </div>
                    <div class="info">
                      <h2 class="title">[[ productData.sku ]]</h2>
                    </div>
              </div>
            </dorel-layout-column>
          </dorel-layout-row>
        </dorel-layout-column>
      </dorel-layout-row>
      <template is="dom-if" if="[[ breakpoints.tabletMediumUp ]]" restamp="true">
        <template is="dom-if" if="[[ hasBynderImage(stepData.sub_section.background_image_id) ]]">
          <dorel-bynder-image class="image"
                      derivative-identifier="Fullscreen Retina portrait"
                      sizing="cover"
                      width="100%"
                      height="100%"
                      flex
                      fade="true"
                      media-id$="[[ stepData.sub_section.background_image_id ]]"></dorel-bynder-image>
        </template>
      </template>
      <template is="dom-if" if="[[ breakpoints.tabletMediumUp ]]" restamp="true">
        <div class="background-complementary"></div>
      </template>
    </dorel-layout-container>
    <template is="dom-repeat" items="[[ carData ]]" as="car" index-as="carIndex" restamp="true">
      <template is="dom-repeat" items="[[ car.result.carseat_positions ]]" as="seat" restamp="true">
        <div id="car_[[ carIndex ]]_seat_[[ seat.seat_position ]]_notification" class="notification">
          <div class="effect7">
            <object data="/assets/images/car-fitting/icon_orange.svg" type="image/svg+xml"></object>
            <strong class="notification-title">Safety warning</strong>
            <ul>
              <template is="dom-repeat" items="[[ seat.notices ]]" as="notification" restamp="true">
                <li>[[ localize(notification) ]]</li>
              </template>
            </ul>
          </div>
        </div>
      </template>
    </template>    
  </template>
  <script>
    /* global Polymer */
    /* global Snap */
    /* global CustomEvent */
    /* global customElements */
    class DorelCarFittingResults extends Polymer.mixinBehaviors([DorelMultilingualBehavior], Polymer.Element) {

      static get is() {
        return 'dorel-car-fitting-results';
      }
      
      static get properties() {
        return {
          productImage: {
            type: String,
            computed: 'getProductImage(productData)'
          }
        };
      }

      ready() {
        super.ready();
        this.clientX = null;
        this.clientY = null;
      }

      static get observers() {
        return [
            'test(carData.*)'
        ];
      }

      getProductImage() {
        if(this.productData && this.productData.child_products) return this.productData.child_products[0].images.image;
      }

      /**
      * @name nextStep
      * @description fires a event to the parent to route to the next step if the target is not disabled
      * @param event - Object
      */
      nextStep(event) {
        var disabled = event.currentTarget.attributes.disabled ? true : false;
        if(disabled) {
          return;
        }
        this.fire('next-step');
      }

      /**
      * @name previousStep
      * @description fires a event to the parent to route to the previous step if the target is not disabled
      * @param event - Object
      */
      previousStep(event) {
        var disabled = event.currentTarget.attributes.disabled ? true : false;
        if(disabled) {
          return;
        }
        //this.fire('previous-step');
        this.dispatchEvent(new CustomEvent('previous-step', {bubbles: true, composed: true}));
      }

      /**
      * @name shouldShow
      * @description used by the template to determine if it should show
      */
      shouldShow(boolean) {
        return Boolean(boolean === true);
      }

      loadImage(data, carIndex) {
        if(data) {
          let self = this;
          let svgCarNode = null;
          function onSVGLoaded(loadedFragment) {
            svgCarNode.append(loadedFragment);
            svgCarNode.attr({
              opacity: 0
            });
            const seats = ['1', '2', '3', '4', '5', '6', '7'];
            for(var seat in seats) {
              const seatNode = svgCarNode.select(`#seat_${seats[seat]}`);
              if(seatNode) {
                svgCarNode.select(`#seat_${seats[seat]} #icon_green`).attr({'visibility': 'hidden'});
                svgCarNode.select(`#seat_${seats[seat]} #icon_red`).attr({'visibility': 'hidden'});
                svgCarNode.select(`#seat_${seats[seat]} #icon_orange`).attr({'visibility': 'hidden'});
                svgCarNode.select(`#seat_${seats[seat]} #icon_blue`).attr({'visibility': 'hidden'});
                svgCarNode.select(`#seat_${seats[seat]} #icon_blue_2`).attr({'visibility': 'hidden'});
                svgCarNode.select(`#seat_${seats[seat]} #icon_tether`).attr({'visibility': 'hidden'});
              }
            }
            data.carseat_positions.forEach(function(item) {
              if(item.icon === 'green') {
                svgCarNode.select(`#seat_${item.seat_position} #icon_green`).attr({'visibility': 'visible'});
              }
              if(item.icon === 'red') {
                svgCarNode.select(`#seat_${item.seat_position} #icon_red`).attr({'visibility': 'visible'});
              }
              if(item.icon === 'orange') {
                svgCarNode.select(`#seat_${item.seat_position} #icon_orange`).attr({'visibility': 'visible'});
                const orangeIcon = svgCarNode.select(`#seat_${item.seat_position} #icon_orange`);
                const carBody = svgCarNode.select(`#car_body`);
                const notice = self.shadowRoot.querySelector(`#car_${carIndex}_seat_${item.seat_position}_notification`);
                let placed = false;
                orangeIcon.mouseover(function(event) {
                  if(!placed) {
                    notice.style.left = (event.clientX + 5) + 'px';
                    notice.style.top = event.clientY + 'px';
                    notice.style.display = 'block';
                    placed = true;
                  }
                });
                carBody.mouseover(function(event) {
                  if(placed) {
                    notice.style.display = 'none';
                    placed = false;
                  }
                });
              }
              if(item.icon === 'tether') {
                svgCarNode.select(`#seat_${item.seat_position} #icon_tether`).attr({'visibility': 'visible'});
              }
            });
            svgCarNode.attr({
              opacity: 100
            });
          }
            
          setTimeout(() => {
            const svgOldCarNode = this.shadowRoot.querySelector(`#car_${carIndex}`);
            if(svgOldCarNode) svgOldCarNode.remove();
            const container = this.shadowRoot.querySelector(`#svg_container_${carIndex}`);
            container.innerHTML = `<svg id="car_${carIndex}" message="Hi this is a tooltip." class="tooltip great svg_node"></svg>`;
            svgCarNode = Snap(this.shadowRoot.querySelector(`#car_${carIndex}`));
            Snap.load(`/assets/images/car-fitting/${data.car_body_configuration}.svg`, onSVGLoaded);
          }, 0);
        }
      }

      previousStep() {
        this.set('stepData.isCurrent', false);
        this.set('stepController.currentStep', this.stepData.previousStep);          
      }
      
      test() {
        this.$.carResults.render();
      }
    }
    
    customElements.define(DorelCarFittingResults.is, DorelCarFittingResults);
  </script>  
</dom-module>
