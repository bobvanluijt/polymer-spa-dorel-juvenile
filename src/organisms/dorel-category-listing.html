<link rel="import" href="../molecules/dorel-category-listing-item.html">

<dom-module id="dorel-category-listing">
  <template>
    <style include="iron-flex iron-flex-alignment">
      :host {
        @apply(--max-width-container);
        width: 100%;
        margin: auto;
        float: none;
        display: block;
      }

      .category-listing {
        margin-left: 0;
        box-sizing: border-box;
      }

      .row {
        @apply(--theme-grid-row);
        @apply(--layout-flex);
        @apply(--theme-grid-row-margins);
        position: relative;
      }

      dorel-loader {
        padding-top: 12em;
        float: left;
      }

      dorel-category-listing-item {
        @apply(--theme-grid-column);
        margin-top: 0;
        -ms-flex-preferred-size: 100%;
        flex-basis: 100%;
        max-width: 100%;
      }

      dorel-cta {
        width: auto;
        margin: auto;
      }

      /* Responsive behaviour */
      [tablet-medium-up] dorel-category-listing-item, [tablet-small] dorel-category-listing-item {
        -ms-flex-preferred-size: calc(var(--theme-column-width) * 6);
        flex-basis: calc(var(--theme-column-width) * 6);
        max-width: calc(var(--theme-column-width) * 6);
      }

      [desktop-small-up] dorel-category-listing-item {
        -ms-flex-preferred-size: calc(var(--theme-column-width) * 4);
        flex-basis: calc(var(--theme-column-width) * 4);
        max-width: calc(var(--theme-column-width) * 4);
      }

      [tablet-medium-up] .row {
        @apply(--theme-grid-row-margins);
      }

    </style>

    <dorel-media-query breakpoints="{{ breakpoints }}"></dorel-media-query>

    <div tablet-small$="{{ breakpoints.tabletSmall }}"
         tablet-medium-up$="{{ breakpoints.tabletMediumUp }}"
         desktop-small-up$="{{ breakpoints.desktopSmallUp }}">

      <section class="category-listing layout horizontal center center-justified wrap">
        <div class="row narrow-row">
          <template
            is="dom-repeat"
            items="[[ products ]]"
            as="product">
            <dorel-category-listing-item
              colors-data="[[ product.childProducts ]]"
              link-url="[[ product.url ]]"
              product-name="[[ product.name ]]"
              gtm-parent="[[ gtmParent ]]"
              gtm-parent-index="[[ gtmParentIndex ]]"
              gtm-child="dorel-category-listing-item"
              gtm-child-index="[[ index ]]"></dorel-category-listing-item>
          </template>
          <dorel-loader loading="[[ retrievingProducts ]]"></dorel-loader>
        </div>
      </section>
    </div>
  </template>
  <script>
    Polymer({
      is: 'dorel-category-listing',

      properties: {
        /**
         * @attribute
         * @name productsData
         * @description the data coming from magento which is delegated
         */
        productsData: {
          type: Array,
          value: []
        },

        sort: {
          type: Object
        },

        retrievingProducts: {
          type: Boolean,
          value: false
        },

        products: {
          type: Array,
          notify: true,
          value: function() { return []; }
        }
      },

      observers: [
        '_setProducts(productsData, retrievingProducts)'
      ],

      _setProducts: function(productsData, retrievingProducts) {

        if(!productsData.length || retrievingProducts) {
          this.products = [];
          return;
        }
        var products = this._sortProducts(productsData);
        this.products = [];
        var self = this;
        products.forEach(function(item) {
          self.push('products', item);
        });
      },

      _sortProducts: function (items) {
        if(this.retrievingProducts) {
          return [];
        }
        if (!items.length) {
          return [];
        }
        var type = this.sort.type;
        if (type && type !== 'none') {
          return this._sortString(items, this.sort);
        }
        return items;
      },


      _sortString: function (items, sort) {
        return items.sort(function (a, b) {
          if (!(typeof a[sort.type] === 'string' && typeof b[sort.type] === 'string')
            && !(typeof a[sort.type] === 'number' && typeof b[sort.type] === 'number')) {
            return 0;
          }

          var a = typeof a[sort.type] === 'string' ? a[sort.type].toUpperCase() : a[sort.type];
          var b = typeof b[sort.type] === 'string' ? b[sort.type].toUpperCase() : b[sort.type];
          if (a < b) {
            return sort.order === 'asc' ? -1 : 1;
          }
          if (a > b) {
            return sort.order === 'asc' ? 1 : -1;
          }
          // names must be equal
          return 0;
        });
      }
    });
  </script>

</dom-module>
