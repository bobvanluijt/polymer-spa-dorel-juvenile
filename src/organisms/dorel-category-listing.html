<link rel="import" href="../molecules/dorel-category-listing-item.html">
<link rel="import" href="../utils/dorel-category-filter-manager.html">

<dom-module id="dorel-category-listing">
  <template>
    <style include="iron-flex iron-flex-alignment">
      :host {
        @apply(--max-width-container);
        width: 100%;
        margin: auto;
        float: none;
        display: block;
      }

      .category-listing {
        margin-left: 0;
        box-sizing: border-box;
      }

      .row {
        @apply(--theme-grid-row);
        @apply(--layout-flex);
        @apply(--theme-grid-row-margins);
        position: relative;
      }

      dorel-loader {
        padding-top: 12em;
        float: left;
      }

      dorel-category-listing-item {
        @apply(--theme-grid-column);
        margin-top: 0;
        -ms-flex-preferred-size: 100%;
        flex-basis: 100%;
        max-width: 100%;
      }

      dorel-cta {
        width: auto;
        margin: auto;
      }

      /* Responsive behaviour */
      [tablet-medium-up] dorel-category-listing-item, [tablet-small] dorel-category-listing-item {
        -ms-flex-preferred-size: calc(var(--theme-column-width) * 6);
        flex-basis: calc(var(--theme-column-width) * 6);
        max-width: calc(var(--theme-column-width) * 6);
      }

      [desktop-small-up] dorel-category-listing-item {
        -ms-flex-preferred-size: calc(var(--theme-column-width) * 4);
        flex-basis: calc(var(--theme-column-width) * 4);
        max-width: calc(var(--theme-column-width) * 4);
      }

      [tablet-medium-up] .row {
        @apply(--theme-grid-row-margins);
      }

      .no-products {
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-top: 1.5em;
        background-color: #f9f9f9;
      }

    </style>

    <dorel-media-query breakpoints="{{ breakpoints }}"></dorel-media-query>

    <div tablet-small$="{{ breakpoints.tabletSmall }}"
         tablet-medium-up$="{{ breakpoints.tabletMediumUp }}"
         desktop-small-up$="{{ breakpoints.desktopSmallUp }}">

      <dorel-category-filter-manager
        id="categoryManager"
        filters="{{ filters }}">
      </dorel-category-filter-manager>

      <section class="category-listing layout horizontal center center-justified wrap">

        <div class="row narrow-row">
          <template
            is="dom-repeat"
            items="[[ products ]]"
            as="product"
            filter="[[ _filterProducts(filters.*) ]]"
            observe="childProducts"
            id="test"
            rendered-item-count="{{ renderedCount }}">
            <dorel-category-listing-item
              colors-data="[[ product.child_products ]]"
              link-url="[[ product.url ]]"
              filters="[[ filters ]]"
              product-name="[[ product.name.value ]]"
              gtm-parent="[[ gtmParent ]]"
              gtm-parent-index="[[ gtmParentIndex ]]"
              gtm-child="dorel-category-listing-item"
              gtm-child-index="[[ index ]]"></dorel-category-listing-item>
          </template>
          <dorel-loader loading="[[ retrievingProducts ]]"></dorel-loader>
          <template is="dom-if" if="{{ checkIfProductsAreEmpty(renderedCount, retrievingProducts) }}">
            <div class="no-products">
              0 Results
            </div>
          </template>
        </div>
      </section>
    </div>
  </template>
  <script>
    Polymer({
      is: 'dorel-category-listing',

      properties: {
        /**
         * @attribute
         * @name productsData
         * @description the data coming from magento which is delegated by the parent
         */
        productsData: {
          type: Array,
          value: []
        },

        /**
         * @attribute
         * @name sort
         * @description Object that is passed by the parent
         * contains: type, order. These will be used to sort the products
         */
        sort: {
          type: Object
        },

        /**
         * @attribute
         * @name retrievingProducts
         * @description Boolean that is passed by the parent
         * will be used by observer, and by dorel-loader component
         */
        retrievingProducts: {
          type: Boolean,
          value: false
        },

        /**
         * @attribute
         * @name products
         * @description Array of the sorted products that will be used by the parent
         */
        products: {
          type: Array,
          notify: true,
          value: function() { return []; }
        },

        filters: {
          type: Array
        },

        renderedCount: {
          type: Number,
          notify: true
        }
      },

      observers: [
        '_setProducts(productsData, retrievingProducts)'
      ],

      /**
       * observer
       * @name _setProducts
       * @description Will set the products that are used by the template
       * if productsData does not contain products or retrievingProducts is true set this.products as a empty array
       * else call _sortProducts and set this.products by pushing products
       * @param productsData - Array
       * @param retrievingProducts - Boolean
       */
      _setProducts: function(productsData, retrievingProducts) {
        if(!productsData.length || retrievingProducts) {
          this.set('products', []);
          return;
        }
        var products = this._sortProducts(productsData);
        this.set('products', []);
        var self = this;
        products.forEach(function(item) {
          self.push('products', item);
        });
      },

      /**
       * @name _sortProducts
       * @description Will sort the items
       * @param items - Array
       * @returns items - Array
       */
      _sortProducts: function (items) {
        if(this.retrievingProducts) {
          return [];
        }
        if (!items.length) {
          return [];
        }
        var type = this.sort.type;
        if (type && type !== 'none') {
          return this._sortString(items, this.sort);
        }
        return items;
      },

      /**
       * @name _sortString
       * @description Will sort the items if value is String/Number
       * @param items - Array
       * @param sort - Object
       * sort will contain type and order
       * type will select the property to sort on. For example: "name"
       * order will determine if it is ordered ascending descending
       */
      _sortString: function (items, sort) {
        return items.sort(function (a, b) {
          if (!(typeof a[sort.type] === 'string' && typeof b[sort.type] === 'string')
            && !(typeof a[sort.type] === 'number' && typeof b[sort.type] === 'number')) {
            return 0;
          }

          var a = typeof a[sort.type] === 'string' ? a[sort.type].toUpperCase() : a[sort.type];
          var b = typeof b[sort.type] === 'string' ? b[sort.type].toUpperCase() : b[sort.type];
          if (a < b) {
            return sort.order === 'asc' ? -1 : 1;
          }
          if (a > b) {
            return sort.order === 'asc' ? 1 : -1;
          }
          // names must be equal
          return 0;
        });
      },

      /**
       * @name _filterProducts
       * @description A function that is used by the dom-repeat in the template
       * @param filters - Array
       * @returns Boolean if true show the product
       */
      _filterProducts: function(filters) {
        var self = this;
        return function(product) {
          // if no filters are applied return true
          if(!filters || !filters.base || !filters.base.length) {
            return true;
          }
          // if there is no product return false
          if (!product) {
            return false;
          }
          // returns a Boolean - if true it will show the product
          return self.$.categoryManager.shouldShowProduct(product, filters);
        };
      },

      checkIfProductsAreEmpty: function(renderedCount, retrievingProducts) {
        return Boolean(renderedCount !== 'undefined' && renderedCount === 0 && retrievingProducts === false);
      }

    });
  </script>

</dom-module>
