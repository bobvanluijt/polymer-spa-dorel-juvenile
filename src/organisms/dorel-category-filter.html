<link rel="import" href="../../bower_components/app-route/app-route.html">
<link rel="import" href="../../bower_components/app-route/app-location.html">
<link rel="import" href="../../bower_components/iron-location/iron-location.html">
<link rel="import" href="../../bower_components/app-route/app-route-converter.html">
<link rel="import" href="../../bower_components/iron-location/iron-query-params.html">

<link rel="import" href="../utils/dorel-category-filter-data-collector.html">

<link rel="import" href="../molecules/dorel-category-filter-price.html">
<link rel="import" href="../molecules/dorel-category-filter-colors.html">


<dom-module id="dorel-category-filter">
  <template>
    <style include="iron-flex iron-flex-alignment">
      :host {
        @apply(--max-width-container);
        display: flex;
        width: calc(100% - 2em);
        margin-left: 2em;
        flex-direction: column;
      }
    </style>
    <!-- <iron-location path="{{path}}" query="{{query}}"></iron-location> -->
    <app-location route="{{ route }}"></app-location>
    <iron-query-params
        params-string="{{query}}"
        params-object="{{queryParams}}">
    </iron-query-params>
    <app-route-converter
        path="{{path}}"
        query-params="{{queryParams}}"
        route="{{route}}">
    </app-route-converter>
    <app-route route="{{route}}" pattern="/:page" data="{{data}}">
    </app-route>

    <dorel-category-filter-data-collector
      product-data="[[ productData ]]"
      filter-data="{{ filterData }}">
    </dorel-category-filter-data-collector>


    <dorel-category-filter-price
      query-params="[[ queryParams ]]"
      filter-data="[[ filterData.priceFilter ]]"
      on-update-filter="_setFilters">
    </dorel-category-filter-price>

    <dorel-category-filter-colors
      query-params="[[ queryParams ]]"
      on-update-filter="_setFilters">
    </dorel-category-filter-colors>
  </template>
  <script>
    Polymer({
      is: 'dorel-category-filter',
      properties: {

        path: {
          type: String,
          notify: true
        },

        queryParams: {
          type: Object,
          notify: true
        },

        route: {
          type: Object,
          notify: true
        },

        productData: {
          type: Array
        },

        filterData: {
          type: Object
        }

      },

      listeners: {
        'update-filter': '_setFilters'
      },

      _setFilters: function(event) {
        var params = event.detail.value;
        var filterUrl = this._encodeParams(params)
          .replace(/%3F/g, '?').replace(/%2F/g, '/').replace(/'/g, '%27');
        if(this.route) {
          this.set('path',  this.route.path);
        }
        this.set('query', filterUrl);
      },

      _encodeParams: function(params) {
        var encodedParams = [];
        for (var key in params) {
          var value = params[key];
          if (value === '') {
            encodedParams.push(encodeURI(key));
          } else if (value) {
            encodedParams.push(
                encodeURI(key) +
                '=' +
                encodeURI(value.toString())
            );
          }
        }
        return encodedParams.join('&');
      }

    });
  </script>

</dom-module>
