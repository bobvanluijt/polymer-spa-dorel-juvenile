<link rel="import" href="../../bower_components/app-route/app-route.html">
<link rel="import" href="../../bower_components/app-route/app-location.html">
<link rel="import" href="../../bower_components/iron-location/iron-location.html">
<link rel="import" href="../../bower_components/app-route/app-route-converter.html">
<link rel="import" href="../../bower_components/iron-location/iron-query-params.html">

<link rel="import" href="../utils/dorel-category-filter-data-collector.html">

<link rel="import" href="../molecules/dorel-category-filter-slider.html">
<link rel="import" href="../molecules/dorel-category-filter-checkbox.html">


<dom-module id="dorel-category-filter">
  <template>
    <style include="iron-flex iron-flex-alignment">
      :host {
        @apply(--max-width-container);
        display: block;
        width: 100%;
        padding: 0 .75rem;
        box-sizing: border-box;
      }
    </style>
    <app-location route="{{ route }}"></app-location>
    <iron-query-params
        params-string="{{query}}"
        params-object="{{queryParams}}">
    </iron-query-params>
    <app-route-converter
        path="{{path}}"
        query-params="{{queryParams}}"
        route="{{route}}">
    </app-route-converter>
    <app-route route="{{route}}"></app-route>

    <dorel-category-filter-data-collector
      product-data="[[ productData ]]"
      filter-data="{{ filterData }}">
    </dorel-category-filter-data-collector>


      <template
        is="dom-repeat"
        items="[[ filterData ]]"
        as="filter">

      <template is="dom-if" if="[[ checkComponent(filter, 'checkbox', retrievingProducts) ]]">
        <dorel-category-filter-checkbox
          query-params="[[ queryParams ]]"
          filter-data="[[ filter ]]"
          on-update-filter="_setFilters">
        </dorel-category-filter-checkbox>
      </template>
      <template is="dom-if" if="[[ checkComponent(filter, 'slider', retrievingProducts) ]]">
        <dorel-category-filter-slider
          query-params="[[ queryParams ]]"
          filter-data="[[ filter ]]"
          on-update-filter="_setFilters">
        </dorel-category-filter-slider>
      </template>

    </template>


  </template>
  <script>
    Polymer({
      is: 'dorel-category-filter',
      properties: {

        /**
         * @attribute
         * @name path
         * @description string generated by the component and used to generate queryParams
         * example: ?color=black
         */
        path: {
          type: String,
          notify: true
        },

        /**
         * @attribute
         * @name queryParams
         * @description object that contains the filter options
         * example: { color: 'black' }
         */
        queryParams: {
          type: Object,
          notify: true
        },

        /**
         * @attribute
         * @name route
         * @description route object generated and used by the app-route & app-route location component
         */
        route: {
          type: Object,
          notify: true,
          observer: '_resetQueryParams'
        },

        /**
         * @attribute
         * @name productData
         * @description Array of products that will be converted to filterData in the `dorel-category-filter-data-collector`
         */
        productData: {
          type: Array
        },

        /**
         * @attribute
         * @name filterData
         * @description Array of filters that is generated by the `dorel-category-filter-data-collector`
         */
        filterData: {
          type: Array
        },

        /**
         * @attribute
         * @name retrievingProducts
         * @description Indictation that the products are being retrieved
         */
        retrievingProducts : {
          type: Boolean,
          value: true
        }

      },

      listeners: {
        'update-filter': '_setFilters'
      },

      _resetQueryParams: function(oldValue, newValue) {
        if(!oldValue || !oldValue.path || !newValue || !newValue.path) {
          return;
        }
        if(oldValue.path !== newValue.path) {
          this.set('query', '')
        }
      },

      /**
       * listener
       * @name _setFilters
       * @description Everytime a filter component dispatches the 'update-filter' event,
       * this component will listen to that event and call this function.
       * In the event we can find the new queryParams, we apply the new queryParams in the route,
       * this will result in the `category-listing` component to filter the products.
       * @param event - Object
       */
      _setFilters: function(event) {
        var params = event.detail.value;
        var filterUrl = this._encodeParams(params)
          .replace(/%3F/g, '?').replace(/%2F/g, '/').replace(/'/g, '%27');
        if(this.route) {
          var routePath = this.route.path;
          var path = routePath.slice(-1) === '/' ? routePath.slice(0, -1) : routePath;
          this.set('path', path);
        }
        this.set('query', filterUrl);
      },

      /**
       * helperMethod
       * @name _encodeParams
       * @description will transform a url with special characters to a unicoded url so the polymer routing components don't break.
       * so it will transform for example: `?color=Black Raven,River Blue` too `?color=Black%20Raven%2CRiver%20Blue`
       * @param params - Object
       */
      _encodeParams: function(params) {
        var encodedParams = [];
        for (var key in params) {
          var value = params[key];
          if (value === '') {
            encodedParams.push(encodeURI(key));
          } else if (value) {
            encodedParams.push(
                encodeURI(key) +
                '=' +
                encodeURI(value.toString())
            );
          }
        }
        return encodedParams.join('&');
      },

      /**
       * @name checkComponent
       * @description check if filter should be rendered in template
       * @param filter - Object
       * @param type - String
       **/
      checkComponent: function(filter, type, retrievingProducts) {
        return Boolean(filter.type === type && retrievingProducts === false);
      }

    });
  </script>

</dom-module>
