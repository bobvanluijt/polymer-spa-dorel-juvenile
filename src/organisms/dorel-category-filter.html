<link rel="import" href="../../node_modules/app-route/app-route.html">
<link rel="import" href="../../node_modules/app-route/app-location.html">
<link rel="import" href="../../node_modules/iron-location/iron-location.html">
<link rel="import" href="../../node_modules/app-route/app-route-converter.html">
<link rel="import" href="../../node_modules/iron-location/iron-query-params.html">
<link rel="import" href="../utils/dorel-category-filter-data-collector.html">
<link rel="import" href="../molecules/dorel-category-filter-slider.html">
<link rel="import" href="../molecules/dorel-category-filter-checkbox.html">

<dom-module id="dorel-category-filter">
  <template>
    <style>
      h1, h2, h3, h4 {
        @apply(--theme-header-text-transform);
      }

      :host {
        display: block;
        width: 100%;
        box-sizing: border-box;
      }
    </style>

    <app-location route="{{route}}"></app-location>

    <iron-query-params
      params-string="{{query}}"
      params-object="{{queryParams}}"></iron-query-params>

    <app-route-converter
      path="{{path}}"
      query-params="{{queryParams}}"
      route="{{route}}"></app-route-converter>

    <app-route route="{{route}}"></app-route>

    <dorel-category-filter-data-collector
      product-data="[[productData]]"
      filter-data="[[filterData]]"
      filter-groups="{{filterGroups}}"></dorel-category-filter-data-collector>

    <template
      is="dom-repeat"
      items="[[filterGroups]]"
      as="filter"
      observe="type">

      <template
        is="dom-if"
        if="[[checkComponent(filter, 'checkbox', retrievingProducts)]]"
        restamp="true">
        <dorel-category-filter-checkbox
          query-params="[[queryParams]]"
          filter-data="[[filter]]"
          on-update-filter="_setFilters"></dorel-category-filter-checkbox>
      </template>

      <template
        is="dom-if"
        if="[[checkComponent(filter, 'slider', retrievingProducts)]]"
        restamp="true">
        <dorel-category-filter-slider
          query-params="[[queryParams]]"
          filter-data="[[filter]]"
          on-update-filter="_setFilters"></dorel-category-filter-slider>
      </template>

    </template>
  </template>

  <script>
    class DorelCategoryFilter extends Polymer.Element {

      static get is() { return 'dorel-category-filter'; }

      static get properties() {
        return {
          /**
           * string generated by the component and used to generate queryParams
           * example: ?color=black
           */
          path: {
            type: String,
            notify: true
          },

          /**
           * object that contains the filter options
           * example: { color: 'black' }
           */
          queryParams: {
            type: Object,
            notify: true
          },

          /**
           * route object generated and used by the app-route & app-route location component
           */
          route: {
            type: Object,
            notify: true,
            observer: '_resetQueryParams'
          },

          /**
           * array of products that will be converted to filterData in the `dorel-category-filter-data-collector`
           */
          productData: {
            type: Array
          },

          /**
           * array of filters that is generated passed by the parent
           */
          filterData: {
            type: Array
          },

          /**
           * array of filters that is generated by the `dorel-category-filter-data-collector`
           */
          filterGroups: {
            type: Array,
            reflectToAttribute: true,
            notify: true
          },

          /**
           * indictation that the products are being retrieved
           */
          retrievingProducts: {
            type: Boolean,
            value: true
          }
        }
      }

      ready() {
        super.ready();
        this.addEventListener('update-filter', this._setFilters);
      }

      /**
       * resets the query parameters in the url
       *
       * @param {object} old route object
       * @param {object} new route object
       */
      _resetQueryParams(oldValue, newValue) {
        if(!oldValue || !oldValue.path || !newValue || !newValue.path) {
          return;
        }
        if (oldValue.path !== newValue.path) {
          this.set('query', '')
        }
      }

      /**
       * everytime a filter component dispatches the 'update-filter' event, this component will listen to that event and call this function. In the event we can find the new queryParams, we apply the new queryParams in the route, this will result in the `category-listing` component to filter the products.
       *
       * @param {object} the event object of the update-filter event
       */
      _setFilters(event) {
        const params = event.detail.value;
        const filterUrl = this._encodeParams(params)
          .replace(/%3F/g, '?')
          .replace(/%2F/g, '/')
          .replace(/'/g, '%27');

        if (this.route) {
          const routePath = this.route.path;
          const path = routePath.slice(-1) === '/' ? routePath.slice(0, -1) : routePath;
          this.set('path', path);
        }

        this.set('query', filterUrl);
      }

      /**
       * will transform a url with special characters to a unicoded url so the polymer routing components don't break. So it will transform for example: `?color=Black Raven,River Blue` too `?color=Black%20Raven%2CRiver%20Blue`
       *
       * @param {object} url parameters
       */
      _encodeParams(params) {
        const encodedParams = [];

        for (let key in params) {
          const value = params[key];

          if (value === '') {
            encodedParams.push(encodeURI(key));
          } else if (value) {
            encodedParams.push(`${encodeURI(key)}=${encodeURI(value.toString())}`)
          }
        }

        return encodedParams.join('&');
      }

      /**
       * check if filter should be rendered in template
       *
       * @param {object} filter
       * @param {string} filter type
       * @param {boolean} should be retrieving products
       * @returns {boolean}
       */
      checkComponent(filter, type, retrievingProducts) {
        return Boolean(filter.type === type && retrievingProducts === false);
      }
    }

    customElements.define(DorelCategoryFilter.is, DorelCategoryFilter);
  </script>
</dom-module>
