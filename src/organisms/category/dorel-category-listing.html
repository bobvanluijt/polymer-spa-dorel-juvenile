<link rel="import" href="../../molecules/dorel-category-listing-item.html">
<link rel="import" href="../../utils/dorel-category-filter-manager.html">

<dom-module id="dorel-category-listing">
  <template>
    <style>
      h1, h2, h3, h4 {
        @apply(--theme-header-text-transform);
      }

      dorel-layout-row {
        margin-top: -1.5em;
      }
      dorel-loader {
        padding-top: 12em;
        float: left;
      }

      .no-products {
        border-radius: var(--theme-border-radius-2);
        background-color: var(--theme-color-monochrome-2);
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-top: 1.5em;
        padding: 3em;
      }
    </style>

    <dorel-category-filter-manager
      id="categoryManager"
      filters="{{ filters }}"></dorel-category-filter-manager>

    <dorel-layout-row align="left">
      <template
        is="dom-repeat"
        items="[[ products ]]"
        as="product"
        filter="[[ _filterProducts(filters.*) ]]"
        observe="childProducts"
        rendered-item-count="{{ renderedCount }}">

        <dorel-layout-column desktop-column-span="4" tablet-column-span="6" mobile-column-span="12">
          <dorel-category-listing-item
            colors-data="[[ product.child_products ]]"
            link-url="[[ product.url ]]"
            filters="[[ filters ]]"
            product-name="[[ product.name.value ]]"
            gtm-parent="[[ gtmParent ]]"
            gtm-parent-index="[[ gtmParentIndex ]]"
            gtm-child="dorel-category-listing-item"
            gtm-child-index="[[ index ]]"></dorel-category-listing-item>
        </dorel-layout-column>
      </template>
      <dorel-loader loading="[[ retrievingProducts ]]"></dorel-loader>
      <template is="dom-if" if="{{ checkIfProductsAreEmpty(renderedCount, retrievingProducts) }}">
        <div class="no-products">0 {{ localize('Results') }}</div>
      </template>
    </dorel-layout-row>
  </template>
  <script>
    Polymer({
      is: 'dorel-category-listing',

      behaviors: [
        DorelMultilingualBehavior
      ],

      properties: {
        /**
         * @attribute
         * @name productsData
         * @description the data coming from magento which is delegated by the parent
         */
        productsData: {
          type: Array,
          value: []
        },

        /**
         * @attribute
         * @name sort
         * @description Object that is passed by the parent
         * contains: type, order. These will be used to sort the products
         */
        sort: {
          type: Object
        },

        /**
         * @attribute
         * @name retrievingProducts
         * @description Boolean that is passed by the parent
         * will be used by observer, and by dorel-loader component
         */
        retrievingProducts: {
          type: Boolean,
          value: false
        },

        /**
         * @attribute
         * @name products
         * @description Array of the sorted products that will be used by the parent
         */
        products: {
          type: Array,
          notify: true,
          value: function () {
            return [];
          }
        },

        /**
         * @attribute
         * @name filters
         * @description Array of the active filters. Will be used by the dom-repeat
         */
        filters: {
          type: Array
        },

        /**
         * @attribute
         * @name renderedCount
         * @description generated by the dom-repeat, shows the
         */
        renderedCount: {
          type: Number,
          notify: true
        }
      },

      observers: [
        '_setProducts(productsData, retrievingProducts)'
      ],

      /**
       * observer
       * @name _setProducts
       * @description Will set the products that are used by the template
       * if productsData does not contain products or retrievingProducts is true set this.products as a empty array
       * else call _sortProducts and set this.products by pushing products
       * @param productsData - Array
       * @param retrievingProducts - Boolean
       */
      _setProducts: function (productsData, retrievingProducts) {
        if (!productsData.length || retrievingProducts) {
          this.set('products', []);
          return;
        }
        var products = this._sortProducts(productsData);
        this.set('products', []);
        var self = this;
        products.forEach(function (item) {
          self.push('products', item);
        });
      },

      /**
       * @name _sortProducts
       * @description Will sort the items
       * @param items - Array
       * @returns items - Array
       */
      _sortProducts: function (items) {
        if (this.get('retrievingProducts')) {
          return [];
        }
        if (!items.length) {
          return [];
        }
        var type = this.get('sort.type');
        if (type === 'date') {
          this.set('sort.type', 'created_at');
        }
        if (type && type !== 'none') {
          return this._sortString(items, this.get('sort'));
        }
        return items;
      },

      /**
       * @name _sortString
       * @description Will sort the items if value is String/Number
       * @param items - Array
       * @param sort - Object
       * sort will contain type and order
       * type will select the property to sort on. For example: "name"
       * order will determine if it is ordered ascending descending
       */
      _sortString: function (items, sort) {
        return items.sort(function (a, b) {
          if (!a[sort.type] || !a[sort.type].value || !b[sort.type] || !b[sort.type].value) {
            return 0;
          }

          if (!(typeof a[sort.type].value === 'string' && typeof b[sort.type].value === 'string')
            && !(typeof a[sort.type].value === 'number' && typeof b[sort.type].value === 'number')) {
            return 0;
          }

          var a = typeof a[sort.type].value === 'string' ? a[sort.type].value.toUpperCase() : a[sort.type].value;
          var b = typeof b[sort.type].value === 'string' ? b[sort.type].value.toUpperCase() : b[sort.type].value;
          if (a < b) {
            return sort.order === 'asc' ? -1 : 1;
          }
          if (a > b) {
            return sort.order === 'asc' ? 1 : -1;
          }
          // names must be equal
          return 0;
        });
      },

      /**
       * @name _filterProducts
       * @description A function that is used by the dom-repeat in the template
       * @param filters - Array
       * @returns Boolean if true show the product
       */
      _filterProducts: function (filters) {
        var self = this;
        return function (product) {
          // if no filters are applied return true
          if (!filters || !filters.base || !filters.base.length) {
            return true;
          }
          // if there is no product return false
          if (!product) {
            return false;
          }
          // returns a Boolean - if true it will show the product
          return self.$.categoryManager.shouldShowProduct(product, filters);
        };
      },

      /**
       * @name checkIfProductsAreEmpty
       * @description A function that is used by dom-if
       * @param renderedCount - Number
       * @param retrievingProducts - Boolean
       * @returns Boolean
       */
      checkIfProductsAreEmpty: function (renderedCount, retrievingProducts) {
        return Boolean(renderedCount !== 'undefined' && renderedCount === 0 && retrievingProducts === false);
      }

    });
  </script>

</dom-module>
