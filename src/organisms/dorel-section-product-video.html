<dom-module id="dorel-section-product-video">
  <template>
    <style>
      :host {
        @apply(--max-width-host);
      }

      .section-product-video {
        @apply(--max-width-container);
        padding: 3em var(--theme-gutter-mobile) 1.5em var(--theme-gutter-mobile);
        width: 100%;
        float: left;
        box-sizing: border-box;
      }

      .row {
        @apply(--theme-grid-row);
        @apply(--layout-flex);
        @apply(--layout-center-justified);
      }

      .video {
        @apply(--theme-grid-column);
        padding: 0;
        -ms-flex-preferred-size: 100%;
        flex-basis: 100%;
        max-width: 100%;
        margin-top: 0;
      }

      .video-wrapper {
        position: relative;
        height: 0;
        overflow: hidden;
        padding-bottom: 20em;
      }

      iframe {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
      }

      .section-product-video[tablet-medium-up] {
        padding: 7.5em var(--theme-gutter);
      }

      [tablet-medium-up] .video {
        -ms-flex-preferred-size: calc(var(--theme-column-width) * 8);
        flex-basis: calc(var(--theme-column-width) * 8);
        max-width: calc(var(--theme-column-width) * 8);
      }

      [tablet-medium] .video-wrapper {
        padding-bottom: 21em;
      }

      [tablet-medium-up] .video-wrapper {
        padding-bottom: 27em;
      }


    </style>

    <dorel-media-query breakpoints="{{ breakpoints }}"></dorel-media-query>
    <template
      is="dom-if"
      if="[[ videoData.video_id ]]">
      <section class="section-product-video layout horizontal center center-justified wrap"
               tablet-medium$="{{ breakpoints.tabletMedium }}"
               tablet-medium-up$="{{ breakpoints.tabletMediumUp }}">
        <div class="row">
          <div class="video">
            <div class="video-wrapper"
                 on-click="_iframeClick"
                 gtm-parent$="[[ gtmParent ]]"
                 gtm-parent-index$="[[ gtmParentIndex ]]"
                 gtm-child$="[[ gtmChild ]]"
                 gtm-child-index$="[[ gtmChildIndex ]]"
                 gtm-cta-index$="[[ gtmCtaIndex ]]">
              <iframe src="https://www.youtube.com/embed/[[ videoData.video_id ]]"
                      frameborder="0"
                      allowfullscreen width="853" height="480"></iframe>
            </div>
          </div>
        </div>
      </section>
    </template>
  </template>
  <script>
    Polymer({
      is: 'dorel-section-product-video',
      properties: {

        /**
         * @attribute
         * @name videoData
         * @description coming from the page-builder this data object is filled
         * with ACF/Wordpress data about the component
         */
        videoData: {
          type: Object,
          value: function () {
            return {};
          }
        }
      },

      behaviors: [DorelHasValueBehavior],

      /**
       * @name iframeClick
       * @description handles clicks on the iframe
       */
      _iframeClick: function (event) {
        this.playVideo = !this.playVideo;

        if (Polymer.dom(event).rootTarget.tagName === 'A') {
          var element = Polymer.dom(event).rootTarget;
        } else {
          var element = Polymer.dom(event).path[1];
        }

        var component = {
          name: this.gtmParent,
          index: Number(this.gtmParentIndex) + 1
        };

        if (typeof this.gtmChild !== 'undefined' && this.gtmChild !== null) {
          component.child = {
            name: this.gtmChild,
            index: Number(this.gtmChildIndex) + 1,
            event: {
              name: 'call-to-action',
              type: this.type,
              text: this.$.content.getDistributedNodes()[0].textContent,
              index: Number(this.gtmCtaIndex) + 1,
            }
          }
        } else {
          component.event = {
            name: 'call-to-action',
            type: this.type,
            text: this.$.content.getDistributedNodes()[0].textContent,
            index: Number(this.gtmCtaIndex) + 1
          }
        }

        /**
         * Tracking on click for cta
         */
        var event = {
          action: 'click',
          component: component,
          element: element,
          event: 'polymer_event',
          things: {
            'currentPage': document.URL,
            'targetPage': element.href
          }
        };

        this.fire('setAppCache', {value: event, path: 'events'});

        this._eventTracking(event);
      },

      /**
       * @name _eventTracking
       * @description this is for cta tracking only
       * more info http://bit.ly/2nb6I7G
       *
       * @todo tracking isn't working currently, because an iframe is used for videos
       */
      _eventTracking: function (event) {

        /**
         * Tracking on click for cta
         */
        var event = {
          action: (this.playVideo) ? 'play' : 'stop',
          component: 'product-video',
          element: Polymer.dom(event).localTarget,
          event: 'polymer_event'
        };

        this.fire('setAppCache', {value: event, path: 'events'});
      }
    });
  </script>
</dom-module>
