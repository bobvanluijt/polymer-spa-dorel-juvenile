<link rel="import" href="../molecules/dorel-product-accessory.html">
<link rel="import" href="../../bower_components/iron-collapse/iron-collapse.html">

<dom-module id="dorel-section-product-accessories">
  <template>
    <style include="iron-flex iron-flex-alignment">
      :host {
        @apply(--max-width-host);
        background-color: var(--theme-color-monochrome-2);
        float: left;
        width: 100%;
      }

      .section-product-accessories {
        @apply(--max-width-container);
        width: 100%;
        float: left;
        padding: 1.5em var(--theme-gutter-mobile) 3em var(--theme-gutter-mobile);
        box-sizing: border-box;
      }

      .row {
        @apply(--theme-grid-row);
        @apply(--layout-flex);
        @apply(--theme-grid-row-mobile-margins);
      }

      .title {
        @apply(--theme-typography-7);
        color: var(--theme-brand-color-1);
        width: 100%;
        text-align: center;
      }

      .expand-collapse {
        margin: auto;
      }

      dorel-product-accessory {
        box-sizing: border-box;
        -ms-flex-preferred-size: 100%;
        flex-basis: 100%;
        width: 100%;
        margin-top: 1.5em;
      }

      /* Responsive Behaviour */
      .section-product-accessories[tablet-medium-up] {
        padding: 4.5em var(--theme-gutter) 7.5em var(--theme-gutter);
      }

      [tablet-small] dorel-product-accessory, [tablet-medium] dorel-product-accessory {
        -ms-flex-preferred-size: calc(var(--theme-column-width) * 6);
        flex-basis: calc(var(--theme-column-width) * 6);
        width: calc(var(--theme-column-width) * 6);
      }

      [desktop-small-up] dorel-product-accessory {
        -ms-flex-preferred-size: calc(var(--theme-column-width) * 4);
        flex-basis: calc(var(--theme-column-width) * 4);
        width: calc(var(--theme-column-width) * 4);
      }

      [tablet-medium-up] .row {
        @apply(--theme-grid-row-margins);
      }

      [tablet-medium-up] dorel-product-accessory {
        padding: 0 .75em;
      }

    </style>


    <template
      is="dom-if"
      if="[[ relatedProducts ]]">

      <template
        is="dom-if"
        if="[[ _hasRelatedProducts(relatedProducts) ]]">

        <dorel-media-query breakpoints="{{ breakpoints }}"></dorel-media-query>

        <section class="section-product-accessories"
                 mobile-medium$="{{ breakpoints.mobileMedium }}"
                 tablet-small$="{{ breakpoints.tabletSmall }}"
                 tablet-medium$="{{ breakpoints.tabletMedium }}"
                 tablet-medium-up$="{{ breakpoints.tabletMediumUp }}"
                 desktop-small-up$="{{ breakpoints.desktopSmallUp }}">
          <template
            is="dom-if"
            if="[[ _hasValue(accessoriesOptions.title) ]]">
            <h2 class="title">[[ accessoriesOptions.title ]]</h2>
          </template>

          <div class="row">
            <!-- mobile -->
            <template is="dom-if" if="[[ !breakpoints.tabletMediumUp ]]">
              <template
                is="dom-repeat"
                items="[[ initialContent ]]"
                as="accessory">
                <dorel-product-accessory
                  accessory-data="[[ accessory ]]"
                  gtm-action="open-accessory-lightbox"
                  gtm-parent="[[ gtmParent ]]"
                  gtm-parent-index="[[ gtmParentIndex ]]"
                  gtm-child="dorel-product-accessory"
                  gtm-child-index="[[ index ]]"></dorel-product-accessory>
              </template>
              <template is="dom-if" if="[[ restContent.length ]]">
                <!-- Rest content to expand/collapse -->
                <iron-collapse id="collapse">
                  <template
                    is="dom-repeat"
                    items="[[ restContent ]]"
                    as="accessory">
                    <dorel-product-accessory
                      accessory-data="[[ accessory ]]"
                      gtm-action="open-accessory-lightbox"
                      gtm-parent="[[ gtmParent ]]"
                      gtm-parent-index="[[ gtmParentIndex ]]"
                      gtm-child="dorel-product-accessory"
                      gtm-child-index="[[ index ]]"></dorel-product-accessory>
                  </template>
                </iron-collapse>
                <!-- Toggles expand and collapse -->
                <template is="dom-if" if="[[ !expanded ]]">
                  <dorel-cta title="Show all accessories"
                             on-click="_toggle"
                             type="link"
                             link=""
                             size="medium"
                             class="expand-collapse"
                             icon="dorel-icons:expand-more"
                             gtm-action="show-all-accessories"
                             gtm-parent="[[ gtmParent ]]"
                             gtm-parent-index="[[ gtmParentIndex ]]"
                             gtm-cta-index="0">
                    Show all accessories
                  </dorel-cta>
                </template>
                <template is="dom-if" if="[[ expanded ]]">
                  <dorel-cta title="Show less accessories"
                             on-click="_toggle"
                             type="link"
                             link=""
                             size="medium"
                             class="expand-collapse"
                             icon="dorel-icons:expand-less"
                             gtm-action="show-less-accessories"
                             gtm-parent="[[ gtmParent ]]"
                             gtm-parent-index="[[ gtmParentIndex ]]"
                             gtm-cta-index="1">
                    Show less accessories
                  </dorel-cta>
                </template>
              </template>
            </template>

            <!-- desktop -->
            <template is="dom-if" if="[[ breakpoints.tabletMediumUp ]]">
              <template
                is="dom-repeat"
                items="[[ relatedProducts ]]"
                as="accessory">
                <dorel-product-accessory
                  accessory-data="[[ accessory ]]"
                  gtm-action="open-accessory-lightbox"
                  gtm-parent="[[ gtmParent ]]"
                  gtm-parent-index="[[ gtmParentIndex ]]"
                  gtm-child="dorel-product-accessory"
                  gtm-child-index="[[ index ]]"></dorel-product-accessory>
              </template>
            </template>
          </div>
        </section>
      </template>
    </template>
  </template>

  <script>

    Polymer({
      is: 'dorel-section-product-accessories',

      properties: {
        accessoryScrollHandler: {
          type: Boolean,
          notify: true,
          observer: '_scrollHandler'
        },

        /**
         * @attribute
         * @name _numShowOnMobile
         * @description The maximum number to show on mobile, the rest will be expandable
         */
        maxShown: {
          type: Number,
          value: 5
        },

        /**
         * @attribute
         * @name accessoriesData
         * @description data retrieved from ACF/Wordpress to build up this page
         */
        accessoriesData: {
          type: Object,
          value: {
            accessories: []
          }
        },

        /**
         * @attribute
         * @name category
         * @description Number of the category of the main product
         * used by the collect-related-product
         */
        category: {
          type: Number
        },

        /**
         * @attribute
         * @name relatedProducts
         * @description Array with strings of the names of the related products
         * used by the collect-related-product
         */
        relatedProducts: {
          type: Array
        },

        /**
         * @attribute
         * @name accessoriesOptions
         * @description Object with options for the section title and included label
         */
        accessoriesOptions: {
          type: Object
        },

        /**
         * @attribute
         * @name expanded
         * @description boolean that for expanding/collapsing on mobile
         */
        expanded: {
          type: Boolean,
          value: false
        },
        /**
         * @attribute
         * @name initialContent
         * @description Initially shown content, will be shortened
         */
        initialContent: {
          type: String,
          computed: '_computeInitialContent(accessoriesData)'
        },
        /**
         * @attribute
         * @name restContent
         * @description Rest content, shown when component is expanded
         */
        restContent: {
          type: String,
          computed: '_computeRestContent(accessoriesData)'
        },

        /**
         * @attribute
         * @name relatedProducts
         * @description a Array of the relatedProducts passed by the parent
         */
        relatedProducts: {
          type: Array,
          value: function() {
            return [];
          }
        },

        /**
         * @attribute
         * @name appCache
         * @description the temporary cache of the application,
         * contains data that used to be contained by the globalsManager
         */
        appCache: {
          type: Object
        }
      },

      behaviors: [ConditionalBehaviors],

      observers: [
        '_setIncluded(relatedProducts, accessoriesOptions)'
      ],

      /**
       * @name _computeInitialContent
       * @description Splits the content on mobile if there are too many items
       */
      _computeInitialContent: function (accessoriesData) {
        if (accessoriesData && accessoriesData.accessories && accessoriesData.accessories.length > this.maxShown) {
          return accessoriesData.accessories.slice(0, this.maxShown);
        }

        return accessoriesData.accessories;
      },

      /**
       * @name _computeRestContent
       * @description Splits the content on mobile if there are too many items
       */
      _computeRestContent: function (accessoriesData) {
        if (accessoriesData && accessoriesData.accessories && accessoriesData.accessories.length > this.maxShown) {
          return accessoriesData.accessories.slice(this.maxShown);
        }

        return []
      },

      /**
       * @name _toggle
       * @description expands/collapses content
       * **/
      _toggle: function () {
        this.$$('#collapse').toggle();
        this.expanded = !this.expanded;
      },

      /**
       * @name _resizeHandler
       * @description sets the scroll offset position of this section
       *
       */
      _scrollHandler: function (event) {
        this.scrollIntoView({block: "end", behavior: "smooth"})
      },

      /**
       * @name _setIncluded
       * @description determine if a accessory should have a included badge. Sets the relatedProducts
       * @param relatedProducts | Array
       * @param accessoriesOptions | Object
       */
      _setIncluded: function(relatedProducts, accessoriesOptions) {
        if(!relatedProducts || !relatedProducts.length || !accessoriesOptions || !accessoriesOptions.included_products || !accessoriesOptions.included_products.length ) {
          return;
        }
        var included = accessoriesOptions.included_products.replace(' ', '').split(',');
        relatedProducts.forEach(function(accessory) {
          if(included.indexOf(accessory.sku) > -1) {
            accessory.included = true;
          }
        });
        this.set('relatedProducts', relatedProducts);
      },

      /**
       * @name _hasRelatedProducts
       * @description template helper to check if there are relatedProducts
       * @param relatedProducts | Array
       * @returns Boolean
       */
      _hasRelatedProducts: function(relatedProducts) {
        return Boolean(relatedProducts && relatedProducts.length > 0);
      }
    });

  </script>

</dom-module>
