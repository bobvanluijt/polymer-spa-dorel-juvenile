<link rel="import" href="../molecules/dorel-product-accessory.html">
<link rel="import" href="../../bower_components/iron-collapse/iron-collapse.html">

<dom-module id="dorel-section-product-accessories">
  <template>
    <style include="iron-flex iron-flex-alignment">
      :host {
        @apply(--max-width-host);
        background-color: var(--theme-color-monochrome-2);
        float: left;
        width: 100%;
      }

      .section-product-accessories {
        @apply(--max-width-container);
        width: 100%;
        float: left;
        padding: 4.5em var(--theme-gutter) 7.5em var(--theme-gutter);
        box-sizing: border-box;
      }

      .row {
        @apply(--theme-grid-row);
        @apply(--layout-flex);
      }

      .title {
        @apply(--theme-typography-7);
        color: var(--theme-brand-color-1);
        width: 100%;
        text-align: center;
      }

      .expand-collapse {
        margin: auto;
      }

      dorel-product-accessory {
        @apply(--theme-grid-column);
        -ms-flex-preferred-size: calc(var(--theme-column-width) * 4);
        flex-basis: calc(var(--theme-column-width) * 4);
        width: calc(var(--theme-column-width) * 4);
        float: left;
        margin-top: 3em;
      }

      /* Responsive Behaviour */
      .section-product-accessories[mobile-small], .section-product-accessories[mobile-medium] {
        padding: 1.5em var(--theme-gutter-mobile) 3em var(--theme-gutter-mobile);
      }

      [mobile-small] .row {
        margin-right: -0.25em;
        margin-left: -0.25em;
      }

      [mobile-medium] .row {
        margin-right: -0.5em;
        margin-left: -0.5em;
      }

      [tablets] dorel-product-accessory,
      [desktop-small] dorel-product-accessory,
      [mobile-medium-alternative] dorel-product-accessory {
        -ms-flex-preferred-size: calc(var(--theme-column-width) * 6);
        flex-basis: calc(var(--theme-column-width) * 6);
        width: calc(var(--theme-column-width) * 6);
      }

      [mobile-small] dorel-product-accessory, [mobile-medium] dorel-product-accessory {
        @apply(--theme-grid-column-mobile);
        -ms-flex-preferred-size: 100%;
        flex-basis: 100%;
        width: 100%;
        margin-top: 1.5em;
      }
    </style>

    <template
      is="dom-if"
      if="[[ accessoriesData.accessories.length ]]">

      <!-- media queries -->
      <iron-media-query query="(max-width : 479px)"
                        query-matches="{{ mobileSmall }}"></iron-media-query>
      <iron-media-query query="(min-width : 480px) and (max-width : 619px)"
                        query-matches="{{ mobileMedium }}"></iron-media-query>
      <iron-media-query query="(max-width : 619px)"
                        query-matches="{{ mobile }}"></iron-media-query>
      <iron-media-query query="(min-width : 620px) and (max-width : 820px)"
                        query-matches="{{ mobileMediumAlternative }}"></iron-media-query>
      <iron-media-query query="(min-width : 821px) and (max-width : 991px)"
                        query-matches="{{ tablets }}"></iron-media-query>
      <iron-media-query query="(min-width : 992px) and (max-width : 1199px)"
                        query-matches="{{ desktopSmall }}"></iron-media-query>

      <section class="section-product-accessories"
               mobile-small$="{{ mobileSmall }}"
               mobile-medium$="{{ mobileMedium }}"
               mobile-medium-alternative$="{{ mobileMediumAlternative }}"
               tablets$="{{ tablets }}"
               desktop-small$="{{ desktopSmall }}">
        <template
          is="dom-if"
          if="[[ _hasValue(accessoriesData.title) ]]">
          <h2 class="title">[[ accessoriesData.title ]]</h2>
        </template>
        <div class="row">
          <template is="dom-if" if="[[ mobile ]]">
            <template
              is="dom-repeat"
              items="[[ initialContent ]]"
              as="accessory">
              <dorel-product-accessory accessory-data="[[ accessory ]]"></dorel-product-accessory>
            </template>
            <template is="dom-if" if="[[ restContent.length ]]">
              <!-- Rest content to expand/collapse -->
              <iron-collapse id="collapse">
                <template
                  is="dom-repeat"
                  items="[[ restContent ]]"
                  as="accessory">
                  <dorel-product-accessory accessory-data="[[ accessory ]]"></dorel-product-accessory>
                </template>
              </iron-collapse>
              <!-- Toggles expand and collapse -->
              <template is="dom-if" if="[[ !expanded ]]">
                <dorel-cta title="Show all accessories"
                           on-click="_toggle"
                           type="link"
                           link=""
                           size="small"
                           class="expand-collapse"
                           icon="dorel-icons:expand-more">
                  Show all accessories
                </dorel-cta>
              </template>
              <template is="dom-if" if="[[ expanded ]]">
                <dorel-cta title="Show less accessories"
                           on-click="_toggle"
                           type="link"
                           link=""
                           size="small"
                           class="expand-collapse"
                           icon="dorel-icons:expand-less">
                  Show less accessories
                </dorel-cta>
              </template>
            </template>
          </template>
          <template is="dom-if" if="[[ !mobile ]]">
            <template
              is="dom-repeat"
              items="[[ accessoriesData.accessories ]]"
              as="accessory">
              <dorel-product-accessory accessory-data="[[ accessory ]]"></dorel-product-accessory>
            </template>
          </template>
        </div>
      </section>
    </template>
  </template>

  <script>

    Polymer({
      is: 'dorel-section-product-accessories',

      properties: {
        accessoryScrollHandler: {
          type: Boolean,
          notify: true,
          observer: '_scrollHandler'
        },

        /**
         * @attribute
         * @name _numShowOnMobile
         * @description The maximum number to show on mobile, the rest will be expandable
         */
        maxShown: {
          type: Number,
          value: 5
        },

        /**
         * @attribute
         * @name accessoriesData
         * @description data retrieved from ACF/Wordpress to build up this page
         */
        accessoriesData: {
          type: Object,
          value: function () {
            return {};
          }
        },

        /**
         * @attribute
         * @name expanded
         * @description boolean that for expanding/collapsing on mobile
         */
        expanded: {
          type: Boolean,
          value: false
        },
        /**
         * @attribute
         * @name initialContent
         * @description Initially shown content, will be shortened
         */
        initialContent: {
          type: String,
          computed: '_computeInitialContent(accessoriesData)'
        },
        /**
         * @attribute
         * @name restContent
         * @description Rest content, shown when component is expanded
         */
        restContent: {
          type: String,
          computed: '_computeRestContent(accessoriesData)'
        },
      },

      /**
       * @name clickDetails
       * @description handle of the click on the details links
       */
      clickDetails: function (event) {
        // track the event
        this._eventTracking(event);
      },

      /**
       * @name _computeInitialContent
       * @description Splits the content on mobile if there are too many items
       */
      _computeInitialContent: function (accessoriesData) {
        if (accessoriesData.accessories.length > this.maxShown) {
          return accessoriesData.accessories.slice(0, this.maxShown);
        }

        return accessoriesData.accessories;
      },

      /**
       * @name _computeRestContent
       * @description Splits the content on mobile if there are too many items
       */
      _computeRestContent: function (accessoriesData) {
        if (accessoriesData.accessories.length > this.maxShown) {
          return accessoriesData.accessories.slice(this.maxShown);
        }

        return []
      },

      /**
       * @name _toggle
       * @description expands/collapses content
       * **/
      _toggle: function () {
        this.$$('#collapse').toggle();
        this.expanded = !this.expanded;
      },

      /**
       * @name _hasValue
       * @description checks to see if a value is set
       *
       * @returns Boolean
       */
      _hasValue: function (val) {
        return (typeof val !== 'undefined' || val !== '');
      },

      /**
       * @name _resizeHandler
       * @description sets the scroll offset position of this section
       *
       */
      _scrollHandler: function (event) {
        this.scrollIntoView({block: "end", behavior: "smooth"})
      },

      /**
       * @name _eventTracking
       * @description this is for cta tracking only
       * more info http://bit.ly/2nb6I7G
       */
      _eventTracking: function (event) {

        var globals = Polymer.globalsManager.get('Dorel');

        /**
         * Tracking on click for cta
         */
        Polymer.globalsManager.set('Dorel.events', {
          action: 'click',
          component: 'product-accessories',
          element: Polymer.dom(event).localTarget,
          event: 'polymer_event',
          things: {
            'currentPage': document.URL,
            'targetPage': Polymer.dom(event).localTarget.href
          }
        });
      }
    });

  </script>

</dom-module>
