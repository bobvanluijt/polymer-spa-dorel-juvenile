<dom-module id="dorel-wp-collect-menu-locations">
  <template>
    <iron-ajax
      auto
      url="[[ endPoint ]]" 
      handle-as="json" 
      on-response="_menuLoaded"></iron-ajax>

    <iron-ajax
      id="menuItems"
      url=""
      handle-as="json"
      on-response="_menuItemsLoaded"></iron-ajax>
  </template>
</dom-module>

<script>
  Polymer({
    is: 'dorel-wp-collect-menu-locations',
    properties: {
      /**
       * `wpUrl` this is the url to your Wordpress instance
       */
      wpUrl: {
        type: String
      },

      /**
       * `endPoint`
       */
      endPoint: {
        type: String
      }
    },
    observers: [
      '_initMenuLocations(globals.Dorel.wpUrl)'
    ],

    /** 
     * @name _menuLoaded
     * @description process the retrieved menu locations
     */
    _menuLoaded: function(data) {
      var response = data.detail.response;

      // iterate over the keys of the response
      for (var key in response) {
        if (key !== 'utilities_menu') {

          // for every key retrieve its menuItems
          this.$.menuItems.url = this.wpUrl + '/wp-api-menus/v2/menu-locations/' + key;

          // kicks off the request, when response is given _menuItemsLoaded is fired
          this.$.menuItems.generateRequest();
        }
      }

      // place all the menu locations in the collect menus object
      Polymer.globalsManager.set('Dorel.collect.menus', response);
    },

    /** 
     * @name _menuItemsLoaded
     * @description This function handles the generateRequest
     * of the menu items per menu location.
     */
    _menuItemsLoaded: function(data) {
      var response = data.detail.response;

      // retrieve the location name from the url call
      var urlArr = data.detail.url.split('/');
      var menuLocation = urlArr[urlArr.length - 1];

      // iterate over all menu items, alter its title and set the right url
      response.forEach(function(item) {
        item.title = item.title.toLowerCase();
      });

      // place the menu items in the right key inside the collect
      Polymer.globalsManager.set('Dorel.collect.menus.' + menuLocation, {});
      Polymer.globalsManager.set('Dorel.collect.menus.' + menuLocation + '.items', response);

      // set the menuData (two way data binding for the app)
      this.menuData = this.globals.Dorel.collect.menus;
    },
    
    /**
     * @name _initMenuLocations
     * @description Observer function which defines the endpoint when it's available as a global variable
     */
    _initMenuLocations: function(wpUrl) {
      if (typeof wpUrl === 'undefined' || wpUrl === '' || !this._hasProps(wpUrl)) return;

      this.endPoint = this.wpUrl + '/wp-api-menus/v2/menu-locations';
    },



    /**
     * @name _hasProps
     * @description check if the observed data model has properties
     */
    _hasProps: function(dataObj) {
      // define dataEmpty variable to check wheter the dorelEvt object is empty or not
      var hasProps = false;

      // check for properties in the dorelEvt object
      for (var prop in dataObj) {
        hasProps = (dataObj.hasOwnProperty(prop)) ? true : false;
      }

      return hasProps;
    }

  });
</script>