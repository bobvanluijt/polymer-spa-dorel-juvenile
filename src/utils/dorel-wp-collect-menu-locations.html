<dom-module id="dorel-wp-collect-menu-locations">
  <template>
    <iron-ajax
      auto
      url="[[ endPoint ]]" 
      handle-as="json" 
      on-response="_menuLoaded"></iron-ajax>

    <iron-ajax
      id="menuItems"
      url=""
      handle-as="json"
      on-response="_menuItemsLoaded"></iron-ajax>
  </template>
</dom-module>

<script>
  Polymer({
    is: 'dorel-wp-collect-menu-locations',
    properties: {
      /**
       * `appCache` the application cache
       */
      appCache: {
        type: Object
      },

      /**
       * `endPoint`
       */
      endPoint: {
        type: String
      }
    },

    observers: [
      '_initMenuLocations(appCache.wpUrl)'
    ],

    /**
     * @observer
     * @name _initMenuLocations
     * @description when the wpUrl changes it sets the endPoint which will fire the iron-ajax
     */
    _initMenuLocations: function(wpUrl) {
      if (typeof wpUrl === 'undefined' || wpUrl === '') return;

      this.endPoint = wpUrl + '/wp-api-menus/v2/menu-locations';
    },

    /** 
     * @name _menuLoaded
     * @description process the retrieved menu locations
     */
    _menuLoaded: function(data) {
      var response = data.detail.response;

      // iterate over the keys of the response
      for (var key in response) {
        if (key !== 'utilities_menu') {
          var wpUrl = this.get('appCache.wpUrl');

          // for every key retrieve its menuItems
          this.$.menuItems.url = wpUrl + '/wp-api-menus/v2/menu-locations/' + key;

          // kicks off the request, when response is given _menuItemsLoaded is fired
          this.$.menuItems.generateRequest();
        }
      }

      // place all the menu locations in the collect menus object
      this.fire('setAppCache', { value: response, path: 'collect.menus' });
    },

    /** 
     * @name _menuItemsLoaded
     * @description This function handles the generateRequest
     * of the menu items per menu location.
     */
    _menuItemsLoaded: function(data) {
      var response = data.detail.response;

      // retrieve the location name from the url call
      var urlArr = data.detail.url.split('/');
      var menuLocation = urlArr[urlArr.length - 1];

      // iterate over all menu items, alter its title and set the right url
      for (var i = 0, len = response.length; i < len; i++) {
        response[i].title = response[i].title.toLowerCase();
      }
      
      // place the menu items in the right key inside the collect
      this.fire('setAppCache', { value: {}, path: 'collect.menus.' + menuLocation });
      this.fire('setAppCache', { value: response, path: 'collect.menus.' + menuLocation + '.items' });
    }

  });
</script>