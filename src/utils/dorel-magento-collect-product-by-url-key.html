
<dom-module id="dorel-magento-collect-product-by-url-key">
  <template>

    <iron-ajax
      id="product"
      content-type="application/json"
      method="get"
      handle-as="json"
      on-response="_productResponse"></iron-ajax>

  </template>

  <script>
    class DorelMagentoCollectProductByUrlKey extends ReduxMixin(Polymer.Element) {

      static get is() {
        return 'dorel-magento-collect-product-by-url-key';
      }
      
      static get properties() {
        return {
          /**
           * @name category
           * @description this category is inherit by the parent and
           * will be used in the filter for the call to the magento end-point
           */
          category: {
            type: Number,
            value: 0
          },

          /**
           * @name productName
           * @description productName represents the id (sku) of a product
           */
          productName: {
            type: String
          },

          /**
           * @name currentProduct
           * @description currentProduct will be used to send the correct data to the parent
           */
          currentProduct: {
            type: Object,
            notify: true
          },

          /**
           * @name retrievingProduct
           * @description loading indicator true if it is loading
           */
          retrievingProduct: {
            type: Boolean,
            notify: true,
            value: false
          },

          /**
           * @attribute
           * @name appCache
           * @description the temporary cache of the application,
           * contains data that used to be contained by the globalsManager
           */
          appCache: {
            type: Object
          }
        };
      }

      static get observers() {
        return [
          '_init(productName, appCache.currentLanguage)'
        ]
      }

      /**
       * @name _init
       * @description will be called by the observer
       * @param category - Number
       * @param productName - String
       * @param token - String
       * @param colorMap - Array
       */
      _init(productName, currentLanguage) {
        // if category or productName is empty we can't make the call return
        if(!productName || !currentLanguage) {
          return;
        }

        //set retrievingProduct to true so parent will know that product is being retrieved
        this.set('retrievingProduct', true);

        // get all the products that are saved in the global
        var products = this.get('appCache.product.products') || [];

        // check if the productName (potential new current product) is already in the saved products
        var existingProduct = products.find(function(product) {
          return product.url === productName;
        });

        // if the product already exists set this product else retrieve product from api
        if(existingProduct) {
          return this._setCurrentProduct(existingProduct);
        } else {
          return this._getProduct(productName);
        }
      }

      /**
       * @name _getProduct
       * @description make call to end-point to retreive product
       * @param category - Number
       */
      _getProduct(productName) {
        var productsEl = this.$.product;
        var currentLanguageCode = this.get('appCache.currentLanguage.languageCode');
        productsEl.url = CONFIG.ECOM_URL + '/rest/V1/dorel/product/' + productName + '?language=' + currentLanguageCode;
        productsEl.generateRequest();
      }

      /**
       * @name _productResponse
       * @description response of the _getProduct call;
       * @param response
       */
      _productResponse(response) {
        //set newProducts Array from response
        var response = response.detail.response || [];
        var newProducts = response.map(function(product) {
          if(product && !product.child_products || product && !product.child_products.length) {
            product.child_products = [Object.assign({}, product)];
          }
          return product;
        });

        //if there are no products in Array
        if(!newProducts.length) {
          //set the currentProduct with a empty Object so parent will know it should show a 404
          return this._setCurrentProduct({});
        } else {
          return this._setProducts(newProducts)
        }
      }

      /**
       * @name _setProducts
       * @description will merge the old and new products and remove the duplicates and set the global products
       * @param newProducts - Array
       */
      _setProducts(newProducts) {
        //set the current product with the first Object from Array
        this._setCurrentProduct(newProducts[0]);

        //get all the "cached" products
        var oldProducts = this.get('appCache.product.products') || [];

        //check if item exists else filter it before merging arrays (oldProducts / newProducts)
        var products = this._mergeArrays(oldProducts, newProducts);
        // set new array of products in the global saved products
        this.dispatchEvent(new CustomEvent('setAppCache', { bubbles: true, composed: true, detail: {
          value: products,
          path: 'product.products'
        }}));
      }

      /**
       * @name _mergeArrays
       * @description this method will merge 2 arrays of products
       * @param array1 - Array
       * @param array2 - Array
       */
      _mergeArrays(array1, array2) {
        //check if item exists else filter it before merging arrays (oldProducts / newProducts)
        return array1.concat(array2.filter(function(item, index) {
            return array1.some(function(oldItem) {
              return oldItem.id === item.id;
            });
        }));
      }

      /**
       * @name _setCurrentProduct
       * @description this method will set global current product;
       * @param product - Object
       */
      _setCurrentProduct(product) {
        //set current product in appCache so meta-data will be set
        this.dispatchEvent(new CustomEvent('setAppCache', { bubbles: true, composed: true, detail: {
          value: product,
          path: 'current.product'
        }}));

        //set current product so it will be available for parent
        this.set('currentProduct', product);
        //set retrievingProduct to false so parent will know that product is retrieved
        this.set('retrievingProduct', false);
      }
    }
    customElements.define(DorelMagentoCollectProductByUrlKey.is, DorelMagentoCollectProductByUrlKey);
  </script>
</dom-module>
