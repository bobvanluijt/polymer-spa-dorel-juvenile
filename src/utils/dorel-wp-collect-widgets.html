<dom-module id="dorel-wp-collect-widgets">
  <template>
    <iron-ajax 
      auto 
      url="[[ endPoint ]]" 
      handle-as="json"
      on-response="_widgetAreasLoaded"></iron-ajax>

    <iron-ajax
      id="widget"
      url=""
      handle-as="json"
      on-response="_widgetsLoaded"></iron-ajax>
  </template>

  <script>
    Polymer({
      is: 'dorel-wp-collect-widgets',

      properties: {
        /**
         * @name endPoint
         * @description the endpoint or url of the api
         */
        endPoint: {
          type: String
        }
      },

      observers: [
        '_initWidgets(globals.Dorel.wpUrl)'
      ],

      /** 
       * @name _widgetAreasLoaded
       * @description retrieve all the widget areas and then trigger
       * the rest call to retrieve the widgets
       */
      _widgetAreasLoaded: function(data) {
        var response = data.detail.response;
        var widgetEl = this.$.widget;
        var endPoint = this.endPoint;

        // prepare the global collect object
        Polymer.globalsManager.set('Dorel.collect.widgetAreas', {});

        // iterate over the keys of the response
        response.forEach(function(widgetArea) {

          // first put the response in the globals to use it later
          Polymer.globalsManager.set('Dorel.collect.widgetAreas.' + widgetArea.id,
            widgetArea);

          // for every key retrieve its menuItems
          widgetEl.url = endPoint + '/' + widgetArea.id;
          widgetEl.generateRequest();
        });
      },

      /** 
       * @name _widgetsLoaded
       * @description retrieve all widgets per widget area and place them
       * accordingly
       */
      _widgetsLoaded: function(data) {
        var response = data.detail.response;
        var widgetsCollect = this.globals.Dorel.collect.widgetAreas;

        // retrieve the widgetArea id from the url call
        var urlArr = data.detail.url.split('/');
        var areaId = urlArr[urlArr.length - 1];

        // iterate over the keys in the response
        for (var key in widgetsCollect) {
          if (key === areaId) {
            // update the global collecto object
            Polymer.globalsManager.set('Dorel.collect.widgetAreas.' + key, response);
          }
        }

        // update the reflected attribute
        this.widgetsData = this.globals.Dorel.collect.widgetAreas;
      },

      /**
       * @name _initWidgets
       * @description Observer function which defines the endpoint when it's available as a global variable
       */
      _initWidgets: function(wpUrl) {
        if (typeof wpUrl === 'undefined' || wpUrl === '' || !this._hasProps(wpUrl)) return;

        this.endPoint = this.globals.Dorel.wpUrl + '/wp-rest-api-sidebars/v1/sidebars';
      },



      /**
       * @name _hasProps
       * @description check if the observed data model has properties
       */
      _hasProps: function(dataObj) {
        // define dataEmpty variable to check wheter the dorelEvt object is empty or not
        var hasProps = false;

        // check for properties in the dorelEvt object
        for (var prop in dataObj) {
          hasProps = (dataObj.hasOwnProperty(prop)) ? true : false;
        }

        return hasProps;
      }

    });
  </script>
</dom-module>