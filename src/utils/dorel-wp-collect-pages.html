<dom-module id="dorel-wp-collect-pages">
  <template>
    <iron-ajax
      auto
      url="[[ endPoint ]]"
      handle-as="json"
      on-response="_pagesLoaded"></iron-ajax>
  </template>

  <script>
    Polymer({
      is: 'dorel-wp-collect-pages',

      properties: {
        /**
         * `appCache` the application cache
         */
        appCache: {
          type: Object
        },

        /**
         * @name collect
         * @description this array will hold all the pages collected from the
         * async requests (pages, posts)
         */
        collect: {
          type: Array,
          value: []
        },

        /**
         * @name perPage
         * @description this variable indicates how many pages are retrieved
         * per request
         */
        perPage: {
          type: Number,
          value: 100
        }
      },

      observers: [
        '_initPages(appCache.wpUrl, appCache.currentLanguage.path)'
      ],

      /**
       * @observer
       * @name _initPages
       * @description when the wpUrl is set in the application cache set the endpoint
       */
      _initPages: function(wpUrl, currentLanguage) {
        if (typeof wpUrl === 'undefined' || wpUrl === '') return;
        this.endPoint = wpUrl +
        (currentLanguage && currentLanguage.length ? currentLanguage + '/' : '') +
        'wp-json/wp/v2/pages?per_page=' + this.perPage;
      },

      /**
       * @helper
       * @name _pagesLoaded
       * @description process the retrieved pages from the iron-ajax
       */
      _pagesLoaded: function(data) {
        var pages = data.detail.response;

        if (!pages.length) return;

        // iterate over all pages items, alter its template
        for (var i = 0, len = pages.length; i < len; i++) {

          // alter the template, strip 'page-' prefix
          var template = pages[i].template.slice(0, -4);
          var pageName = template.replace('page-','');

          // set pageObjects template property
          pages[i].template = pageName;
        }

        // extend the collect pages object with the new page
        this.collect = this.collect.concat(pages);

        // set the application cache
        this.fire('setAppCache', {
          path: 'collect.pages',
          value: this.collect
        });
      }
    });
  </script>
</dom-module>
