<dom-module id="dorel-wp-collect-pages">
  <template>
    <iron-ajax 
      auto 
      url="[[ endPoint ]]" 
      handle-as="json"
      on-response="_pagesLoaded"></iron-ajax>

    <iron-ajax 
      id="products"
      url="" 
      handle-as="json"
      on-response="_productsLoaded"></iron-ajax>
  </template>

  <script>
    Polymer({
      is: 'dorel-wp-collect-pages',

      properties: {
        /**
         * @name endPoint
         * @description the endpoint or url of the api
         */
        endPoint: {
          type: String
        },

        /** 
         * @name collect
         * @description this array will hold all the pages collected from the
         * async requests (pages, products, posts)
         */
        collect: {
          type: Array,
          value: []
        }
      },

      ready: function() {
        this.endPoint = this.globals.Dorel.wpUrl + '/wp/v2/pages';
      },

      /** 
       * @name _pagesLoaded
       * @description process the retrieved pages
       */
      _pagesLoaded: function(data) {
        var self = this;
        var productsEl = self.$.products;
        var pages = data.detail.response;

        if (!pages.length) return;

        // iterate over all pages items, alter its template
        pages.forEach(function(page) {

          // alter the template, strip 'page-' prefix
          var template = page.template.slice(0, -4);
          var pageName = template.replace('page-','');

          // set pageObjects template property
          page.template = pageName;

          // extend the collect pages object with the new page
          self.collect.push(page);
        });

        // define url for retrieving products
        productsEl.url = this.globals.Dorel.wpUrl + '/wp/v2/products';

        // do the products call
        productsEl.generateRequest();
      },

      /** 
       * @name _productsLoaded
       * @description process the retrieved products
       */
      _productsLoaded: function(data) {
        var self = this;
        var productsArray = data.detail.response;
        
        // if we have products we need to add them
        if (productsArray.length) {

          // create upper level products
          var productsObject = {
            slug: 'products',
            template: 'products',
            title: {
              rendered: 'products'
            },
            products: []
          };

          // iterate over all products items, alter its title and set the right url
          productsArray.forEach(function(product) {
            /**
             * Assign a template to this taxonomy this is used by
             * the template switcher (dorel-template.html)
             */
            product.template = 'product-detail';

            /**
             * We will alter the acf object to comply to page-builder
             */ 
            var acfObj = { page_builder: [] };
            
            // run throught the normal response acf
            for (var acfKey in product.acf.product_detail_builder[0]) {
              /**
               * @todo: refactor! 
               * For duplicated components we need to suffix them by a number
               * when placing them in the page_builder we need to strip this number
               * because we delegate them to the page builder element
               */
              // var keyArr = acfKey.split('_');
              // var hasNumber = !isNaN(Number(keyArr[keyArr.length - 1]));

              // grab all inner values of the acfType
              var acfLayout = product.acf.product_detail_builder[0][acfKey][0];

              // set the new acf_fc_layout variable to the key
              acfLayout.acf_fc_layout = acfKey;
              
              // place the new acf_fc_layout in the page_builder array
              acfObj.page_builder.push(acfLayout);
            }

            // replace the old acf object with the new formed acf
            product.acf = acfObj;

            // extend the collect pages with the new product page
            productsObject.products.push(product);
          });

          self.collect.push(productsObject);
        }

        // set the new collect obj
        Polymer.globalsManager.set('Dorel.collect.pages', self.collect);

        // import the footer after the pages are loaded
        this.importHref(this.resolveUrl('../organisms/dorel-footer.html'), null, null, true);
      }
    });
  </script>
</dom-module>
