<dom-module id="dorel-wp-collect-pages">
  <template>
    <iron-ajax 
      auto 
      url="[[ wpUrl ]]/wp/v2/pages" 
      handle-as="json"
      on-response="_pagesLoaded"></iron-ajax>

    <iron-ajax 
      id="products"
      url="[[ wpUrl ]]/wp/v2/products" 
      handle-as="json"
      on-response="_productsLoaded"></iron-ajax>
  </template>

  <script>
    Polymer({
      is: 'dorel-wp-collect-pages',

      properties: {
        /**
         * `wpUrl` of the url of the Wordpress instance
         */
        wpUrl: {
          type: String
        },

        collect: {
          type: Array,
          value: []
        }
      },

      /** 
       * @name _pagesLoaded
       * @description process the retrieved pages
       */
      _pagesLoaded: function (data) {
        var self = this;
        var productsEl = self.$.products;
        var pages = data.detail.response;

        if (!pages.length) return;

        // iterate over all pages items, alter its template
        pages.forEach(function(page) {
          var template = page.template.slice(0, -4);
          var pageName = template.replace('page-','');

          page.template = pageName;

          // extend the collect pages object with the new page
          self.collect.push(page);
        });

        productsEl.generateRequest();
      },

      /** 
       * @name _productsLoaded
       * @description process the retrieved products
       */
      _productsLoaded: function (data) {
        var self = this;
        var products = data.detail.response;
        
        // if we have products we need to add them
        if (products.length) {

          // retrieve collect.pages if no pages set empty array
          var collect = self.collect;

          // iterate over all products items, alter its title and set the right url
          products.forEach(function(product) {
            /**
             * Assign a template to this taxonomy this is used by
             * the template switcher (dorel-template.html)
             */
            product.template = 'product-detail';

            /**
             * We will alter the acf object to comply to page-builder
             */ 
            var acfObj = { page_builder: [] };
            
            // run throught the normal response acf
            for (var acfKey in product.acf.product_detail_builder[0]) {
              /**
               * TODO: refactor! 
               * For duplicated components we need to suffix them by a number
               * when placing them in the page_builder we need to strip this number
               * because we delegate them to the page builder element
               */
              var keyArr = acfKey.split('_');
              var hasNumber = !isNaN(Number(keyArr[keyArr.length - 1]));

              // grab all inner values of the acfType
              var acfLayout = product.acf.product_detail_builder[0][acfKey][0];

              // if the acfKey has a number we need to strip it
              if( hasNumber ) {
                keyArr.pop();
                acfLayout.acf_fc_layout = keyArr.join('_');

                // place the new acf_fc_layout in the page_builder array
                acfObj.page_builder.push(acfLayout);
              } else {
                // set the new acf_fc_layout variable to the key
                acfLayout.acf_fc_layout = acfKey;
                
                // place the new acf_fc_layout in the page_builder array
                acfObj.page_builder.push(acfLayout);
              }
            }

            // replace the old acf object with the new formed acf
            product.acf = acfObj;

            // extend the collect pages with the new product page
            self.collect.push(product);
          });
        }

        // set the new collect obj
        Polymer.globalsManager.set('Dorel.collect.pages', self.collect);
      }
    });
  </script>
</dom-module>
