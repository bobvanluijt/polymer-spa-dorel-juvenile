<dom-module id="dorel-category-filter-data-collector">
  <template>
  </template>
  <script>
    Polymer({
      is: 'dorel-category-filter-data-collector',

      properties: {
        /**
         * @name productData
         * @description Array of products is passed by the parent component
         * used to extract all the filter_groups per product
         */
        productData: {
          type: Array
        },

        /**
         * @name filterData
         * @description Array of filters_groups by the parent
         */
        filterData: {
          type: Array
        },

        /**
         * @name filterGroups
         * @description Array of filters that is generated by this component
         * based on the filter_groups inside the filterData and the values of the products
         */
        filterGroups: {
          type: Array,
          notify: true
        }
      },

      observers: [
        '_productDataChanged(productData, filterData)'
      ],

      /**
       * observer
       * @name _productDataChanged
       * @description Called when the productData changes
       * will set the filterData with response of _setFilters
       * @param products - Array
       */
      _productDataChanged: function(products, filterData) {
        if(!products || !filterData) {
          return;
        }
        this.set('filterGroups', []);
        var filterGroups = this._setFilters(products, filterData);
        this.set('filterGroups', filterGroups);
      },

      /**
       * helperMethod
       * @name _productDataChanged
       * @description Will extract all filter_groups from all the products that are passed
       * It will generate a new array with unique filtergroups and unique values within the filtergroups
       * @param products - Array
       * @returns filters - Array
       */
      _setFilters: function(products, filterData) {
        var self = this;

        let filterGroups = filterData.map(group => {
          group.values = [];
          products.forEach(product => {
            if(!product || !product.filter_groups) {
              return;
            }
            product.filter_groups.forEach(productFilterGroup => {
              if ( productFilterGroup.name === group.name ||
                   (this._isColorGroup(group.name) && this._isColorGroup(productFilterGroup.name))
              ) {
                productFilterGroup.values.map(item => {
                  item.label = item.value;
                  //TODO should be refactured in end-point (back-end)
                  // if item.color is not a hexcode it is a image
                  if(item && item.color && item.color[0] !== '#') {
                    // set image
                    item.image = item.color;
                    // remove color
                    delete item.color;
                  }
                  if(typeof item.value === 'string') {
                    item.value = item.value.replace(/\s/g, '-');
                  }
                  return item;
                });
                group.values = self._mergeArrays(group.values, productFilterGroup.values);
              }
            });
          });
          if(group.values.length) {
            return group;
          }
        }).filter(group => {
          return group ? true : false;
        });
        return filterGroups;
      },

      /**
       * helperMethod
       * @name _mergeArrays
       * @description this method will merge 2 arrays
       * @param array1 - Array
       * @param array2 - Array
       */
      _mergeArrays: function(array1, array2) {
        //check if item exists else filter it before merging arrays
        return array1.concat(array2.filter(function(item, index) {
            var exists = false;
            array1.forEach(function(oldItem) {
              if (oldItem.value === item.value) {
                exists = true;
              }
            });
            return !exists;
        }));
      },

      _isColorGroup: function(name) {
        return ['color', 'colour'].includes(name.toLowerCase()) ? true : false;
      }

    });

  </script>

</dom-module>
