<dom-module id="dorel-category-filter-data-collector">
  <template>
    <style include="iron-flex iron-flex-alignment">
      :host {
      }
    </style>
  </template>
  <script>
    Polymer({
      is: 'dorel-category-filter-data-collector',

      properties: {
        /**
         * @name productData
         * @description this is passed by the parent component
         */
        productData: {
          type: Array,
          value: function() { return []; }
        },

        filterData: {
          type: Object,
          notify: true
        }

      },

      observers: [
        '_productDataChanged(productData)'
      ],

      _productDataChanged: function(products) {
        if(!products || !products.length) {
          return;
        }
        var filterData = {};
        filterData.priceFilter = this._setPriceFilter(products);
        filterData.colorFilter = this._setColorFilter(products);
        this._setFilterData(filterData);
      },


      _setFilterData: function(filterData) {
        this.set('filterData', filterData);
      },

      _setColorFilter: function(products) {
        var colorFilter = {};
        var colors = [];
        var self = this;
        products.forEach(function(product) {
          var newColor;
          product.childProducts.forEach(function(childProduct) {
            newColor = {
              name: childProduct.color,
              code: childProduct.color_code,
              checked: false,
              amount: 1
            };
            var placeIndex;
            var exist = colors.find(function(item, index) {
              placeIndex = index;
              return item.name === newColor.name;
            })
            if(exist) {
              colors[placeIndex].amount = colors[placeIndex].amount + 1;
            } else {
              colors.push(newColor);
            }
          });
        });

        colorFilter.colors = colors;
        return colorFilter;
      },

      _setPriceFilter: function(products) {
        var priceFilter = {};
        var maxPrice = 0;
        products.forEach(function(product) {
          if(!product.childProducts) {
            maxPrice = product.price > maxPrice ? product.price : maxPrice;
          } else {
            var childProductPrices = product.childProducts.map(function(childProduct) {
              return childProduct.price || 0;
            });
            var higestPrice = Math.max.apply(Math, childProductPrices);
            maxPrice = higestPrice > maxPrice ? higestPrice : maxPrice;
          }
        });
        priceFilter.maxPrice = maxPrice;
        return priceFilter;
      }

    });

  </script>

</dom-module>
