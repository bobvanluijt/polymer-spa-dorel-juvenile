<dom-module id="dorel-category-filter-data-collector">
  <template>
    <style include="iron-flex iron-flex-alignment">
      :host {
      }
    </style>
  </template>
  <script>
    Polymer({
      is: 'dorel-category-filter-data-collector',

      properties: {
        /**
         * @name productData
         * @description Array of products is passed by the parent component
         * used to extract all the filter_groups per product
         */
        productData: {
          type: Array,
          value: function() { return []; }
        },

        /**
         * @name filterData
         * @description Array of filters that is generated by this component
         * based on the filter_groups and will pass filterData to parent
         */
        filterData: {
          type: Array,
          notify: true
        },

        /**
         * @name queryParams
         * @description Object passed from parent
         */
        queryParams: {
          type: Object
        }

      },

      observers: [
        '_productDataChanged(productData)'
      ],

      /**
       * observer
       * @name _productDataChanged
       * @description Called when the productData changes
       * will set the filterData with response of _setFilters
       * @param products - Array
       */
      _productDataChanged: function(products) {
        if(!products || !products.length) {
          return;
        }
        this.set('filterData', []);
        var query = this.queryParams;
        var filterData = this._setFilters(products);
        this.set('filterData', filterData);
      },

      /**
       * helperMethod
       * @name _productDataChanged
       * @description Will extract all filter_groups from all the products that are passed
       * It will generate a new array with unique filtergroups and unique values within the filtergroups
       * @param products - Array
       * @returns filters - Array
       */
      _setFilters: function(products) {
        if(!products) {
          return
        }
        var self = this;
        var filters = [];
        products.forEach(function(product) {
          product.filter_groups.forEach(function(group) {
            var index;
            var existingFilter = filters.find(function(item, i) {
              index = i;
              return item.name === group.name;
            });
            if(existingFilter) {
              filters[index].values = self._mergeArrays(existingFilter.values, group.values);
            } else {
              filters.push(group);
            }
          })
        });
        return filters;
      },

      /**
       * helperMethod
       * @name _mergeArrays
       * @description this method will merge 2 arrays
       * @param array1 - Array
       * @param array2 - Array
       */
      _mergeArrays: function(array1, array2) {
        //check if item exists else filter it before merging arrays
        return array1.concat(array2.filter(function(item, index) {
            var exists = false;
            array1.forEach(function(oldItem) {
              if (oldItem.value === item.value) {
                exists = true;
              }
            });
            return !exists;
        }));
      }

    });

  </script>

</dom-module>
