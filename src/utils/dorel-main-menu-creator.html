<link rel="import" href="./dorel-magento-collect-products-by-category.html">
<link rel="import" href="./dorel-wp-collect-page.html">

<dom-module id="dorel-main-menu-creator">
  <template>

    <dorel-magento-collect-products-by-category
      app-cache="[[ appCache ]]"
      id="products">
    </dorel-magento-collect-products-by-category>

    <dorel-wp-collect-page
      pages="[[ pages ]]"
      app-cache="[[ appCache ]]"
      id="collectPageEl">
    </dorel-wp-collect-page>

  </template>

  <script>
  class DorelMainMenuCreator extends ReduxMixin(Polymer.Element) {
    static get is() {
      return 'dorel-main-menu-creator';
    }

    static get properties() {
      return {

        /**
         * @attribute
         * @name appCache
         * @description pages
         */
        appCache: {
          type: Object
        },

        /**
         * @attribute
         * @name pages
         * @description pages
         */
        pages: {
          type: Array,
          statePath: 'pages'
        }
      }
    }
    static get observers () {
      return [
      '_createMenuDataModel(appCache.collect.options.main_menu)'
      ]
    }

    ready () {
      super.ready()
      this.addEventListener('newProducts', this._setMenuProducts);
    }

    _createMenuDataModel(mainMenu) {
      if(!mainMenu) {
        return;
      }
      new Promise((resolve, reject) => {
        resolve(this._createLinks(mainMenu));
      }).then(mainMenu => {
        return this.dispatch('addMenu', mainMenu);
      });
    }

    async _createLinks(menuItems) {
      const promises = menuItems.map((item) => {
        return new Promise((resolve, reject) => {
          resolve(this.$.collectPageEl.getPageById(item.page_object.ID));
        }).then((page) => {
          return this._createMenuItem(item, page);
        });
      });
      const links = await Promise.all(promises);
      return links;
    }

   async _createMenuItem(item, page) {
      item.id = page.id;
      item.link = this.cleanUrlToPath(page.link);
      item.opened = false;
      if(item.dropdown === true && item.dropdown_items && item.dropdown_items.length) {
        const promises = item.dropdown_items.map((_item) => {
          return new Promise((resolve, reject) => {
            resolve(this.$.collectPageEl.getPageById(_item.page_object.ID));
          }).then((page) => {
            return this._createMenuItem(_item, page);
          });
        });
        const dropdown_items = await Promise.all(promises);
        item.dropdown_items = dropdown_items;
      } else {
        item.dropdown_items = [];
      }
      if(item.dropdown_type === 'category') {
        let sub_category_items = await this._getSubCategoryItems(page);
        item.category_id = this._getMagentoCategoryId(page);
        item.sub_category_items = sub_category_items;
      }
      return Object.assign({}, item);
    }

    async _getSubCategoryItems(page) {
      let allChildPages = await this.$.collectPageEl.getChildrenByParentId(page.id);
      const childPages = allChildPages.map(page => {
        return this._getCategorySubMenuItems(page)
      });
      if(!childPages || childPages.length < 2) {
        var category = this._getMagentoCategoryId(page);
        this.$.products.getProducts(category, this.get('appCache.currentLanguage'));
      } else {
        return childPages;
      }
    }

    _getCategorySubMenuItems(page) {
      if(!page) {
        return {};
      }
      return {
        id: page.id,
        link: this.cleanUrlToPath(page.link),
        thumbnail: page.acf && page.acf.hero_header && page.acf.hero_header.length && page.acf.hero_header[0].bynder_background_image ? page.acf.hero_header[0].bynder_background_image : null,
        title: page.title.rendered
      };
    }

    _getMagentoCategoryId(page) {
      return Number(page.acf.magento_category_picker);
    }

    _setMenuProducts(value) {
      const allProducts = value.detail.products;
      if(!allProducts.length) {
        return;
      }
      // limit products in menu to 5
      const products = allProducts.filter((product, index) => {
        return index <= 4
      });

      var category = value.detail.category;
      // create a new mainMenu and append
      var oldMenu = this.getState().menu.items || [];
      var mainMenu = oldMenu.map(function(menuItem) {
        if(menuItem.category_id === category) {
          menuItem.sub_category_items = products.map(function(product) {
            var newItem = {
              id: Number(product.id),
              link: menuItem.link + product.url,
              thumbnail_url: product.child_products[0].images.image,
              title: product.name ? product.name.value : '',
              sub_title: product.header_section.sub_title
            }
            return newItem;
          });
        }
        return Object.assign({}, menuItem);
      });
      this.dispatch('addMenu', mainMenu);
    }

    cleanUrlToPath(url) {
      const urlArray = url.split('/');
      const path = '/' + urlArray.slice(3).join('/');
      return path;
    }
  };
    customElements.define(DorelMainMenuCreator.is, DorelMainMenuCreator);

  </script>
</dom-module>
