<link rel="import" href="./collects/dorel-wp-collect-page.html">

<dom-module id="dorel-main-menu-creator">
  <template>

    <dorel-wp-collect-page
      pages="[[ pages ]]"
      id="collectPageEl">
    </dorel-wp-collect-page>

  </template>

  <script>
  class DorelMainMenuCreator extends ReduxMixin(Polymer.Element) {
    static get is() {
      return 'dorel-main-menu-creator';
    }

    static get properties() {
      return {

        /**
         * @attribute
         * @name pages
         * @description pages
         */
        pages: {
          type: Array,
          statePath: 'pages'
        },

        /**
         * @attribute
         * @name currentLanguage
         * @description the currentLanguage from the redux state
         */
        currentLanguage: {
          type: Object,
          statePath: 'route.currentLanguage'
        },

        /**
         * @attribute
         * @name mainMenuOptions
         * @description the menu items from the initial options
         * with this data the menu is generated
         */
        mainMenuOptions: {
          type: Array,
          statePath: 'config.main_menu'
        }
      }
    }
    static get observers () {
      return [
      '_createMenuDataModel(mainMenuOptions)'
      ]
    }

    _createMenuDataModel(mainMenu) {
      if(!mainMenu) {
        return;
      }
      new Promise((resolve, reject) => {
        resolve(this._createLinks(mainMenu));
      }).then(mainMenu => {
        return this.dispatch('addMenu', mainMenu);
      });
    }

    async _createLinks(menuItems) {
      const promises = menuItems.map((item) => {
        return new Promise((resolve, reject) => {
          resolve(this.$.collectPageEl.getPageById(item.page_object.ID));
        }).then((page) => {
          return this._createMenuItem(item, page);
        });
      });
      const links = await Promise.all(promises);
      return links;
    }

   async _createMenuItem(item, page) {
      item.id = page.id;
      item.link = this.cleanUrlToPath(page.link);
      item.opened = false;
      if(item.dropdown === true && item.dropdown_items && item.dropdown_items.length) {
        const promises = item.dropdown_items.map((_item) => {
          return new Promise((resolve, reject) => {
            resolve(this.$.collectPageEl.getPageById(_item.page_object.ID));
          }).then((page) => {
            return this._createMenuItem(_item, page);
          });
        });
        const dropdown_items = await Promise.all(promises);
        item.dropdown_items = dropdown_items;
      } else {
        item.dropdown_items = [];
      }
      if(item.dropdown_type === 'category') {
        let sub_category_items = await this._getSubCategoryItems(page);
        if(sub_category_items && sub_category_items.length < 2) {
          item.productSwitch = true;
          if (this._getMagentoCategoryId(page)) {
            this.dispatch('requestProductsByCategory', this._getMagentoCategoryId(page));
          }
        }
        item.category_id = this._getMagentoCategoryId(page);
        item.sub_category_items = sub_category_items;
      }
      return Object.assign({}, item);
    }

    async _getSubCategoryItems(page) {
      let allChildPages = await this.$.collectPageEl.getChildrenByParentId(page.id);
      return allChildPages.map(page => {
        return this._getCategorySubMenuItems(page);
      });
    }

    _getCategorySubMenuItems(page) {
      if(!page) {
        return {};
      }
      return {
        id: page.id,
        link: this.cleanUrlToPath(page.link),
        thumbnail: page.acf && page.acf.hero_header && page.acf.hero_header.length && page.acf.hero_header[0].bynder_background_image ? page.acf.hero_header[0].bynder_background_image : null,
        title: page.title.rendered
      };
    }

    _getMagentoCategoryId(page) {
      if(!page.acf.magento_category_picker) return;
      return Number(page.acf.magento_category_picker);
    }

    cleanUrlToPath(url) {
      const urlArray = url.split('/');
      const path = '/' + urlArray.slice(3).join('/');
      return path;
    }
  };
  customElements.define(DorelMainMenuCreator.is, DorelMainMenuCreator);

  </script>
</dom-module>
