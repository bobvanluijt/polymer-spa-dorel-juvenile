<dom-module id="dorel-magento-collect-products-by-category">
  <template>

    <iron-ajax
      id="products"
      content-type="application/json"
      method="get"
      handle-as="json"
      on-response="_productResponse"></iron-ajax>


  </template>

  <script>
    Polymer({
      is: 'dorel-magento-collect-products-by-category',

      properties: {

        /**
         * @name category
         * @description this category is inherit by the parent and
         * will be used in the filter for the call to the magento end-point
         */
        category: {
          type: Number,
          value: 0
        },

        productCategory: {
          type: Number
        },

        products: {
          type: Array,
          notify: true
        },

        retrievingProducts: {
          type: Boolean,
          notify: true
        },

        appCache: {
          type: Object,
        },

        currentLanguage: {
          type: Object,
        }


      },

      observers: [
        '_categoryChanged(category, appCache.currentLanguage)'
      ],

      /**
       * @name _categoryChanged
       * @description will be called by observer;
       * @param category - Number
       */
      _categoryChanged: function(category, currentLanguage) {
        // if category is empty we can't make the call return
        if(!category || !currentLanguage) {
          return;
        }
        this.getProducts(category);
      },

      /**
       * @name getProducts
       * @description will be called by observert;
       * @param category - Number
       */
      getProducts: function(category) {
        // if category is empty we can't make the call return

        if(!category) {
          return;
        }

        this.set('productCategory', category);

        this.set('retrievingProducts', true);

        // get all the products that are saved in the global
        var products = this.get('appCache.product.products') || [];

        // get all the categories that are already retrieved
        var retrievedCategories = this.get('appCache.product.retrievedCategories') || [];

        //if category is already in the retrieved categories
        if(retrievedCategories.indexOf(parseInt(category)) > -1){
          // filter out products that have a other category
          var currentProducts = products.filter(function(item) {
              return item.categories.indexOf(parseInt(category)) > -1;
          });
          // set current products
          return this._setCurrentProducts(currentProducts);
        } else {
          // else retreive the products by category that is not in the saved retrieved categories
          return this._getProductsByCategory(category);
        }
      },
      /**
       * @name _getProductsByCategory
       * @description set correct end-point and make call to end-point to retreive products by category
       * @param category - Number
       */
      _getProductsByCategory: function(category) {
        var productsEl = this.$.products;
        var currentLanguageCode = this.get('appCache.currentLanguage.languageCode');
        productsEl.url = CONFIG.ECOM_URL + '/rest/V1/dorel/category/' +
        category + '/product' + '?language=' + currentLanguageCode;
        productsEl.generateRequest();
      },

      /**
       * @name _productResponse
       * @description response of the _getProductsByCategory call;
       * @param response
       */
      _productResponse: function(response) {

        // set category variable
        var category = this.get('productCategory');

        //add category to list to keep count of what categories are retrieved
        this._addCategoryToretrievedCategories(category);

        //set products from response
        var newProducts = response.detail.response;

        //if there are no products in response early return
        if(!newProducts || !newProducts.length) {
          // set empty Array so parent will reset the products
          return this._setCurrentProducts([]);
        } else {
          this._setProducts(newProducts);
        }


      },

      /**
       * @name _setProducts
       * @description will merge the old and new products and remove the duplicates and set the global products
       * @param newProducts - Array
       */
      _setProducts: function(newProducts) {
        //set the current products
        this._setCurrentProducts(newProducts);

        //get all the "cached" products
        var oldProducts = this.get('appCache.product.products') || [];

        //check if item exists else filter it before merging arrays (oldProducts / newProducts)
        var products = this._mergeArrays(oldProducts, newProducts);

        // set new array of products in the global saved products
        this.fire('setAppCache', { value: products, path: 'product.products' });
      },

      /**
       * @name _setCurrentProducts
       * @description this method will set global current products;
       * @param products - Array
       */
      _setCurrentProducts: function(products) {
        this.set('products', products);
        this.set('retrievingProducts', false);
        this.fire('newProducts', { products: products, category: this.get('productCategory') });
      },

      /**
       * @name _mergeArrays
       * @description this method will merge 2 arrays of products
       * @param array1 - Array
       * @param array2 - Array
       */
      _mergeArrays: function(array1, array2) {
        //check if item exists else filter it before merging arrays (oldProducts / newProducts)
        return array1.concat(array2.filter(function (item, index) {
            var exists = false;
            array1.forEach(function (oldItem) {
              if (oldItem.id === item.id) {
                exists = true;
                // add new category to oldItem
                oldItem.categories.push(item.categories[0]);
              }
            });
            return !exists;
        }));
      },

      /**
       * @name _addCategoryToretrievedCategories
       * @description this method will handle global retrievedCategories to keep track on what categories are already retrieved;
       * @param category - Number
       */
      _addCategoryToretrievedCategories: function(category) {
        //get retrieved categories
        var retrievedCategories = this.get('appCache.product.retrievedCategories') || [];

        //check if it does not exists
        if(retrievedCategories.indexOf(category) < 0) {
          //add current category
          retrievedCategories.push(category);
        }

        //set global categories to keep track on what categories are already retrieved
        this.fire('setAppCache', { value: retrievedCategories, path: 'product.retrievedCategories' });
      }
    });
  </script>
</dom-module>
