<link rel="import" href="dorel-product-data-model.html">
<link rel="import" href="dorel-magento-auth.html">
<link rel="import" href="dorel-product-color-map.html">

<dom-module id="dorel-magento-collect-related-product">
  <template>

    <dorel-product-data-model
      id="transform"
      color-map="[[ colorMap ]]"></dorel-product-data-model>

    <dorel-magento-auth id="auth" token="{{ token }}"></dorel-magento-auth>

    <dorel-product-color-map
      color-map="{{ colorMap }}"
      token="[[ token ]]"></dorel-product-color-map>

    <iron-ajax
      id="childProducts"
      content-type="application/json"
      method="get"
      input="1"
      handle-as="json"></iron-ajax>

    <iron-ajax
      id="relatedProducts"
      content-type="application/json"
      method="get"
      input="1"
      on-response="_productResponse"
      handle-as="json"></iron-ajax>

  </template>

  <script>
    Polymer({
      is: 'dorel-magento-collect-related-product',

      properties: {

        /**
         * @name category
         * @description category will be send by parent
         * will be used in to build up the filter in the api call
         */
        category: {
          type: Number,
          value: 0
        },

        /**
         * @name productNames
         * @description productNames will be send by parent
         * will be used in to build up the filter in the api call
         */
        productNames: {
          type: Array
        },

        /**
         * @name token
         * @description will be retrieved by the globalsManager
         * auth token will be used in the headers of api call
         */
        token: {
          type: String,
          value: ''
        },

        /**
         * @name colorMap
         * @description will be retrieved by the globalsManager
         * will be used the get the correct value for colors and colorNames
         */
        colorMap: {
          type: Array,
          value: []
        },

        /**
         * @name relatedProducts
         * @description will be set and used by the parent
         */
        relatedProducts: {
          type: Object,
          notify: true,
          value: {
            accessories: []
          }
        },

        /**
         * @name retrievingRelatedProducts
         * @description will be used to not make unnessary calls and used a loading indicator
         */
        retrievingRelatedProducts: {
          type: Boolean,
          value: false,
          notify: true
        },

        /**
         * @name existingProducts
         * @description a Array that can contain products that are already retrieved
         */
        existingProducts: {
          type: Array,
          value: []
        }

      },

      observers: [
        '_getRelatedProducts(category, productNames, token, colorMap)'
      ],

      /**
       * @name getRelatedProducts
       * @description will be called by observer if category changes by parent
       * @param category - Number
       * @param productNames - String
       */
      _getRelatedProducts: function(category, productNames, token, colorMap) {
        // if loading is true early return
        if(this.retrievingRelatedProducts) {
          return;
        }

        // if token does not exists we can't make the call so return retrieveToken
        if(!token) {
           return this.$.auth.retrieveToken();
        }

        // if category or productNames does not exists we can't make the call so return
        if(!category || !productNames || !colorMap.length) {
          return;
        }

        // get the current products
        var products = Polymer.globalsManager.get('Dorel.product.products') || [];

        // set category that will be used in _productResponse
        this.category = category;

        // reset the existingProducts to a empty Array
        this.existingProducts = [];

        var self = this;

        // set loading to true so it won't make unnessary multiple calls
        this.retrievingRelatedProducts = true;

        // check if the products in productsNames already are in the saved products
        products.forEach(function(product) {
          // if the url of a product is in the Array of the productNames
          if(productNames.indexOf(product.url) > -1) {
            // Add this product to the existingProducts Array
            self.existingProducts.push(product);
            // Remove the name from the productNames
            productNames = productNames.filter(function(name){
              return name !== product.url;
            });
          }
        });

        // if the productNames are empty because of the filter it means
        // that all the products are already in saved in the globalsManager
        if(!productNames || !productNames.length) {
          // set relatedProducts
          return this._setCurrentRelatedProduct(this.existingProducts);
        } else {
          // else continue to get the remaining products in the productNames
          return this._getProduct(productNames);
        }
      },

      /**
       * @name _getProduct
       * @description set correct end-point and make call to end-point to retreive products by category
       * @param category - Number
       */
      _getProduct: function(productNames) {
        // select the iron-ajax element
        var relatedProductsEl = this.$.relatedProducts;
        // set header with the token
        relatedProductsEl.headers = {Authorization: 'Bearer ' + this.token};

        // set the first segment of the end-point with a filter
        var firstSegment = CONFIG.ECOM_URL + '/rest/V1/products?' +
        '&searchCriteria[filter_groups][1][filters][0][field]=visibility' +
        '&searchCriteria[filter_groups][1][filters][0][value]=4';
        // create a empty array that will be filled with all the parts of the api call
        var endPoint = [];
        // add the firstSegment to the endPoint array
        endPoint.push(firstSegment);

        // set the default filterIndex, filterIndex will be used to increment for every filter that is added to the endPoint
        var filterIndex = 0;
        // for every productName add a filter to the endPoint Array
        productNames.forEach(function(sku, index) {
          // set segment filter with the filterIndex and the sku
          var segment = '&searchCriteria[filter_groups][1][filters][' + filterIndex + '][field]=sku' +
                        '&searchCriteria[filter_groups][1][filters]['+ filterIndex +'][value]=' + sku;
          // add the segment to the endPoint
          endPoint.push(segment);
          // add + 1 to the filterIndex for the next segment
          filterIndex = filterIndex + 1;
        });
        // convert the Array to a string
        endPoint = endPoint.join('');
        // set the url with the endPoint
        relatedProductsEl.url = endPoint;
        // make the call
        return relatedProductsEl.generateRequest();
      },

      /**
       * @name _productResponse
       * @description response of the _getProduct call;
       * @param response
       */
      _productResponse: function(response) {

        //set products from response
        var newProducts = response.detail.response.items;

        //if there are no products in response early return
        if(!newProducts) {
          this.relatedProducts = {
            accessories: []
          }
          return;
        }

        // refer to this
        var self = this;

        // Map the newProducts the childProducts can be retrieved and added to the product
        Promise.all(newProducts.map(function(product) {
          // every product will return function with a new promise from iron-ajax
          return self._getChildProducts(product.sku).then(function(data) {
              var childProducts = data.response;
              // create new data model for product and return this to array
              return self.$.transform.createDataModelProduct(product, this.category, childProducts);
          });
        })).then(function(products) {
            // if the existingProducts Array contain products
            if(self.existingProducts.length) {
              // merge the existingProducts with the new retrieved products and set the relatedProducts
              var mergedProducts = self._mergeArrays(products, self.existingProducts);
              self._setCurrentRelatedProduct(mergedProducts);
            } else {
              // set the relatedProducts with the new retrieved products
              self._setCurrentRelatedProduct(products);
            }
            // call setProducts with the products
            self._setProducts(products);
        });
      },

      /**
       * @name _setProducts
       * @description will merge the old and new products and remove the duplicates and set the global products
       * @param newProducts - Array
       */
      _setProducts: function(newProducts) {
        //get all the "cached" products
        var oldProducts = Polymer.globalsManager.get('Dorel.product.products') || [];

        // merge the oldProducts and the new products
        var products = this._mergeArrays(oldProducts, newProducts);

        // set the globalsManager with the merged products
        Polymer.globalsManager.set('Dorel.product.products', products);
      },

      /**
       * @name _getChildProducts
       * @description this method call the magento end-point to retreive all the child products of the main product with the given `Id`
       * @param id - String
       */
      _getChildProducts: function(id) {
        var token = Polymer.globalsManager.get('Dorel.product.auth.token');
        var childProductsEl = this.$.childProducts;
        childProductsEl.headers = {Authorization: 'Bearer ' + token};
        childProductsEl.url = CONFIG.ECOM_URL + '/rest/V1/configurable-products/' +
        id + '/children';

        return childProductsEl.generateRequest().completes;
      },

      /**
       * @name _setCurrentRelatedProduct
       * @description this method will set global current product;
       * @param product - Array
       */
      _setCurrentRelatedProduct: function(products) {
        // get the order of the Array productNames
        var order = this.productNames;
        // set the products in the correct order
        products = this._mapOrder(products, order, 'url');
        // set this.relatedProducts (this will passed to parent)
        this.relatedProducts = {
          accessories: products
        }
        // set loading false so getRelatedProducts can be called again
        this.retrievingRelatedProducts = false;
      },

      _mergeArrays: function(array1, array2) {
        //check if item exists else filter it before merging arrays (oldProducts / newProducts)
        return array1.concat(array2.filter(function (item, index) {
            var exists = false;
            array1.forEach(function (oldItem) {
              if (oldItem.id === item.id) {
                exists = true;
              }
            });
            return !exists;
        }));
      },

      /**
       * @name _mapOrder
       * @description this method will sort the array with a order array
       * @param id - String
       */
      _mapOrder: function(array, order, key) {
        return array.sort(function (a, b) {
          if (order.indexOf(a[key]) > order.indexOf(b[key])) {
            return -1;
          }
          if(order.indexOf(b[key]) > order.indexOf(a[key])) {
            return 1;
          }
          return 0;
        });
      }
    });
  </script>
</dom-module>
