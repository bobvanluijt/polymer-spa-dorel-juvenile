<dom-module id="dorel-magento-collect-custom-data">
  <template>

    <iron-ajax
      id="collect"
      content-type="application/json"
      method="get"
      input="1"
      on-response="_response"
      handle-as="json"></iron-ajax>
  </template>

  <script>
    Polymer({
      is: 'dorel-magento-collect-custom-data',

      properties: {

        /**
         * @name data
         * @description this data will be generated by the component and
         * send up to the parent component
         */
        data: {
          type: Object,
          notify: true,
          value: {}
        },

        /**
         * @name productId
         * @description this id of the product
         * inherited by the parent
         */
        productId: {
          type: String,
          value: ''
        },


        /**
         * @name type
         * @description type is used to define what content the component is retrieving
         */
        type: {
          type: String
        },

        /**
         * @attribute
         * @name appCache
         * @description the temporary cache of the application,
         * contains data that used to be contained by the globalsManager
         */
        appCache: {
          type: Object
        },

      },

      observers: [
        '_get(productId, type)'
      ],

       /**
        * observer
        * @name _get
        * @description will be called by observer and either get the data from the globals
        * or retrieve it from magento
        * @param productId - String
        * @param type - String
       */
      _get: function(productId, type) {

        if(!productId || !type) {
          return;
        }

        var existing = this.get('appCache.product.attributes.' + type) || [];

        if(existing.length) {
          var item = existing.find(function(_item) {
            return _item.product_id === productId;
          });
        }

        if(item) {
          this.data = item;
        } else {
          this._retrieveData(productId, type);
        }

      },

      /**
       * @name _retrieveData
       * @description uses a mapping to get the right end-point based on the type and productId
       * will generate the request to a magento end-point
       * @param productId - String
       * @param type - String
      */
      _retrieveData: function(productId, type) {
        var collectProductEl = this.$.collect;

        var urlMap = {
          usps: '/rest/V1/dorel-uspbuilder/usplist?product_id=',
          features: '/rest/V1/dorel-featurebuilder/featurelist?product_id=',
          accordions: '/rest/V1/dorel-accordionbuilder/accordionlist?product_id='
        };

        if(urlMap[type]) {
          // set the url with the endPoint
          collectProductEl.url = CONFIG.ECOM_URL + urlMap[type] + productId;
          // make the call
          return collectProductEl.generateRequest();
        }
      },

      /**
       * @name _response
       * @description the response of a call to a magento endpoint
       * will set the productId on the data and call _setData
       * @param response - Object
      */
      _response: function(response) {
        var data = response.detail.response[0];
        data.product_id = this.productId;
        this.set('data', data);
        this._setData(data);
      },

      /**
       * @name _setData
       * @description set the data to the global manager
       * @param newData - Object
      */
      _setData: function(newData) {
        var existingData = this.get('appCache.product.attributes.' + this.type) || [];
        var data = this._mergeArrays(existingData, [newData]);

        this.fire('setAppCache', { value: data, path: 'product.attributes.' + this.type });
      },

      /**
       * helperMethod
       * @name _mergeArrays
       * @description this method will merge 2 arrays
       * @param array1 - Array
       * @param array2 - Array
       */
      _mergeArrays: function(array1, array2) {
        //check if item exists else filter it before merging arrays (oldProducts / newProducts)
        return array1.concat(array2.filter(function (item, index) {
            var exists = false;
            array1.forEach(function (oldItem) {
              if (oldItem.product_id === item.product_id) {
                exists = true;
              }
            });
            return !exists;
        }));
      }

    });
  </script>
</dom-module>
