<dom-module id="dorel-wp-collect-page">
  <template>
    <iron-ajax
      id="page"
      url="[[ wpUrl ]]/wp/v2/pages?slug=[[ pageSlug ]]" 
      handle-as="json"
      on-response="_pageLoaded"></iron-ajax>
  </template>

  <script>
    Polymer({
      is: 'dorel-wp-collect-page',
      
      properties: {

        /**
         * `pageSlug` the slug of the page (last segment of the url), as
         * defined by the dorel-app routing
         */
        pageSlug: {
          type: String,
          observer: '_retrievePage'
        },

        /**
         * `wpUrl` of the url of the Wordpress instance
         */
        wpUrl: {
          type: String
        }

      },

      _retrievePage: function(newVal, oldVal) {
        if (typeof newVal === 'undefined' || newVal === oldVal) return;

        // switch(newVal) {
        //   // home is eagerly loaded
        //   case 'products':
        //     newVal = this._getLastUrlSegment(document.URL);
        //   break;

        //   default:
        //     newVal = newVal;
        //   break;
        // }

        var pageEl = this.$.page;

         // do the products call
        pageEl.generateRequest();
      },

      _pageLoaded: function(data) {

        var response = data.detail.response;
        var page = response[0];

        // alter the template, strip 'page-' prefix
        var template = page.template.slice(0, -4);
        var pageName = template.replace('page-','');

        // set pageObjects template property
        page.template = pageName;

        // to retrieve the menu use Polymer.globalsManager.get('Dorel');
        Polymer.globalsManager.set('Dorel.current.page', page);

        // import the footer after the currentPage is loaded
        this.importHref(this.resolveUrl('../organisms/dorel-footer.html'), null, null, true);
      },

      _getLastUrlSegment: function(url) {
        var urlArr = document.URL.split('/');
        var cleanedArr = urlArr.clean('');

        newVal = urlArr[urlArr.length-1];

        console.log(urlArr, cleanedArr);
      }
    });
  </script>
</dom-module>
