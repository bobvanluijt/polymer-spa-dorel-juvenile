<dom-module id="dorel-main-routing">
  <script>
    Polymer({
      is: 'dorel-main-routing',

      properties: {
        /**
         * `appCache` the application cache
         */
        appCache: {
          type: Object
        },

        /**
         * @name route
         * @description defines the current route
         */
        route: {
          type: Object
        },

        /**
         * @name currentPage
         * @description the currentPage will be used to select page
         */
        currentPage: {
          type: Object,
          notify: true
        },

        /**
         * @name categoryPage
         * @description will be used for setting the category
         */
        categoryPage: {
          type: Object,
          notify: true
        },

        /**
         * @name previousStates
         * @description will remember up to 5 previous states of the application
         */
        previousStates: {
          type: Array,
          notify: true,
          value: []
        }

      },

      observers: [
        '_routePageChanged(route, appCache.collect.pages)',
        '_currentRouteChanged(route)'
      ],

      /**
       * @observer
       * @name _routePageChanged
       * @description on url/route change get the first segment of the url
       * then set it as the page. With those settings start the setCurrentPage
       * which will change the iron-pages selected
       *
       * @param page - String - the route page string
       * @param pages - Array - all the retrieved pages from WP
       */
      _routePageChanged: function (route, pages) {
        // if the route is undefined
        if (typeof route === 'undefined' || typeof pages === 'undefined' || !pages.length) return;

        // if url is only root add default language in url segment
        if(!route.path.length || !route.path.split('/').join('').length) {
          return window.location.href = window.location + CONFIG.LOCALE.CODE;
        }

        // Matches the page to the component guide template
        if (route.path.indexOf('component-guide') === 1) {
          this.currentPage = {
            template: 'component-guide'
          };
          // break
          return;
        }

        var pathArray = route.path.split('/').filter(function(item) {
          return item && item.length;
        });


        // get the a clean last segment of the route.path
        lastSegment = route.path.match(/([^\/]*)\/*$/).pop();


        // refer to this for find function
        var self = this;

        /**
         * if last segment is undefined or empty string set to home,
         * all others to segment
         */
        if(pathArray.length === 1) {
         this.set('page', 'home');
        } else {
         this.set('page', lastSegment || 'home');
        }

        var url = (window.location.origin + this.route.path);
        var fullUrl = url.slice(-1) === '/' ? url : url + '/';

        var currentPage = pages.find(function(item) {
          return item.link === fullUrl || item.slug === 'home' && self.page === 'home';
        });

        this.set('currentPage', currentPage);

        var last = this.currentPage ? '' : lastSegment;

        var parent = pages.find(function (_page) {
          return self._compareUrls(_page.link, route.path, last);
        });

        if (!this.currentPage && route.path && route.path.length) {
          if (!parent) {
            return this._setPageNotFound();
          }

          var productDetailTemplate = parent.acf.detail_template_selector;

          if (!productDetailTemplate) {
            return this._setPageNotFound();
          } else {
            this.currentPage = {
              template: productDetailTemplate
            };
          }

          this._setCategoryPage(parent);

        } else {
          this._setCategoryPage(parent);
        }

        // when the page cannot be matched, it is always the 404
        if (typeof this.currentPage === 'undefined') {
          this._setPageNotFound();
        }
      },

      /**
       * @name _setPageNotFound
       * @description set the currentPage to a 404 page
       */
      _setPageNotFound: function () {
        // set the page to 404
        this.page = '404';

        // set the currentPage to 404
        this.currentPage = {
          template: '404',
          acf: {
            meta_title: '404',
            meta_description: '404 - This page does not exist'
          }
        };
      },

      /**
       * @name _setCategoryPage
       * @description set the categoryPage so it will be passed to the parent
       */
      _setCategoryPage: function (categoryPage) {
        this.set('categoryPage', categoryPage);
      },

      _currentRouteChanged: function(route) {
        var previousStates = this.get('previousStates');
        if(previousStates.length >= 5) {
          this.splice('previousStates', -1 ,1);
        }
        this.unshift('previousStates', route);
        var previousState = previousStates[1] || { path: '/' };

        this.fire('appCache', {
          path: 'previousState',
          value: previousState
        });
      },

      /**
       * @name _compareUrls
       * @description return a Boolean if the url + lastSegment and routePath matches;
       */
      _compareUrls: function (url, routePath, lastSegment) {
        url = this._cleanString(url + lastSegment);
        routePath = this._cleanString(window.location.origin + routePath);
        return Boolean(url === routePath);
      },

      _cleanString: function (string) {
        string = this._stripQueryStringAndHashFromPath(string);
        return string.replace(/[\/\[\]\&]+|/g, '');
      },

      _stripQueryStringAndHashFromPath: function(url) {
        return url.split("?")[0].split("#")[0];
      }
    });
  </script>
</dom-module>
