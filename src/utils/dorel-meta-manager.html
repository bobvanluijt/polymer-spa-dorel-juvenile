<dom-module id="dorel-meta-manager">
  <script>
    Polymer({
      is: 'dorel-meta-manager',

      properties: {

        /**
         * @name brandName
         * @description defines the current brand
         */
        brandName: {
          type: String
        },

        currentPage: {
          type: Object
        },

        /**
         * @attribute
         * @name appCache
         * @description the temporary cache of the application,
         * contains data that used to be contained by the globalsManager
         */
        appCache: {
          type: Object
        }

      },

      observers: [
        '_setPageMetaData(currentPage)',
        '_productMetaData(appCache.current.product)'
      ],

      _setPageMetaData: function(currentPage) {
        if (!currentPage || !currentPage.acf) {
          return;
        }
        this.addMetaData(currentPage.acf)
      },
      /**
       * @name addMetaData
       * @description adds the right seo meta data
       */
      addMetaData: function(metaData) {

        // add the page's title
        if (typeof metaData.meta_title !== 'undefined' && metaData.meta_title.length) {
          document.title = this._defineMetaTitle(metaData.meta_title);
        }

        // add the page's description
        if (typeof metaData.meta_description !== 'undefined' && metaData.meta_title.length) {
          var metaDesc = document.createElement('meta');
          metaDesc.name = 'description';
          metaDesc.content = metaData.meta_description;
          document.getElementsByTagName('head')[0].appendChild(metaDesc);
        }

        // add the meta locale tags
        if (typeof CONFIG.LOCALE !== 'undefined') {

          // add the meta http-equiv language
          if (typeof CONFIG.LOCALE.LANGUAGE !== 'undefined') {
            this._addMetaEquiv('language', CONFIG.LOCALE.LANGUAGE);
          }

          // add the meta http-equiv country
          if (typeof CONFIG.LOCALE.COUNTRY !== 'undefined') {
            this._addMetaEquiv('country', CONFIG.LOCALE.COUNTRY);
          }

          // add the meta http-equiv content-language
          if (typeof CONFIG.LOCALE.LANG_CONTENT !== 'undefined') {
            this._addMetaEquiv('content-language', CONFIG.LOCALE.LANG_CONTENT);

            // add the meta alternate link
            if (typeof CONFIG.LOCALE.LINK_ALT !== 'undefined') {
              var link = document.createElement('link');
              link.rel = 'alternate';
              link.hreflang = CONFIG.LOCALE.LANG_CONTENT;
              link.href = CONFIG.LOCALE.LINK_ALT;
              document.getElementsByTagName('head')[0].appendChild(link);
            }
          }
        }
      },

      /**
       * @helper
       * @name _defineMetaTitle
       * @description defines the meta tile prefix and suffix
       * @param String | null
       */
      _defineMetaTitle: function (titleSuffix) {
        var configBrand = this.brandName || Polymer.globalsManager.get('Dorel.current.brandName');

        // replace every dash with a space
        var titlePrefix = configBrand.replace(/-/g, ' ');

        // capitalize every new word
        titlePrefix = titlePrefix.replace(/\b\w/g, function (l) {
          return l.toUpperCase()
        })

        // check if the suffix is an
        titleSuffix = (titleSuffix === null) ?
          '' : ' - ' + titleSuffix;

        // merge the title prefix and suffix and separate by dash
        return titlePrefix.concat(titleSuffix);
      },

      /**
       * @helper
       * @name _addMetaEquiv
       * @description adds the meta http-equiv tag
       * @param String equiv, string is used to fill the http-equiv attribute
       * @param String content, string is used to fill the content attribute
       */
      _addMetaEquiv: function (equiv, content) {

        // create the meta tag
        var meta = document.createElement('meta');

        // add and set the value of the http-equiv attribute
        meta.setAttribute('http-equiv', equiv);

        // add and set the value of the content attribute
        meta.setAttribute('content', content);

        // add the meta tag to the head
        document.getElementsByTagName('head')[0].appendChild(meta);
      },

      _productMetaData: function(product) {
        //inital current.product is not set so it will return
        if(!product) {
          return;
        }
        // if product.meta_data exists use title or description else 404
        var metaData = {
          meta_title: product.meta_data ? product.meta_data.meta_title : '404',
          meta_description: product.meta_data ? product.meta_data.meta_description : '404 - The page does not exist'
        };
        this.addMetaData(metaData);
      }

    });
  </script>
</dom-module>
