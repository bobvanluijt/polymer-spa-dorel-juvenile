<dom-module id="dorel-product-data-model">
  <template>
  </template>

  <script>
    Polymer({
      is: 'dorel-product-data-model',
      properties: {

        colorMap: {
          type: Array
        }

      },

      /**
       * @name _createDataModelProduct
       * @description this method will create and return a new data model for a main product
       * @type helperMethod - purpose: create a data model that is more suitable then the one retrieved by magento
       * @param product - Object - a main product retrieved
       * @param category - Number - a number of the currert active category to keep reference (magento does not return category id)
       * @param children - Array - all the child products of the main product
       * current keys: sku, id, name, created_at, category, childProducts, description, url
       */
       createDataModelProduct: function(product, category, children) {
         if(!children.length) {
           children.push(product);
         }
         var childProducts = this._createDataModelChildProduct(children);
         var oldProductModel = product;

         var filterGroups = [];

         var colorGroup = {
           name: 'color',
           label: 'Colors',
           type: 'checkbox',
           option: 'match-some',
           values: []
         };

         var priceGroup = {
           name: 'price',
           label: 'Price',
           type: 'slider',
           option: 'match-some',
           values: []
         };

         var safetyGroup = {
           name: 'safety',
           label: 'Safety',
           type: 'checkbox',
           option: 'match-every',
           values: [
             { value: 'airbags' }
           ]
         }

         if(oldProductModel.name === 'Citi') {
           safetyGroup.values.push({ value: 'airprotect' }, { value: 'i-size' })
         }

         childProducts.forEach(function(childProduct) {
           var color = {
             value: childProduct.color_name, color: childProduct.color_code
           }
           colorGroup.values.push(color);
         });

         childProducts.forEach(function(childProduct) {
           var price = {
             value: childProduct.price
           }
           priceGroup.values.push(price);
         });

         filterGroups.push(colorGroup);
         filterGroups.push(priceGroup);
         filterGroups.push(safetyGroup);

         var product = {
           sku: oldProductModel.sku,
           id: oldProductModel.id,
           name: oldProductModel.name,
           created_at: oldProductModel.created_at,
           categories: [category],
           childProducts: childProducts,
           description: this._retrieveCustomAttribute(oldProductModel, 'description'),
           age: this._retrieveCustomAttribute(oldProductModel, 'age'),
           max_weight: this._retrieveCustomAttribute(oldProductModel, 'max_weight'),
           url: this._retrieveCustomAttribute(oldProductModel, 'url_key'),
           excerpt: this._retrieveCustomAttribute(oldProductModel, 'short_description'),
           video_section: {
             video_id: this._retrieveCustomAttribute(oldProductModel, 'video_id')
           },
           filter_groups: filterGroups,
           related_product_section: {
             title: this._retrieveCustomAttribute(oldProductModel, 'related_title'),
             included_products: this._retrieveCustomAttribute(oldProductModel, 'related_product_sku')
           },
           header_section: {
             title: this._retrieveCustomAttribute(oldProductModel, 'section_title'),
             sub_title: this._retrieveCustomAttribute(oldProductModel, 'section_sub_title'),
             background_image: this._getMediaUrl(this._retrieveCustomAttribute(oldProductModel, 'section_image'))
           },
           meta_data: {
             meta_title: this._retrieveCustomAttribute(oldProductModel, 'meta_title'),
             meta_description: this._retrieveCustomAttribute(oldProductModel, 'meta_description')
           }
         };

         if(oldProductModel.product_links && oldProductModel.product_links.length) {
           product.relatedProducts = this._getRelatedProducts(oldProductModel.product_links);
         }

        //  product.size = this._retrieveCustomAttribute(oldProductModel, 'size');
        //  product.pdf_manual_link = this._retrieveCustomAttribute(oldProductModel, 'pdf_manual_link');
        //  product.pdf_manual_link_text = this._retrieveCustomAttribute(oldProductModel, 'pdf_manual_link_text');
         return product;
      },

      /**
       * @name _createDataModelChildProduct
       * @description this method will create and return a new data model for a child product
       * @type helperMethod - purpose: create a data model that is more suitable then the one retrieved by magento
       * @param products - Array - all the child products of a main product
       * current keys: color_name, color_name, color_image
       */
      _createDataModelChildProduct: function(products) {
        var map = this.colorMap;
        var self = this;

        return products.map(function(product) {
          var oldProductModel = product;
          var product = {};

          if(map && map.length) {
            var color = map.find(function(item) {
              return item.value === self._retrieveCustomAttribute(oldProductModel, 'car_seat_color');
            });

            var test = oldProductModel.name === 'Citi-Black Raven' ? [
              { value: 'airbags' },
              { value: 'airprotect' },
              { value: 'i-size' }
            ] : [
              { value: 'airbags' }
            ]

           var filterGroups = [
             {
               name: 'color',
               label: 'Colors',
               type: 'checkbox',
               option: 'match-some',
               type: 'single',
               values: [
                 { value: color.label, color: color.swatchlabel }
               ]
             },
             {
               name: 'price',
               label: 'Price',
               type: 'slider',
               option: 'match-some',
               values: [
                 { value: oldProductModel.price }
               ]
             },
             {
               name: 'safety',
               label: 'Safety',
               type: 'checkbox',
               option: 'match-every',
               values: test
             }
           ];

            product.color_name = color ? color.label : 'Default';
            product.color = color ? color.label : 'Default';
            product.color_code = color ? color.swatchlabel : '#ffffff';
            product.price = oldProductModel.price;
            product.sku = oldProductModel.sku;
            product.filter_groups = filterGroups;

            if (product.color_code.length && product.color_code.substring(0, 1) !== '#') {
              product.color_code = '#' + product.color_code;
            }
          }

          product.color_image = self._getMediaUrl(self._retrieveCustomAttribute(oldProductModel, 'image'));
          return product;
        });
      },

      /**
       * @name _retrieveCustomAttribute
       * @description this method find a Object with the attributeKey in the custom_attributes Array and return the value;
       * @type helperMethod
       * @param product - Object
       * @param attributeKey - String
       */
      _retrieveCustomAttribute: function(product, attributeKey) {
        var attribute = product.custom_attributes.find(function(attribute) {
          return attribute.attribute_code === attributeKey;
        });
        return attribute ? attribute.value : '';
      },

      /**
       * @name _getMediaUrl
       * @description this method will return the end-point to retreive media or null if pathSegment is empty
       * @type helperMethod
       * @param pathSegment - string
       */
      _getMediaUrl: function(pathSegment) {
        return pathSegment ? CONFIG.ECOM_URL + '/media/catalog/product/' + pathSegment : null;
      },

      /**
       * @name _getRelatedProducts
       * @description this method will return a new sorted Array
       * @param productLinks_ - Array
       */
      _getRelatedProducts: function(productLinks_) {
        // filter out the productLinks.link_type that don't have the value related
        var productLinks = productLinks_.filter(function(item) {
          return item.link_type === 'related';
        });
        // if productsLinks contains objects
        if(productLinks.length) {
          // create a new array that will contain string value's of the relatedProducts sku's
          var relatedProducts = [];
          // sort the productLinks based on the position given by magento
          productLinks.sort(function (a, b) {
            if (a.position > b.position) {
              return -1;
            }
            if(b.position > a.position) {
              return 1;
            }
            return 0;
          }).forEach(function(item) {
            //  make sure all the sku's are lowcase and spaces are replaced with a `-`
            var sku = item.linked_product_sku.toLowerCase().split(' ').join('-');
            // push value to relatedProducts Array
            relatedProducts.push(sku);
          });
          // return the new Array
          return relatedProducts;
        } else {
          // else return a empty Array
          return [];
        }
      }

    });
  </script>
</dom-module>
