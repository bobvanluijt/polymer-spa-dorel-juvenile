<dom-module id="dorel-product-data-model">
  <template>
  </template>

  <script>
    Polymer({
      is: 'dorel-product-data-model',
      properties: {

        colorMap: {
          type: Array
        }

      },

      /**
       * @name _createDataModelProduct
       * @description this method will create and return a new data model for a main product
       * @type helperMethod - purpose: create a data model that is more suitable then the one retreived by magento
       * @param product - Object - a main product retreived
       * @param category - Number - a number of the currert active category to keep reference (magento does not return category id)
       * @param children - Array - all the child products of the main product
       * current keys: sku, id, name, created_at, category, childProducts, description, url
       */
       createDataModelProduct: function(product, category, children) {
         var childProducts = this._createDataModelChildProduct(children);
         var oldProductModel = product;
         var product = {
           sku: oldProductModel.sku,
           id: oldProductModel.id,
           name: oldProductModel.name,
           created_at: oldProductModel.created_at,
           category: category,
           childProducts: childProducts,
           description: this._retrieveCustomAttribute(oldProductModel, 'description'),
           age: this._retrieveCustomAttribute(oldProductModel, 'age'),
           max_weight: this._retrieveCustomAttribute(oldProductModel, 'max_weight'),
           url: this._retrieveCustomAttribute(oldProductModel, 'url_key'),
           excerpt: this._retrieveCustomAttribute(oldProductModel, 'short_description'),
           video_section: {
             video_id: this._retrieveCustomAttribute(oldProductModel, 'video_id')
           },
           header_section: {
             title: this._retrieveCustomAttribute(oldProductModel, 'section_title'),
             sub_title: this._retrieveCustomAttribute(oldProductModel, 'section_sub_title'),
             background_image: this._getMediaUrl(this._retrieveCustomAttribute(oldProductModel, 'section_image'))
           },
           meta_data: {
             meta_title: this._retrieveCustomAttribute(oldProductModel, 'meta_title'),
             meta_description: this._retrieveCustomAttribute(oldProductModel, 'meta_description')
           }
         };

         if(oldProductModel.product_links && oldProductModel.product_links.length) {
           var relatedProducts = oldProductModel.product_links.filter(function(item) {
             return item.link_type === 'related';
           });
           if(relatedProducts.length) {
             product.relatedProducts = [];
             relatedProducts.forEach(function(item) {
               product.relatedProducts.push(item.linked_product_sku);
             });
           }
         }

        //  product.size = this._retrieveCustomAttribute(oldProductModel, 'size');
        //  product.pdf_manual_link = this._retrieveCustomAttribute(oldProductModel, 'pdf_manual_link');
        //  product.pdf_manual_link_text = this._retrieveCustomAttribute(oldProductModel, 'pdf_manual_link_text');

         return product;
      },

      /**
       * @name _createDataModelChildProduct
       * @description this method will create and return a new data model for a child product
       * @type helperMethod - purpose: create a data model that is more suitable then the one retreived by magento
       * @param products - Array - all the child products of a main product
       * current keys: color_name, color_name, color_image
       */
      _createDataModelChildProduct: function(products) {
        var map = this.colorMap;

        var self = this;

        return products.map(function(product) {
          var oldProductModel = product;
          var product = {};

          if(map && map.length) {
            var color = map.find(function(item){
              return item.value === self._retrieveCustomAttribute(oldProductModel, 'car_seat_color');
            });
            product.color_name = color.label;
          }
          product.color_code = self._retrieveCustomAttribute(oldProductModel, 'car_seat_color');

          product.color_image = self._getMediaUrl(self._retrieveCustomAttribute(oldProductModel, 'image'))
          return product;
        });
      },

      /**
       * @name _retrieveCustomAttribute
       * @description this method find a Object with the attributeKey in the custom_attributes Array and return the value;
       * @type helperMethod
       * @param product - Object
       * @param attributeKey - String
       */
      _retrieveCustomAttribute: function(product, attributeKey) {
        var attribute = product.custom_attributes.find(function(attribute) {
          return attribute.attribute_code === attributeKey;
        });
        return attribute ? attribute.value : '';
      },

      _getMediaUrl: function(pathSegment) {
        return pathSegment ? CONFIG.ECOM_URL + '/media/catalog/product/' + pathSegment : null;
      }

    });
  </script>
</dom-module>
