<link rel="import" href="dorel-magento-auth.html">
<link rel="import" href="dorel-product-data-model.html">
<link rel="import" href="dorel-product-color-map.html">

<dom-module id="dorel-magento-collect-product">
  <template>

    <dorel-magento-auth
      id="auth"
      token="{{ token }}"></dorel-magento-auth>

    <dorel-product-color-map
      color-map="{{ colorMap }}"
      token="[[ token ]]"></dorel-product-color-map>

    <dorel-product-data-model
      id="transform"
      color-map="[[ colorMap ]]"></dorel-product-data-model>

    <iron-ajax
      id="product"
      content-type="application/json"
      method="get"
      handle-as="json"
      on-response="_productResponse"></iron-ajax>

    <iron-ajax
      id="childProducts"
      content-type="application/json"
      method="get"
      input="1"
      handle-as="json"></iron-ajax>

  </template>

  <script>
    Polymer({
      is: 'dorel-magento-collect-product',

      properties: {

        /**
         * @name category
         * @description this category is inherit by the parent and
         * will be used in the filter for the call to the magento end-point
         */
        category: {
          type: Number,
          value: 0
        },

        productName: {
          type: String
        },

        token: {
          type: String,
          value: ''
        },

        colorMap: {
          type: Array,
          value: []
        }

      },

      observers: [
        '_init(category, productName, token, colorMap)'
      ],

      /**
       * @name _init
       * @description will be called by the observer
       * @param category - Number
       * @param productName - String
       * @param token - String
       * @param colorMap - Array
       */
      _init: function(category, productName, token, colorMap) {
        // if category or productName is empty we can't make the call return
        if(!category || !productName) {
          return;
        }
        // if token is empty retreive the token _init will be triggered if token is retreived
        if(!token) {
          return this.$.auth.retreiveToken();
        }
        // if colorMap is empty return _init will be triggered if colorMap is changed
        if(!colorMap || !colorMap.length) {
          return;
        }

        // get all the products that are saved in the global
        var products = Polymer.globalsManager.get('Dorel.product.products') || [];

        // set currentProduct with a empty array so a detail page will remove the old current product
        // this will result in a more natural user experience when routing from product-detail to a other product-detail
        this._setCurrentProduct([]);

        // check if the productName (potential new current product) is already in the saved products
        var existingProduct = products.find(function(product) {
          return product.url === productName;
        });

        // if the product already exists set this product else retrieve product from api
        if(existingProduct) {
          return this._setCurrentProduct([existingProduct]);
        } else {
          return this._getProduct();
        }
      },

      /**
       * @name _getProduct
       * @description make call to end-point to retreive product
       * @param category - Number
       */
      _getProduct: function(category) {
        var productsEl = this.$.product;
        productsEl.headers = {Authorization: 'Bearer ' + this.token};
        productsEl.url = CONFIG.ECOM_URL + '/rest/V1/products?' +
        '&searchCriteria[filter_groups][1][filters][0][field]=visibility' +
        '&searchCriteria[filter_groups][1][filters][0][value]=4' +
        '&searchCriteria[filter_groups][2][filters][0][field]=sku' +
        '&searchCriteria[filter_groups][2][filters][0][value]=' + this.productName +
        '&searchCriteria[filter_groups][3][filters][0][field]=category_id' +
        '&searchCriteria[filter_groups][3][filters][0][value]=' + this.category;

        productsEl.generateRequest();
      },

      /**
       * @name _productResponse
       * @description response of the _getProduct call;
       * @param response
       */
      _productResponse: function(response) {

        //set products from response
        var newProduct = response.detail.response.items;
        var category = this.category;

        //if there are no products in response early return
        if(!newProduct.length) {
          this._setCurrentProduct([]);
         // set the global currentPage
          Polymer.globalsManager.set('Dorel.current.page', { template: '404' });
          return
        }

        // refer to this
        var self = this;

        // Map the newProducts the childProducts can be retreived and added to the product
        Promise.all(newProduct.map(function(product) {
          // every product will return function with a new promise from iron-ajax
          return self._getChildProducts(product.sku).then(function(data) {
            // create new data model for product and return this to array
            return self.$.transform.createDataModelProduct(product, category, data.response);
          });
        })).then(function(newProducts) {
            // if promise.all is resolved call the setProducts
            self._setProducts(newProducts);
        });
      },

      /**
       * @name _setProducts
       * @description will merge the old and new products and remove the duplicates and set the global products
       * @param newProducts - Array
       */
      _setProducts: function(newProduct) {
        //set the current products
        this._setCurrentProduct(newProduct);

        //get all the "cached" products
        var oldProducts = Polymer.globalsManager.get('Dorel.product.products') || [];

        //check if item exists else filter it before merging arrays (oldProducts / newProducts)
        var products = oldProducts.concat(newProduct.filter(function (item, index) {
            var exists = false;
            oldProducts.forEach(function (oldItem) {
              if (oldItem.id === item.id) {
                exists = true;
              }
            });
            return !exists;
        }));
        // set new array of products in the global saved products
        Polymer.globalsManager.set('Dorel.product.products', products);
      },

      /**
       * @name _getChildProducts
       * @description this method call the magento end-point to retreive all the child products of the main product with the given `Id`
       * @param id - String
       */
      _getChildProducts: function(id) {
        var childProductsEl = this.$.childProducts;
        childProductsEl.headers = {Authorization: 'Bearer ' + this.token};
        childProductsEl.url = CONFIG.ECOM_URL + '/rest/V1/configurable-products/' +
        id + '/children';
        //return the promise from iron-ajax
        return childProductsEl.generateRequest().completes;
      },

      /**
       * @name _setCurrentProduct
       * @description this method will set global current product;
       * @param product - Array
       */
      _setCurrentProduct: function(product) {
        Polymer.globalsManager.set('Dorel.current.product', product);
      }

    });
  </script>
</dom-module>
