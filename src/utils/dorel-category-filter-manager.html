<link rel="import" href="../../bower_components/app-route/app-location.html">
<link rel="import" href="../../bower_components/app-route/app-route.html">

<dom-module id="dorel-category-filter-manager">
  <template>
    <style include="iron-flex iron-flex-alignment">
      :host {
      }
    </style>
    <app-location route="{{ route }}" query-params="{{ queryParams }}"></app-location>
  </template>
  <script>
    Polymer({
      is: 'dorel-category-filter-manager',

      properties: {
        /**
         * @name route
         * @description this is passed by the app-route component
         */
        route: {
          type: Object,
          value: function() { return {}; }
        },

        /**
         * @name filters
         * @description Array of filters that will be passed to parent
         */
        filters: {
          type: Array,
          notify: true,
          reflectToAttribute: true,
          value: function() { return []; }
        }
      },

      observers: [
        '_getQueryParams(route, queryParams)'
      ],

      /**
       * observer
       * @name _getRoute
       * @description will set the filters
       * @param route - Object
       * if the route changes it will check if there are queryParams in the route
       * if there are queryParams it will loop over the queryParams and set the filters Array
       */
      _getQueryParams: function(route, queryParams) {
        this.set('filters', []);
        if(!queryParams || !Object.keys(queryParams).length) {
          return;
        }
        var self = this;
        var filters = Object.keys(queryParams).map(function(key, value) {
          var filterItem = {};
          filterItem.values = queryParams[key].split(',').map(function(value) {
            return { value: value };
          });
          filterItem.key = key;
          return filterItem;
        });
        self.set('filters', filters);
      },

      /**
       * @name shouldShowProduct
       * @description A public function that returns a Boolean
       * @param product - Array
       * @param filters - Array
       * @returns Boolean if all the conditions are met return true too show the product
       */
      shouldShowProduct: function(product, filters) {
        var self = this;
        return filters.value.every(function(filter) {
          var productValues = self._findInFilterGroup(product, filter.key);
          return self._resultByKey(filter.values, productValues, filter.key);
        });
      },

      /**
       * @name _resultByKey
       * @description A helper method that will call a function depending on the key
       * @param filterValues - Array
       * @param productValues - Array
       * @param key - String
       * @returns Boolean
       */
      _resultByKey: function(filterValues, productValues, key) {
        var result;
        switch (key) {
            case 'price':
                result = this._checkIfValueIsBigger(filterValues, productValues);
                break;
            default:
                result = this._checkIfValueIsMatch(filterValues, productValues);
        }
        return Boolean(result);
      },

      /**
       * @name _checkIfValueIsMatch
       * @description A helper method that will check if some of the filterValues are bigger then some of the productValues
       * @param filterValues - Array
       * @param productValues - Array
       * @returns Boolean
       */
      _checkIfValueIsBigger: function(filterValues, productValues) {
          return productValues.some(function(productValue) {
            return filterValues.some(function(filterValue) {
              return Number(filterValue.value) >= productValue.value;
            })
          });
      },

      /**
       * @name _checkIfValueIsMatch
       * @description A helper method that will check if some of the productValues match some of the filterValues
       * @param filterValues - Array
       * @param productValues - Array
       * @returns Boolean
       */
      _checkIfValueIsMatch: function(filterValues, productValues) {
          return productValues.some(function(productValue) {
            return filterValues.some(function(filterValue) {
              return filterValue.value === productValue.value;
            })
          });
      },

      /**
       * @name _findInFilterGroup
       * @description A helper method that finds the filterGroup that matches the key
       * @param product - Object
       * @param key - String
       * @returns Array
       */
      _findInFilterGroup: function(product, key) {
        if(!product || !product.filter_groups || !product.filter_groups.length) {
          return [];
        }
        var filterGroup = product.filter_groups.find(function(item) {
          return item.name === key;
        });
        return filterGroup ? filterGroup.values : [];
      }
    });

  </script>

</dom-module>
