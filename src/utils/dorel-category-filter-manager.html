<link rel="import" href="../../bower_components/app-route/app-location.html">
<link rel="import" href="../../bower_components/app-route/app-route.html">

<dom-module id="dorel-category-filter-manager">
  <template>
    <style include="iron-flex iron-flex-alignment">
      :host {
      }
    </style>
    <app-location route="{{ route }}" query-params="{{ queryParams }}"></app-location>
  </template>
  <script>
    Polymer({
      is: 'dorel-category-filter-manager',

      properties: {
        /**
         * @name route
         * @description this is passed by the app-route component
         */
        route: {
          type: Object,
          value: function() { return {}; }
        },

        /**
         * @name filters
         * @description Array of filters that will be passed to parent
         */
        filters: {
          type: Array,
          notify: true,
          reflectToAttribute: true,
          value: function() { return []; }
        }
      },

      observers: [
        '_getQueryParams(route, queryParams)'
      ],

      /**
       * observer
       * @name _getRoute
       * @description will set the filters
       * @param route - Object
       * if the route changes it will check if there are queryParams in the route
       * if there are queryParams it will loop over the queryParams and set the filters Array
       */
      _getQueryParams: function(route, queryParams) {
        this.set('filters', []);
        if(!queryParams || !Object.keys(queryParams).length) {
          return;
        }
        var self = this;
        var filters = [];

        filters = Object.keys(queryParams).map(function(key, value) {
          var filterItem = {};
          var valueIsNumber = !isNaN(queryParams[key]);
          if(valueIsNumber) {
            filterItem.values = [Number(queryParams[key])];
            filterItem.type = 'Number';
          } else {
            filterItem.values = queryParams[key].split(',');
            filterItem.type = 'String';
          }
          filterItem.key = key;
          return filterItem;
        });

        self.set('filters', filters);
      },

      /**
       * @name shouldShowProduct
       * @description A public function that returns a Boolean
       * @param product - Array
       * @param filters - Array
       * @returns Boolean if all the conditions are met return true too show the product
       */
      shouldShowProduct: function(product, filters) {
        var self = this;
        return this._checkChildProducts(product, filters) && this._checkProduct(product, filters);
      },

      _checkProduct: function(product, filters) {
        var self = this;
        return filters.value.every(function(filter) {
          var productValues = self._findVal(product, filter.key);
          return self._resultByKey(filter.values, productValues, filter.key);
        });
      },

      _checkChildProducts: function(product, filters) {
        var self = this;
        //if it does not have childProducts it means it is a childProduct so return true
        if(!product.childProducts) {
          return true;
        }
        // if product has childProducts then check if one of these is true
        return product.childProducts.some(function(childProduct) {
          return filters.value.every(function(filter) {
            var childProductValues = self._findVal(childProduct, filter.key);
            return self._resultByKey(filter.values, childProductValues, filter.key);
          });
        });
      },

      _resultByKey: function(filterValues, productValues, key) {
        var result;
        switch (key) {
            case 'price':
                result = this._checkIfValueIsBigger(filterValues, productValues); // true
                break;
            default:
                result = this._checkIfValueIsMatch(filterValues, productValues); // true
        }
        return Boolean(result);
      },

      _checkIfValueIsBigger: function(filterValues, productValues) {
          var lowestPrice = Math.min.apply(Math, productValues);
          return Boolean(filterValues[0] >= lowestPrice);
      },

      _checkIfValueIsMatch: function(filterValues, productValues) {
          return productValues.some(function(productValue) {
            return filterValues.indexOf(productValue) > -1;
          })
      },

      /**
       * @name _findVal
       * @description A recursive helper function that is used to retrieve the value
       * @param object - Object
       * @param key - String
       * returns a Array of values
       */
      _findVal: function(object, key) {
        var value;
        var self = this;
        Object.keys(object).some(function(k) {
            // if k is equal to key set value an return true so some() will stop and _findVal will return Array
            if (k === key) {
                value = [object[k]];
                return true;
            }
            // if object[k] has length and is a Array
            if(object[k].length && Array.isArray(object[k])) {
              // set empty array
              var results = [];
              // loop over array
              object[k].forEach(function(item) {
                // if item in the array is a object and the item[key] exists
                if (typeof item === 'object' && item[key]) {
                  // push the values to the results array
                  results.push(item[key]);
                }
              });
              // if results has length it means we have the correct Array
              if(results.length) {
                // set value with the array and return true so some() will stop and _findVal will return the Array
                value = results;
                return true;
              } else {
                // it's not the correct Array so continue looping
                value = self._findVal(object[k], key);
                return value !== undefined;
              }
            }
            if (object[k] && typeof object[k] === 'object' && !Array.isArray(object[k])) {
                // it's not the correct key so continue looping
                value = self._findVal(object[k], key);
                return value !== undefined;
            }
        });
        return value;
      }
    });

  </script>

</dom-module>
