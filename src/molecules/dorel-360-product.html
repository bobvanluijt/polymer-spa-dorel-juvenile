<dom-module id="dorel-360-product">
  <template>
    <style>
      .image {
        margin: auto;
        display: block;
        width: 31em;
        height: 35em;
        touch-action: none;
        background-position: 50% 50%;
        background-repeat: no-repeat;
        background-size: cover;
      }

      .product {
        float: left;
        position: relative;
        background-color: #d9d9d9;
        width: 31em;
        height: 35em;

      }

      .image {
        opacity: 0;
        transition: opacity .3s ease;
      }

      [preloaded] .image {
        opacity: 1;
      }

      .spinner {
        width: 2em;
        height: 2em;
        position: absolute;
        left: 50%;
        top: 50%;
        margin: -1em 0 0 -1em;
      }

      .double-bounce1, .double-bounce2 {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        background-color: var(--theme-brand-color-1);
        opacity: 0.6;
        position: absolute;
        top: 0;
        left: 0;

        -webkit-animation: sk-bounce 2.0s infinite ease-in-out;
        animation: sk-bounce 2.0s infinite ease-in-out;
      }

      .double-bounce2 {
        -webkit-animation-delay: -1.0s;
        animation-delay: -1.0s;
      }

      @-webkit-keyframes sk-bounce {
        0%, 100% {
          -webkit-transform: scale(0.0)
        }
        50% {
          -webkit-transform: scale(1.0)
        }
      }

      @keyframes sk-bounce {
        0%, 100% {
          transform: scale(0.0);
          -webkit-transform: scale(0.0);
        }
        50% {
          transform: scale(1.0);
          -webkit-transform: scale(1.0);
        }
      }

    </style>

    <div class="product flex" preloaded$="[[ rotationReady ]]">
      <template is="dom-if" if="[[ !rotationReady ]]">
        <div class="spinner">
          <div class="double-bounce1"></div>
          <div class="double-bounce2"></div>
        </div>
      </template>
      <img style$="background-image: url('[[ currentImage ]]')" class="image" on-track="_handleTrack">
    </div>
  </template>

  <script>
    Polymer({
      is: 'dorel-360-product',

      properties: {
        currentImage: {
          type: String,
          value: '../../../assets/images/360viewer/01.jpg',
        },
        /**
         * @attribute rotationElement
         * @name The object that will be rotated
         * @description
         */
        rotationElement: {
          type: Object,
        },

        /**
         * @attribute startTracking
         * @name Starting point of the rotation tracking
         * @description
         */
        startTracking: {
          type: Number
        },
        /**
         * @attribute
         * @name rotationReady
         * @description Indicator for when the component is done preloading all images
         */
        rotationReady: {
          type: Boolean,
          value: false,
        },
        /**
         * @attribute
         * @name rotation
         * @description The rotation value of the object
         */
        rotation: {
          type: Number,
          value: 0
        },

        /**
         * @attribute
         * @name rotationImages
         * @description A list of image objects, which are preloaded when the component is ready
         */
        rotationImages: {
          type: Array,
          value: []
        },

        /**
         * @attribute
         * @name rotationImagePaths
         * @description A list of subsequent images for 360 viewing
         */
        rotationImagePaths: {
          type: Array,
          value: [
            '../../../assets/images/360viewer/01.jpg',
            '../../../assets/images/360viewer/02.jpg',
            '../../../assets/images/360viewer/03.jpg',
            '../../../assets/images/360viewer/04.jpg',
            '../../../assets/images/360viewer/05.jpg',
            '../../../assets/images/360viewer/06.jpg',
            '../../../assets/images/360viewer/07.jpg',
            '../../../assets/images/360viewer/08.jpg',
            '../../../assets/images/360viewer/09.jpg',
            '../../../assets/images/360viewer/10.jpg',
            '../../../assets/images/360viewer/11.jpg',
            '../../../assets/images/360viewer/12.jpg',
            '../../../assets/images/360viewer/13.jpg',
            '../../../assets/images/360viewer/14.jpg',
            '../../../assets/images/360viewer/15.jpg',
            '../../../assets/images/360viewer/16.jpg',
            '../../../assets/images/360viewer/17.jpg',
            '../../../assets/images/360viewer/18.jpg',
            '../../../assets/images/360viewer/19.jpg',
            '../../../assets/images/360viewer/20.jpg',
            '../../../assets/images/360viewer/21.jpg',
            '../../../assets/images/360viewer/22.jpg',
            '../../../assets/images/360viewer/23.jpg',
          ]
        },
      },

      /**
       * @name: ready
       * @description Polymer callback event for when the component has been intialized
       */
      ready: function () {
        console.log('ready');
        this._preloadImages();
      },

      /**
       * @name: _preloadImages
       * @description Preloads all of the images for better performance
       */
      _preloadImages: function () {
        console.log('Start preloading images');

        // Temporarily adding a delay to demo real world preloading behaviour
        this.async(function () {
          for (var i = 0; i < this.rotationImagePaths.length; i++) {
            this.rotationImages[i] = new Image();
            this.rotationImages[i].src = this.rotationImagePaths[i];
          }

          this.rotationReady = true;
        }, 3000)
      },

      /**
       * @name: _handleTrack
       * @description Handles tracking event and rotation behaviour
       **/
      _handleTrack: function (e) {
        switch (e.detail.state) {
          case 'start':
            this.startTracking = e.detail.x;
            this.rotationElement = this.$$('#rotation-element');
            break;
          case 'track':

            newXPosition = e.detail.x;
            newDelta = (newXPosition - this.startTracking ) / 50;
            // Clamp the delta between -3 and 3, to avoid too much rotation
            newDelta = Math.max(newDelta, -3);
            newDelta = Math.min(newDelta, 3);

            // Calculates the new rotation in degress
            this.rotation = this.rotation + newDelta;

            /*
             * Picking the right image
             * */
            var imageNumber = (this.rotation % 360);
            imageNumber = imageNumber / (360 / this.rotationImagePaths.length);
            imageNumber = Math.round(imageNumber);

            // Wrap to the list item in the list, if we have a negative imageNumber
            if (imageNumber < 0) {
              imageNumber = this.rotationImagePaths.length + imageNumber;
            }

            // Make absolute (to prevent -0);
            imageNumber = Math.abs(imageNumber);
            //console.log(imageNumber);
            this.currentImage = this.rotationImagePaths[imageNumber];

            break;
        }
      },
    });

  </script>

</dom-module>
