<dom-module id="dorel-showcase-zoom-lightbox">
  <template>
    <style>
      :host {
        position: relative;
        z-index: 99999999;
      }
      .overlay {
        position: fixed;
        display: block;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0,0,0, 0.4);
        visibility: hidden;
        opacity: 0;
        padding: 1.5rem;
        box-sizing: border-box;
        transition: 0.35s;
        cursor: pointer;
        cursor: zoom-out;
      }
      .overlay[active] {
        opacity: 1;
        visibility: visible;
      }
      .image {
        width: 100%;
        height: calc(100vh - 3rem);
        margin: auto;
        float: none;
        display: block;
      }
      .overlay-wrapper {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate( -50%, -50% );
        height: calc(100vh - 3rem);
        width: inherit;
        cursor: default;
      }
      .overlay-arrow {
        position: absolute;
        top: 50%;
        left: 0;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        transform: translate(-50%, -50%) scale(1);
        background-color: white;
        line-height: 50px;
        text-align: center;
        box-shadow: 0 0 1px 1px rgba( 0, 0, 0, .1);
        transition: .2s;
        cursor: pointer;
      }

      .overlay-arrow:hover {
        box-shadow: 0 0 2px 2px rgba( 0, 0, 0, .2);
      }

      .overlay-arrow:active {
        transform: translate(-50%, -50%) scale(1.1);
      }
      .overlay-arrow.right {
        right: 0;
        left: auto;
        transform: translate(50%, -50%) scale(1);
      }
      .overlay-arrow.right:active {
        transform: translate(50%, -50%) scale(1.1);
      }
      .overlay-close {
        float: right;
        cursor: pointer;
        transition: color 0.2s;
        color: var(--theme-brand-color-2);
      }
      .overlay-close:hover {
        color: var(--theme-brand-color-1);
      }
    </style>
    <div
      class="overlay"
      id="imageLightboxOverlay"
      active$="[[active]]"
      on-click="handleClick">
      <template
        is="dom-if"
        if="[[_imageExists(position)]]">
        <dorel-product-image
          class="image"
          sizing="contain"
          height="[[windowHeight]]"
          image-url$="[[_getImageUrl(position)]]">
        </dorel-product-image>
        <div
          id="overlayWrapper"
          class="overlay-wrapper"
          on-click="_imageClick">
          <template
            is="dom-if"
            if="[[_imageExists(position, -1)]]">
            <div
              id="overlayArrowLeft"
              class="overlay-arrow left"
              data-difference="-1"
              data-image$="[[_getImageUrl(position)]]"
              on-click="_switchImage">
              <iron-icon class="dorel-cookie-notification__proceed-icon" icon="dorel-icons:chevron-left"></iron-icon>
            </div>
          </template>

          <template
            is="dom-if"
            if="[[_imageExists(position, 1)]]">
          <div
            id="overlayArrowRight"
            class="overlay-arrow right"
            data-difference="1"
            data-image$="[[_getImageUrl(position)]]"
            on-click="_switchImage">
            <iron-icon class="dorel-cookie-notification__proceed-icon" icon="dorel-icons:chevron-right"></iron-icon>
          </div>
          </template>
          <div
            id="overlayClose"
            class="overlay-close"
            on-click="_closeLightbox">
            <iron-icon class="dorel-cookie-notification__proceed-icon"
              icon="dorel-icons:close"></iron-icon>
          </div>
        </div>
        [[ _setImageWidth(position) ]]
      </template>
    </div>
  </template>

  <script>
    class DorelShowcaseZoomLightbox extends ReduxMixin(Polymer.Element) {
      static get is() {
        return 'dorel-showcase-zoom-lightbox';
      }

      static get properties() {
        return {
          /**
           * determines if the lightbox is shown
           */
          active: {
            type: Boolean,
            reflectToAttribute: true,
            statePath: 'image.imageLightbox.active'
          },

          /**
           * The index of to be displayed image in the imageUrls array.
           */
          position: {
            type: String,
            reflectToAttribute: true,
            statePath: 'image.imageLightbox.position'
          },

          /**
           * The urls to the images which are to be shown.
           */
          imageUrls: {
            type: Array,
            reflectToAttribute: true,
            statePath: 'image.imageLightbox.imageUrls'
          },

          /**
           * determines if the lightbox image a product image if true,
           */
          bynderId: {
            type: Number,
            reflectToAttribute: true,
            statePath: 'image.imageLightbox.bynderId'
          },

          /**
           * height of the visitors viewport
           */
          windowHeight: {
            type: Number,
            value: () => window.innerHeight
          }
        }
      }

      ready() {
        super.ready();
        this.addEventListener('click', this._closeLightbox);
        window.addEventListener('update-light-box', function() {
          // TODO clean this mess up.
          //  Change the position and change it back in order to trigger a change and rerender the component.
          var position = this.get("position");
          this.set("position", position + 1);
          this.set("position", position);
        }.bind(this));
      }

      /**
       * Dont close the lightbox when clicked on image.
       */
      _imageClick(event) {
        event.stopPropagation();
      }

      /**
       * when there is a click hide the lightbox
       */
      _closeLightbox() {
        this.dispatch('resetImageLightbox');
      }

      /**
       * Switch images after button clicks (image is determined by data attribute).
       */
      _switchImage(event) {
        event.stopPropagation();
        const newPosition = this.get("position") + parseInt(event.currentTarget.dataset.difference);
        if(!this._imageExists(newPosition)) return false;
        this.set("position", newPosition);
      }

      /**
       * Get the image url by index.
       */
      _getImageUrl(index) {
        return this.get('imageUrls')[index];
      }

      /**
       * Check if an image exists with a given index.
       */
      _imageExists(index, dif = 0) {
        index += dif;
        const imageUrls = this.get('imageUrls');
        return imageUrls ? index < imageUrls.length && index >= 0  : false;
      }

      /**
       * Set the image width to the overlay in order to position the close icon.
       *
       * @param {Integer} position
       *   The position in the imageUrls array of the item you want to get the position of.
       */
      _setImageWidth(position) {
        const url = this._getImageUrl(position);
        Polymer.RenderStatus.afterNextRender(this, () => {
          const img = new Image();
          const element = this.shadowRoot.querySelector("#overlayWrapper");
          img.addEventListener("load", function() {
            element.style.width = "calc(" + 100 * (this.naturalWidth / this.naturalHeight) + "vh - 3em)";
          });
          img.src = url;
        });
      }

    }

    customElements.define(DorelShowcaseZoomLightbox.is, DorelShowcaseZoomLightbox);
  </script>
</dom-module>
