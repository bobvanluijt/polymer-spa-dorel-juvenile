<dom-module id="dorel-wp-collect-widgets">
  <template>
    <style></style>
    
    <iron-ajax 
      auto 
      url="[[ endPoint ]]" 
      handle-as="json"
      on-response="_widgetAreasLoaded"></iron-ajax>

    <iron-ajax
      id="widget"
      url=""
      handle-as="json"
      on-response="_widgetsLoaded"></iron-ajax>
  </template>

  <script>
    Polymer({
      is: 'dorel-wp-collect-widgets',

      properties: {
        /**
         * `pageData` this variable is reflected
         * by two way binding in order to use it in your
         * template.
         */
        widgetAreas: {
          type: Object,
          reflectToAttribute: true,
          notify: true
        },

        /**
         * `wpUrl` of the url of the Wordpress instance
         */
        wpUrl: {
          type: String
        },

        /**
         * `widgetIndex` used to keep track of the number
         * in the array of widgetAreas and placement of the widgets
         */
        widgetIndex: {
          type: Number,
          value: ''
        }
      },

      ready: function() {
        this.endPoint = this.wpUrl + '/wp-rest-api-sidebars/v1/sidebars';
      },

      /** 
       * @name _widgetAreasLoaded
       * @description retrieve all the widget areas and then trigger
       * the rest call to retrieve the widgets
       */
      _widgetAreasLoaded: function(data) {
        this.widgetAreas = data.detail.response;
        var widgetEl = this.$.widget;
        var endPoint = this.endPoint;
        var widgetIndex = this.widgetIndex;

        // iterate over the keys of the response
        this.widgetAreas.forEach(function(widgetArea) {
          // for every key retrieve its menuItems
          widgetEl.url = endPoint + '/' + widgetArea.id;
          widgetEl.generateRequest();
        });
        
        // to retrieve the menu use Polymer.globalsManager.get('Dorel');
        Polymer.globalsManager.set('Dorel.collect.widgetAreas', this.widgetAreas);
      },

      /** 
       * @name _widgetsLoaded
       * @description retrieve all widgets per widget area and place them
       * accordingly
       */
      _widgetsLoaded: function(data) {
        var response = data.detail.response;
        console.log(response);

        // retrieve the widgetArea id from the url call
        var urlArr = data.detail.url.split('/');
        var areaId = urlArr[urlArr.length - 1];

        // place the widgets in the right index
        this.widgetAreas.forEach(function(widgetArea) {
          if (widgetArea.id === areaId) {
            widgetArea.widgets = response.widgets;
          }
        });

        // set the widgetAreas (two way data binding for the app)
        this.globals.Dorel.collect.widgetAreas = this.widgetAreas;
      }
    });
  </script>
</dom-module>