<link rel="import" href="../../node_modules/l2t-paper-slider/l2t-paper-slider.html">
<link rel="import" href="./dorel-youtube-video.html">
<dom-module id="dorel-content-carousel">
  <template>
    <style is="custom-style">
    :host {

      --paper-slider-dot-container-styles: {
        background-color: var(--theme-color-monochrome-4);
        border-radius: 1em;
        bottom: auto;
        bottom: 3rem;
      }

      --theme-border-radius: 0

      --paper-slide-dot-styles: {
        background-color: var(--theme-color-monochrome-1);
        width: .75em;
        height: .75em;
        margin: .5em;
        border-style: none;
        border: 1px solid var(--theme-color-monochrome-1);
      };

      --paper-slide-dot-selected: var(--theme-brand-color-1);

      --paper-slide-height: auto;
    }

    .simple-slider-slide:focus {
      outline: none;
    }

    l2t-paper-slider {
      outline: none;
    }

    .slider--full-width {
      position: relative;
      overflow: hidden;
    }

    .slider--full-width .slider__image {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      transition: 0.3s;
      overflow: visible;
    }

    .slider--full-width .slider__slide {
      position: relative;
      padding-bottom: 56.25%;
      height: 0;
      min-height: 0;
      max-height: 100%;
      overflow: hidden;
      transition: height 0.5s, padding 0.5s;
    }

    [desktop-small-up] .slider--full-width .slider__slide {
      padding-bottom: 0;
      min-height: 20rem;
      max-height: 35rem;
      height: 80vh;
    }

    [desktop-small-up] .slider--full-width .slider__image {
      min-height: 20rem;
      height: 80vh;
      max-height: 35rem;
      width: 100%;
      max-width: 100%;
      /* reset tablet < */
      top: auto;
      left: auto;
      position: static;
    }

    [video-apect-ratio] .slider--full-width .slider__image {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }

    [video-apect-ratio] .slider--full-width .slider__slide {
      position: relative;
      padding-bottom: 56.25%;
      min-height: 0;
      height: 0;
      max-height: 100%;
      overflow: hidden;
      overflow: visible;
    }

    .slider--product .slider__image {
      height: 20rem;
      width: 100%;
      max-width: 100%;
    }

    [tablet-medium-up] .slider--product .slider__image {
      height: 28rem;
    }

    .content {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      display: flex;
      justify-content: center;
      align-content: center;
      max-width: 100%;
    }
    .content__align-center {
      display: flex;
      align-content: center;
      align-items: center;
      justify-content: center;
      flex: 1;
      height: 100%;
      width: 100%;
      padding: 1.5rem;
      box-sizing: border-box;
    }
    .content__title {
      @apply(--theme-typography-8);
      font-size: 3.0000em !important;
      color: var(--theme-color-monochrome-1);
      margin: 0;
      text-shadow: 1px 1px 2px rgba(0,0,0,.5);
    }
    .content__description {
      @apply(--theme-typography-4);
      font-size: 1.5000em !important;
      color: var(--theme-color-monochrome-1);
      text-shadow: 1px 1px 2px rgba(0,0,0,.5);
    }
    .content__text {
      display: none;
    }
    [tablet-medium-up] .content__text {
      display: block;
    }
    .content__video {
      margin-right: 0;
    }
    [tablet-medium-up] .content__video {
      margin-right: 1.5rem;
    }
    [playing] .content__video {
      opacity: 0;
    }
    .content__play-btn {
      color: var(--theme-color-monochrome-1);
      width: 6rem;
      height: 6rem;
      border-radius: 50%;
      border-radius: 50%;
      position: relative;
      border: 0.5rem solid var(--theme-color-monochrome-1);
      -webkit-box-shadow: 1px 1px 2px 0px rgba(0,0,0,0.5);
      -moz-box-shadow: 1px 1px 2px 0px rgba(0,0,0,0.5);
      box-shadow: 1px 1px 2px 0px rgba(0,0,0,0.5);
    }

    .content__play-icon {
      color: var(--theme-color-monochrome-1);
      position: absolute;
      top: 50%;
      font-size: 4rem !important;
      left: 50%;
      margin-left: 0.3rem;
      transform: translate(-50%, -50%);
      text-shadow: 1px 1px 2px rgba(0,0,0,.5);
    }

    dorel-youtube-video {
      --video-border-radius: 0px;
    }

    </style>

    <dorel-media-query breakpoints="{{ breakpoints }}"></dorel-media-query>

    <section class="section-slideshow"
      video-apect-ratio$="{{ videoAspectRatio }}"
      desktop-small-up$="{{ breakpoints.desktopSmallUp }}"
      tablet-medium-up$="{{ breakpoints.tabletMediumUp }}">
      <l2t-paper-slider
                        class$="slider {{_getClass(type)}}"
                        id="simpleSlider"
                        position="{{ position }}"
                        hide-nav="[[ shouldHideNav(breakpoints.tabletMediumUp, hideBulletPoints) ]]"
                        slide-duration="4"
                        total-slides="[[ slides.length ]]">
        <template
          is="dom-repeat"
          items="[[ slides ]]"
          as="slide">

          <paper-slide class="slider__slide">

            <template is="dom-if" if="[[ _shouldShowType(slide, 'image_url') ]]">
              <iron-image class="slider__image"
                  sizing="[[ sizing ]]"
                  fade="true"
                  preload
                  src$="[[ slide.image_url ]]"></iron-image>
            </template>

            <template is="dom-if" if="[[ _shouldShowType(slide, 'image') ]]">
              <dorel-bynder-image media-id="[[ slide.bynder_image_id ]]"
                                  width="100%"
                                  height="100%"
                                  mobile-width="100%"
                                  mobile-height="100%"
                                  tablet-width="100%"
                                  tablet-height="100%"
                                  image-type="wide-screen"
                                  class="slider__image"></dorel-bynder-image>
            </template>

            <template is="dom-if" if="[[ _shouldShowType(slide, 'video') ]]">
              <dorel-youtube-video id$="videoplayer-{{ index}}"
                class="slider__image"
                autoplay="0"
                volume="0"
                image-type="wide-screen"
                video-id="[[ slide.video_id ]]"
                thumbnail="[[ slide.bynder_image_id ]]"></dorel-youtube-video>
            </template>

            <template is="dom-if" if="[[ slide.content ]]">
              <div class="content">
                <dorel-layout-container>
                  <div class="content__align-center">

                      <template is="dom-if" if="[[ _shouldShowType(slide, 'video') ]]">
                        <div class="content__video">
                          <div on-click="_playVideo" class="content__play-btn">
                            <span class="content__play-icon">&#9658;</span>
                          </div>
                        </div>
                      </template>

                      <div class="content__text">
                        <template is="dom-if" if="[[ slide.content.title ]]">
                          <h3 class="content__title">[[ slide.content.title ]]</h3>
                        </template>
                        <template is="dom-if" if="[[ slide.content.description ]]">
                          <p class="content__description">[[ slide.content.description ]]</p>
                        </template>
                      </div>

                  </div>
                </dorel-layout-container>
              </div>
            </template>

          </paper-slide>

        </template>
      </l2t-paper-slider>
    </section>

  </template>

  <script>
    Polymer({
      is: 'dorel-content-carousel',

      properties: {

        /**
         * @attribute
         * @name slides
         * @description Array of slides to show
         */
        slides: {
          type: Array
        },

        /**
         * @attribute
         * @name position
         * @description active position that is set by the l2t-paper-slider
         */
        position: {
          type: Number
        },

        /**
         * @attribute
         * @name breakpoints
         * @description breakpoints of the dorel-media-manager component
         */
        breakpoints: {
          type: Object
        },

        /**
         * @attribute
         * @name hideBulletPoints
         * @description boolean that will either show or hide bullet points of the l2t-paper-slider
         */
        hideBulletPoints: {
          type: Boolean
        },

        /**
         * @attribute
         * @name sizing
         * @description passed by the parent | option for the iron-image | contain or cover
         */
        sizing: {
          type: String,
          value: 'contain'
        },

        /**
         * @attribute
         * @name type
         * @description passed by the parent | option for the ratio | fullWidth or product
         */
        type: {
          type: String,
        },

        /**
         * @attribute
         * @name playing
         * @description if the video is playing it will set the index of playing video if nothing is playing value = -1
         */
        playing: {
          type: Number
        },


        /**
         * @attribute
         * @name videoAspectRatio
         * @description should keep video aspect ratio 16:9
         */
        videoAspectRatio: {
          type: Boolean,
          value: false
        }

      },

      observers: [
        '_updatePosition(position)',
        '_setPlaying(playing)'
      ],

      /**
       * observer
       * @name _setSlide
       * @description Everytime the position of the active slide of the l2t-paper-slider changes
       * fire a event updatePosition with the index of the active slide
       * @param position - Number
       */
      _updatePosition: function(position) {
        this.fire('updatePosition', position);
      },

      /**
       * observer
       * @name _setPlaying
       * @description Everytime the "playing" changes
       * @param playing - Number
       */
      _setPlaying: function(playing) {
        if(playing > -1) {
          this.videoAspectRatio = true;
        } else {
          this.videoAspectRatio = false;
        }
      },

      /**
       * @name moveSliderTo
       * @description will call the public method `movePos` of the l2t-paper-slider with the index as argument
       * this will set the slide of l2t-paper-slider
       * @param index - Number
       */
      moveSliderTo: function(index) {
        this.$.simpleSlider.movePos(index);
      },

      /**
       * @name moveNext
       * @description will call the public method `moveNext` of the l2t-paper-slider
       * this will set the slide of l2t-paper-slider to the next
       */
      moveNext: function() {
        this.$.simpleSlider.moveNext();
        if(this.playing > -1) {
          this._stopVideo(this.playing);
        }
      },

      /**
       * @name movePrevious
       * @description will call the public method `movePrevious` of the l2t-paper-slider
       * this will set the slide of l2t-paper-slider to the previous
       */
      movePrevious: function() {
        this.$.simpleSlider.movePrev();
        if(this.playing > -1) {
          this._stopVideo(this.playing);
        }
      },

      /**
       * template helper
       * @name shouldHideNav
       * @description If true hide the bullet points of the slider
       * @param tabletMediumUp - Boolean
       * @param hideBulletPoints - Boolean
       */
      shouldHideNav: function(tabletMediumUp, hideBulletPoints) {
        return hideBulletPoints || !(tabletMediumUp);
      },


      /**
       * @name _playVideo
       * @description on click play the video
       * @param event - Object
       */
      _playVideo: function(event) {
        // workaround for bug in targeting a item in a dom-repeat with a nested dom-if @ https://github.com/Polymer/polymer/issues/1919 will be fixed in v2.x
        var slide = event.model.slide || event.model.dataHost.dataHost.slide;
        var index = this.get('slides').findIndex(function(item) {
          return item === slide;
        });
        if(typeof index === 'undefined') {
          return
        }
        var videoEl = this.shadowRoot.querySelector('#videoplayer-' + index);
        this.shadowRoot.querySelector('#videoplayer-' + index).play();
        this.playing = index;
      },

      /**
       * @name _shouldBeStopped
       * @description on click stop the video that is playing
       * @param event - Object
       */
      _shouldBeStopped: function(event) {
        var slide = event.model.slide;
        var index = this.get('slides').findIndex(function(item) {
          return item === slide;
        });
        if(typeof index === 'undefined') {
          return
        }
        this._stopVideo(index);
      },

      /**
       * @name _stopVideo
       * @description on click stop the video that is playing
       * @param index - Number
       */
      _stopVideo: function(index) {
        this.playing = -1;
        var self = this;
        // timeout is used for delay of the height animation
        setTimeout(function () {
          self.shadowRoot.querySelector('#videoplayer-' + index).stop();
        }, 500);
      },

      /**
       * template helper
       * @name _getClass
       * @description will return a class name based on the param (type)
       * @param type - String
       */
      _getClass: function(type) {
        var className;
        switch(type) {
            case 'fullWidth':
                className = 'slider--full-width';
                break;
            case 'product':
                className = 'slider--product';
                break;
            default:
              break;
        }
        return className;
      },

      /**
       * template helper
       * @name _shouldShowType
       * @description determines what part of the slide should be shown
       * @param slide - Object
       * @param type - String
       */
      _shouldShowType: function(slide, type) {
        if(type === 'image_url') {
          return slide && slide.image_url && slide.image_url.length;
        }
        return slide.type === type;
      },
    });
  </script>
</dom-module>
