<link rel="import" href="../atoms/dorel-checkbox.html">

<dom-module id="dorel-category-filter-colors">
  <template>
    <style include="iron-flex iron-flex-alignment">
      :host {
        @apply(--max-width-container);
        display: flex;
        width: 100%;
      }
      .checkbox {
        display: flex;
        width: 100%;
      }
      .checkboxes {
        display: flex;
        flex-direction: column;
        width: 100%;
      }
    </style>

    <div class="checkboxes">
      <template is="dom-repeat"
        is="dom-repeat"
        id="colors"
        items="[[ colors ]]"
        restamp="true"
        as="color">
        <div class="checkbox">
          <dorel-checkbox on-change="setFilters" checked="{{ color.checked }}" label="[[ color.name ]]" color-code="[[ color.code ]]"></dorel-checkbox>
        </div>
      </template>
    </div>
  </template>
  <script>
    Polymer({
      is: 'dorel-category-filter-colors',
      properties: {

        colors: {
          type: Array,
          value: function() {
            return [];
          }
        },

        queryParams: {
          type: Object,
          notify: true
        },

        filterData: {
          type: Array
        },

      },

      observers: [
        '_setInitial(filterData)',
        '_setChecked(queryParams)'
      ],

      _setInitial: function(filterData) {
        if(!filterData) {
          return;
        }

        this._setInitalChecked(filterData);
      },

      _setInitalChecked: function(filterData) {
        this.set('colors', []);
        var self = this;
        filterData.colors.forEach(function(color) {
          self.push('colors', color);
        });
      },

      _setChecked: function(queryParams) {
        var colorsParams = queryParams.color ? queryParams.color.split(',') : [];
        var filterData = this.get('filterData');
        if(filterData.colors) {
          var colors = filterData.colors.map(function(color){
            var existsInParams = Boolean(colorsParams.indexOf(color.name) > -1);
            color.checked = existsInParams;
            return color;
          });
          this.set('colors', colors);
        }
      },

      setFilters: function(e) {
        var color = this.$.colors.itemForElement(e.target);
        var queryParams = this.queryParams || {};

        var keyArray = queryParams.color ?  queryParams.color.split(',') : [];
        var item = keyArray.indexOf(color.name);

        if(item > -1) {
          // remove
          queryParams.color = keyArray.filter(function(item) {
            return item !== color.name;
          });
          if(!queryParams.color.length) {
            delete queryParams.color;
          }
        } else {
          // set
          if(!queryParams.color || !queryParams.color.length) {
            queryParams.color = [color.name];
          } else {
            keyArray.push(color.name);
            queryParams.color = keyArray;
          }
        }

        this.fire('update-filter', { value: queryParams });
      },

      created: function() {
        console.log('test', 'created');
      },

      detached: function() {
        console.log('test', 'detached');
      }

    });
  </script>

</dom-module>
