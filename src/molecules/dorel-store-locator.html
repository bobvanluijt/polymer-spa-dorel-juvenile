<link rel="import" href="../../bower_components/google-map/google-map.html">
<link rel="import" href="../../bower_components/paper-autocomplete.html">
<link rel="import" href="../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">

<dom-module id="dorel-store-locator">
  <template>
    <style>
      google-map {
        height: 600px;
      }
    </style>

    <google-maps-api id="api"
      api-key="[[apiKey]]"
      language="[[language]]"
      on-api-load="_mapApiLoaded"></google-maps-api>

    <section class="section-store-locator">
      <div class="store-overlay">
        <h3>Find a store</h3>
  

        <form is="iron-form" method="get" action="/" id="basic">

          <paper-dropdown-menu label="Select a country" required>
            <paper-menu attr-for-selected="name" selected="{{ selectedCountry }}" class="dropdown-content">
              <template
                is="dom-repeat"
                items="[[ countriesArr ]]"
                as="country">
                <paper-item name="{{ country }}">[[ country ]]</paper-item>
              </template>
            </paper-listbox>
          </paper-dropdown-menu>

          <paper-input label="Type in address" value="{{ address }}" required></paper-input>
        
          <paper-button type="submit" raised on-click="_submitLocator">Submit</paper-button>
        </form>

      </div>

      <google-map
        map="{{ map }}"
        disable-zoom="[[ disableZoom ]]"
        api-key="[[ apiKey ]]"
        latitude="{{ mapLat }}"
        longitude="{{ mapLng }}"
        zoom="{{ mapZoom }}">
          
        <!-- 
        <template
          is="dom-repeat"
          items="[[ countries ]]"
          as="country">
           <google-map-marker latitude="37.777" longitude="-122.38911"></google-map-marker>
        </template>
        -->

      </google-map>

    </section>
  </template>

  <script>
    Polymer({
      is: 'dorel-store-locator',

      properties: {
        apiKey: {
          type: String,
          value: 'AIzaSyBYMyWp_Ex0Vti2UUDNOs979yVJ5sts1iA'
        },

        disableZoom: {
          type: Boolean,
          value: true
        },

        mapLoaded: {
          type: Boolean,
          value: false
        },

        storesArr: {
          type: Array,
          value: function() {
            return [
              {
                name: 'Outlet Store 1',
                address: 'loremstreet 12',
                zipcode: '1234 ZS',
                city: 'Melbourne',
                country: 'Australia'
              },

              {
                name: 'VIP Store',
                address: 'Ipsumstreet 12',
                zipcode: '1778 ZS',
                city: 'Melbourne',
                country: 'Australia'
              },

              {
                name: 'VIP Store Sydney',
                address: 'Chachastreet 12',
                zipcode: '1778 ZS',
                city: 'Sydney',
                country: 'Australia'
              },

              {
                name: 'Dolly Shop',
                address: 'Dollystreet 16',
                zipcode: '1404 ES',
                city: 'Bussum',
                country: 'Netherlands'
              },

              {
                name: 'Dolly Shop',
                address: 'Dollystreet 16',
                zipcode: '1404 ES',
                city: 'Bussum',
                country: 'Germany'
              },

              {
                name: 'Dolly Shop',
                address: 'Dollystreet 16',
                zipcode: '1404 ES',
                city: 'Bussum',
                country: 'England'
              },

              {
                name: 'Dolly Shop',
                address: 'Dollystreet 16',
                zipcode: '1404 ES',
                city: 'Bussum',
                country: 'France'
              }
            ];
          }
        },

        countriesArr: {
          type: Array,
          value: []
        },

        countryStoresArr: {
          type: Array,
          value: []
        },

        selectedCountry: {
          type: String,
          value: 'australia',
          observer: '_setMapFocus'
        }
      },

      /**
       * @name listeners
       * @description listens to all different fires
       */
      listeners: {
        'google-map-ready': '_mapLoaded'
      },

      observers: [
        '_setMapZoom(mapLoaded, geometry)'
      ],

      _mapLoaded: function() {
        this.mapLoaded = true;
      },

      _mapApiLoaded: function() {
        this._initStoreLocator();
      },

      _initStoreLocator: function() {
        // create the geocoder object
        this.geocoder = new google.maps.Geocoder();

        // build up the countries arr for the countries dropdown
        this.countriesArr = this._retrieveCountries(this.storesArr);
        
        // set the maps focus for the preselected country
        this._setMapFocus(this.selectedCountry);
      },

      _setMapFocus: function(selectedCountry) {
        if (typeof this.geocoder === 'undefined' || typeof selectedCountry === 'undefined') return;

        var self = this;
        
        this._retrieveGeocode(this.selectedCountry).then(function(geometry) {
          self.mapLat = geometry.location.lat();
          self.mapLng = geometry.location.lng();
          self.geometry = geometry;
        });
      },

      _setMapZoom: function(loaded, geometry) {
        if (!loaded || typeof geometry === 'undefined') return;

        this.map.fitBounds(geometry.viewport);
      },

      _retrieveGeocode: function(address) {
        var self = this;

        return new Promise(function(resolve, reject){
          self.geocoder.geocode({'address': address}, function(results, status) {
            if (status === 'OK') {
              resolve(results[0].geometry);
            } else {
              reject();
            }
          });
       })
      },

      _retrieveCountries: function(stores) {
        if (typeof stores === 'undefined') return;

        var countries = [];
        
        for (var i = 0; i < stores.length; i++) {
          var country = stores[i].country.toLowerCase();

          if (countries.indexOf(country) < 0) {
            countries = countries.concat(country);
          }
        }

        return countries;
      },

      _submitLocator: function(e) {
        console.log(this.address, this.selectedCountry);

        var query = this.address + ' ' + this.selectedCountry;

        var service = new google.maps.places.AutocompleteService();
        service.getQueryPredictions({ input: query }, this._retrieveSuggestions);
      },

      _retrieveSuggestions: function(predictions, status) {
        if (status != google.maps.places.PlacesServiceStatus.OK) {
          alert(status);
          return;
        }

        this.prediction = predictions[0];
      }
    });
  </script>
</dom-module>
