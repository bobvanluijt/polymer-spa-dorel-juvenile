<dom-module id="dorel-third-party">
  <script>
    Polymer({
      is: 'dorel-third-party',

      properties: {

        /**
         * @name hubSpotToggle
         * @description defines the toggle defined in the WP theme settings
         * this is retrieved through the wp-collect-options and placed in
         * the globals object
         */
        hubSpotToggle: {
          type: Boolean
        },

        /**
         * @name hubSpotPortalId
         * @description defines portal ID defined in the WP theme settings
         * this is retrieved through the wp-collect-options and placed in
         * the globals object
         */
        hubSpotPortalId: {
          type: String
        },

        /**
         * @name hubSpotSrc
         * @description the third-party source of the JavaScript
         * non-minified: //js.hsforms.net/forms/v2-legacy.js
         * minified: //js.hsforms.net/forms/v2.js
         */
        hubSpotSrc: {
          type: String,
          value: '//js.hsforms.net/forms/v2.js'
        }
      },

      observers: [
        '_initHubSpot(hubSpotToggle, hubSpotPortalId, hubSpotSrc)'
      ],

      /** 
       * @name _initHubSpot
       * @description adds the hubspot javascript to the head and imports the
       * dorel-hubspot component
       *
       * @parameter hubSpotToggle Boolean - indicates wheter the toggle is set in WP
       * @parameter hubSpotPortalId String - the portal id of hubspot
       * @parameter hubSpotSrc String - the source of the hubspot javascript
       */
      _initHubSpot: function(hubSpotToggle, hubSpotPortalId, hubSpotSrc) {
        // make sure the toggle, portalId, src are set/true and if the script isn't included yet
        if ( typeof hubSpotToggle === 'undefined' || !hubSpotToggle ||
          typeof hubSpotPortalId === 'undefined' ||
          typeof hubSpotSrc === 'undefined' ||
          this._scriptExists(hubSpotSrc) ) return;
        
        var self = this;

        // create script tag
        var script = document.createElement('script');

        // add source of script
        script.src = hubSpotSrc;
        document.getElementsByTagName('head')[0].appendChild(script);

        // when the script has been loaded
        script.onload = function() {
          // import the dorel-hubspot component
          self.importHref(
            self.resolveUrl('../atoms/dorel-hubspot.html'), function() {
              Polymer.globalsManager.set('Dorel.collect.options.hubspot_loaded', true);
            }, null, false
          );
        };
      },

      /** 
       * @name _scriptExists
       * @description check if the script tag with the defined url is included 
       * already in the application
       *
       * @parameter String - url string
       */
      _scriptExists: function(url) {
        // select all scripts
        var scripts = document.getElementsByTagName('script');

        // check if we have a match
        for (var i = scripts.length; i--;) {
          return (scripts[i].src === url);
        }

        // return false if no match is found
        return false;
      }
    });
  </script>
</dom-module>
