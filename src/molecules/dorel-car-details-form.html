<link rel="import" href="../atoms/dorel-input-select.html">

<dom-module id="dorel-car-details-form">
  <template>
    <style>
      :host {
        width: 100%;
        padding: 0 .75rem;
        box-sizing: border-box;
      }
      .form {
        display: flex;
        flex-direction: column;
        background-color: #f5f5f5;
      }
      .form_title {
        padding: .75em 1.5em .75em .75em;
        @apply(--theme-typography-4);
        margin: 0;
        background-color: #505050;
        color: #fff;
        border-top-left-radius: var(--theme-button-border-radius);
        border-top-right-radius: var(--theme-button-border-radius);
      }
      .form_groups {
        padding: .75em .75em .75em .75em;
      }
    </style>
    <div class="form">

      <h2 class="form_title" on-click="[[ test ]]">[[ formData.form_title ]]</h2>
      <div class="form_groups">

        <template
          is="dom-repeat"
          id="test"
          items="{{ formData.form_groups }}"
          observe="disabled"
          as="item">
          <span>[[ item.disabled ]]</span>
          <dorel-input-select
            label="[[ item.label ]]"
            options="[[ item.options ]]"
            disabled$="[[ item.disabled ]]"
            required>
          </dorel-input-select>
        </template>
      </div>
     </div>

  </template>
  <script>
    Polymer({
      is: 'dorel-car-details-form',
      properties: {

        /**
         * @attribute
         * @name formData
         * @description Object that is passed by parent
         */
        formData: {
          type: Object,
          notify: true
        },

      },

      listeners: {
        'on-selectbox-change': '_processForm'
      },

      _processForm: function(event) {
        var updatedValue = event.detail.value;
        var formGroups = this.get('formData.form_groups');
        var groupIndex = this._getGroupIndex(formGroups, updatedValue);

        if(groupIndex > -1) {
          // this.set('formData.form_groups.' + groupIndex + '.value', updatedValue);
          this._resetSelectBoxes(formGroups, groupIndex);
        }
      },

      _getGroupIndex: function(formGroups, updatedValue) {
        return formGroups.findIndex(function(group) {
          return group.options.some(function(option) {
             return option.label === updatedValue.label;
          });
        });
      },

      _resetSelectBoxes: function(formGroups, groupIndex) {
        var newFormGroups = formGroups.map(function(group, index) {
          var newObject = {};
          Object.keys(group).forEach(function(key, index) {
            newObject[key] = group[key];
          });
          if(index > groupIndex) {
            newObject.value = '';
          }
          if(index === groupIndex + 1) {
            newObject.disabled = false;
          }
          return newObject;
        }, []);
        this.set('formData.form_groups', newFormGroups);
      },


    });
  </script>
</dom-module>
