<link rel="import" href="dropdowns/dorel-menu-dropdown-default.html">
<link rel="import" href="dropdowns/dorel-menu-dropdown-category.html">

<dom-module id="dorel-main-menu-item">
  <template>
    <style is="custom-style">
      h1, h2, h3, h4 {
        @apply(--theme-header-text-transform);
      }

      :host {
        display: flex;
        flex-direction: row;
        justify-content: center;
        flex: 1;
        color: var(--theme-color-monochrome-7);
        --iron-icon: transition: opacity 0.15s;
      }

      :host:hover {
        color: var(--theme-main-menu-text-link-color-active);
      }

      .menu-item {
        position: relative;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 0.5rem 0.25rem;
        cursor: pointer;
        height: 2em;
        @apply(--theme-main-menu-item);
      }

      .menu-item.category {
        position: static;
      }

      .link {
        margin: 0;
        transition: color 0.2s;
        text-decoration: none;
        display: flex;
        align-items: center;
        color: var(--theme-color-monochrome-7);
        outline: none;
      }

      .link::selection {
        background-color: transparent;
      }

      .link:visited {
        color: var(--theme-color-monochrome-7);
      }

      .menu-item:hover .link {
        color: var(--theme-main-menu-text-link-color-active);
      }

      [is-active] {
        color: var(--theme-brand-color-2);
      }

      .link-text {
        display: block;
        position: relative;
      }

      [is-active] .link-text::after {
        @apply(--theme-main-menu-selected-item-after)
      }

      [is-active] .link {
        color: var(--theme-main-menu-text-link-color-active);
        cursor: default;
      }

      [is-active].menu-item:hover .link {
        color: var(--theme-main-menu-text-link-color-active);
        cursor: default;
      }

      .menu-item__icon {
        @apply(--theme-main-menu-dropdown-icon)
      }

      .menu-item:hover .menu-item__icon {
        color: var(--theme-main-menu-text-link-color-active);
      }

      .menu-item__icon[opened] {
        transform: scaleY(-1);
      }

      .category-container {
        position: absolute;
        left: 0;
        right: 0;
        top: 0;
      }
      .category-container::after {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        min-height: 120vh;
        z-index: -10;
        background-color: rgba(0,0,0,0);
        pointer-events: none;
        content: '';
        opacity: 0;
        visibility: hidden;
        transition: 0.2s;
      }
      .category-container[opened]::after {
        background-color: rgba(0,0,0,0.32);
        visibility: visible;
        opacity: 1;
      }
    </style>

    <div class="menu-item" class$="{{ getClasses(mainItem) }}" is-active$="[[ isActive ]]">
      <template is="dom-if" if="[[ !mainItem.dropdown ]]">
        <a on-click="clickMainItem"
          class="link"
          href="[[ mainItem.link ]]">
          <span class="link-text">[[ mainItem.title ]]</span>
        </a>
      </template>

      <template is="dom-if" if="[[ mainItem.dropdown ]]">
        <div on-click="toggleDropdown"
          tabindex="0"
          class="link">
          <span class="link-text">[[ mainItem.title ]]</span>
          <iron-icon class="menu-item__icon" opened$="[[ opened ]]" icon="dorel-icons:expand-more"></iron-icon>
        </div>

        <template is="dom-if" if="[[ checkDropdownType(mainItem, 'default') ]]">
          <dorel-menu-dropdown-default
            index="[[ index ]]"
            main-item="[[ mainItem ]]"
            opened="[[ opened ]]"
            route="[[ route ]]"
            dropdown-items="[[ mainItem.dropdown_items ]]">
          </dorel-menu-dropdown-default>
        </template>

        <template is="dom-if" if="[[ checkDropdownType(mainItem, 'category') ]]">
          <div class="category-container" opened$="[[ opened ]]">
            <dorel-menu-dropdown-category
              index="[[ index ]]"
              main-item="[[ mainItem ]]"
              opened="[[ opened ]]"
              route="[[ route ]]"
              featured-items="[[ _contentSwitch(mainItem, products) ]]"
              dropdown-items="[[ mainItem.dropdown_items ]]">
            </dorel-menu-dropdown-category>
          </div>
        </template>

      </template>
    </div>


  </template>
  <script>
    class DorelMainMenuItem extends ReduxMixin(Polymer.mixinBehaviors([MainMenuBehavior], Polymer.Element)) {
      static get is() {
        return 'dorel-main-menu-item';
      }

      static get properties() {
        return {

          /**
           * @name mainItem
           * @description
           */
          mainItem: {
            type: Object
          },

          /**
           * @name index
           * @description index of the dom-repeat used for the gtm
           */
          index: {
            type: Number
          },

          /**
           * @name isActive
           * @description determines if menu item is active
           */
          isActive: {
            type: Boolean,
            reflectToAttribute: true
          },

          /**
           * @name products
           * @description will return products based on the category of the mainItem
           */
          products: {
            type: Array,
            statePath: function(state) {
              if (!this.get('mainItem') || !this.get('mainItem.category_id')) return;

              const categoryPicker = this.get('mainItem.category_id');

              if (categoryPicker.constructor === Array) {

                // (TODO) the wp category ids array items are strings, convert them to integers to compare with the magento product category ids
                const wpCatIdsToInt = categoryPicker.map(category => parseInt(category));

                // filter the products and get only the products that comply to the wp categories defined for this page
                return state.product.products.filter(product => {
                  return (product.categories.some(category => {
                    return wpCatIdsToInt.includes(category);
                  })) ? product : '';
                });

              } else if (!isNaN(categoryPicker)) {

                return state.product.products.filter((product, index) => {
                  return !(product.categories && product.categories.indexOf(categoryPicker));
                }).map((product) => {
                  return this.subCategoryItemMold(product);
                }).filter((item, index) => index < 5);

              }
            }
          },

          /**
           * @name route
           * @description current route / url of the application
           */
          route: {
            type: Object
          }
        };
      }

      /**
       * template helper
       * @name _contentSwitch
       * @description determines what data is passed down to the child component
       * if the productSwitch is not true it will set the default pages (sub_category_items) created by the menu-creator component
       * else it will return the products
       * @param mainItem - Object
       * @param products - Array
       * @returns Array
       */
      _contentSwitch(mainItem, products) {
        if(mainItem && !mainItem.productSwitch) {
          return mainItem.sub_category_items;
        } else {
          return products;
        }
      }

      /**
       * @name clickmainItem
       * @description closes the mobile menu and calls _emitGtmEvent
       * @param event - Object
       */
      clickMainItem(event) {
        this._emitGtmEvent(event);
        this.clickOutsideListen();
      }

      /**
       * @name toggleDropdown
       * @description if a dropdown is clicked it will dispatch a event with the index
       * @param event - Object
       */
      toggleDropdown(event) {
        this.dispatchEvent(new CustomEvent('toggleDropdown', { bubbles: true, composed: true, detail: {
          value: this.get('index')
        }}));
      }

      /**
       * @name getClasses
       * @description template helper that will determine the classes that will be added
       * @param mainItem - Object
       */
      getClasses(mainItem) {
        if(this.checkDropdownType(mainItem, 'category')) {
          return 'menu-item category';
        }
        return 'menu-item';
      }

      /**
       * @name subCategoryItemMold
       * @description a function that returns a suitable data model for a subcategory item
       * @param product - Object
       * @returns Object
       */
      subCategoryItemMold(product) {
        // determines if the product has childproducts and sets either the single or the first childproduct
        const selected = product.child_products ? product.child_products[0] : product;
        return {
          id: Number(product.id),
          link: this.mainItem.link + product.url,
          thumbnail_url: selected.images ? selected.images.image : '',
          title: product.name ? product.name.value : '',
          sub_title: selected.header_section ? selected.header_section.sub_title : ''
        };
      }
    }
    customElements.define(DorelMainMenuItem.is, DorelMainMenuItem);
  </script>
</dom-module>
