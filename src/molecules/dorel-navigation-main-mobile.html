<link rel="import" href="../../bower_components/app-layout/app-drawer/app-drawer.html">
<link rel="import" href="../atoms/dorel-accordion-item.html">
<link rel="import" href="../../bower_components/app-route/app-location.html">
<link rel="import" href="../../bower_components/app-route/app-route.html">

<dom-module id="dorel-navigation-main-mobile">
  <template>
    <style>

      #drawer {
        z-index: 10;
        display: flex;
        flex-direction: column;
        text-align: left;
      }

      .menu-spacer-top {
        height: 4.5rem;
        position: relative;
      }

      [tablet-medium-up] .menu-spacer-top {
        height: 6rem;
      }

      .menu-spacer-top::before {
        content: "";
        position: absolute;
        bottom: -.75em;
        left: 0;
        height: .75em;
        z-index: 2;
        width: 100%;

        /* Permalink - use to edit and share this gradient: http://colorzilla.com/gradient-editor/#000000+0,000000+100&0.13+0,0+100 */
        background: -moz-linear-gradient(top, rgba(0, 0, 0, 0.13) 0%, rgba(0, 0, 0, 0) 100%); /* FF3.6-15 */
        background: -webkit-linear-gradient(top, rgba(0, 0, 0, 0.13) 0%, rgba(0, 0, 0, 0) 100%); /* Chrome10-25,Safari5.1-6 */
        background: linear-gradient(to bottom, rgba(0, 0, 0, 0.13) 0%, rgba(0, 0, 0, 0) 100%); /* W3C, IE10+, FF16+, Chrome26+, Opera12+, Safari7+ */
        filter: progid:DXImageTransform.Microsoft.gradient(startColorstr='#21000000', endColorstr='#00000000', GradientType=0); /* IE6-9 */
      }


      .mobile-nav {
        background-color: var(--theme-color-monochrome-2);
        overflow: auto;
        height: calc(100vh - 7.5rem);
        overflow: auto;
        flex: 1;
        display: flex;
        width: 100%;
        margin-bottom: 4.5rem;
      }

      [tablet-medium-up] .mobile-nav {
        height: calc(100vh - 9rem);
      }

      .main-menu {
        padding: .75rem .75rem;
        width: 100%;
        flex-direction: column;
        list-style-type: none;
        margin: 0;
      }

      .main-menu--item {
        background-color: var(--theme-color-monochrome-1);
        border-radius: 5px;
        overflow: hidden;
        margin-bottom: .75rem;
        min-height: min-content;
      }

      .link {
        @apply(--theme-typography-2);
        margin: 0;
        color: var(--theme-color-text-link);
        transition: color 0.2s;
        text-decoration: none;
        display: block;
      }

      .sub-menu .link::before {
        content: '-';
      }

      .link:visited {
        color: var(--theme-color-text-link);
      }

      .link:hover {
        color: var(--theme-color-text-link-active);
      }

      .link[active] {
        color: var(--theme-color-text-link-active);
      }

      .main-menu--link {
        @apply(--theme-typography-2);
        margin: 0;
        padding: .75rem;
        display: block;
      }

      .sub-menu {
        list-style-type: none;
        margin: 0;
        padding: .75rem 0 .75rem  0;
      }

      .cta {
        width: 100%;
        min-height: 2.1rem;
        display: block;
      }

      .sub-menu__item {
        margin-top: .75rem;
        min-height: 1.5rem;
        line-height: 1.5rem;
      }

      .sub-menu__item:first-child {
        margin-top: 0;
      }

      .mobile-multi-language {
        position: fixed;
        z-index: 99999;
        right: 0;
        width: 256px;
        bottom: 0;
      }

      .mobile-multi-language-container {
        float: left;
        width: 100%;
        height: 3em;
        position: absolute;
        bottom: -50px;
        padding: 0 var(--theme-gutter-mobile);
        box-sizing: border-box;
        opacity: 0;
        transition: 0.1s 0s ease;
      }

      [mobile-opened] .mobile-multi-language-container {
        bottom: 0;
        opacity: 1;
        transition: 0.15s 0.2s ease;
      }

      .mobile-multi-language-container dorel-multilingual-select-language {
        float: right;
      }

    </style>

    <!-- define routing -->
    <app-location route="{{ route }}"></app-location>
    <app-route
      route="{{ route }}"
      pattern="/:page"
      data="{{ routeData }}"
      query-params="{{ queryParams }}"
      tail="{{ subroute }}"></app-route>

    <dorel-media-query breakpoints="{{ breakpoints }}"></dorel-media-query>

    <app-drawer id="drawer" opened="{{ mobileMenuOpened }}" align="right" swipe-open tabindex="0" tablet-medium-up$="[[ breakpoints.tabletMediumUp ]]">
      <div class="menu-spacer-top"></div>
      <nav class="mobile-nav">
        <ul class="main-menu">
            <template is="dom-repeat" items="[[ menuItems ]]" as="mainItem">

              <!-- Normal link -->
              <template is="dom-if" if="[[ !mainItem.dropdown ]]">
                <li class="main-menu--item">
                  <a on-click="closeMenu"
                    class="main-menu--link link"
                    active$="[[ checkIfActive(mainItem.link, route) ]]"
                    href="[[ mainItem.link ]]">
                    [[ mainItem.title ]]
                  </a>
                </li>
              </template>

              <template is="dom-if" if="[[ mainItem.dropdown ]]">
                <li class="main-menu--item">
                  <dorel-accordion-item
                    small="true"
                    opened$="[[ mainItem.opened ]]"
                    item-id$="[[ mainItem.id ]]"
                    on-click="_openAccordion"
                    heading="[[ mainItem.title ]]">

                    <template is="dom-if" if="[[ checkIfCategoryItems(mainItem) ]]">
                      <ul class="sub-menu">
                        <template is="dom-repeat" items="[[ getItems(mainItem, 'sub_category_items') ]]" as="dropdownItem">
                          <li class="sub-menu__item">
                              <a on-click="closeMenu"
                                class="link"
                                gtm-parent="dorel-navigation-main"
                                gtm-parent-index="[[ index ]]"
                                active$="[[ checkIfActive(dropdownItem.link, route) ]]"
                                href="[[ dropdownItem.link ]]">
                                [[ dropdownItem.title ]]
                              </a>
                          </li>
                        </template>
                      </ul>
                    </template>

                    <template is="dom-if" if="[[ checkIfCategoryItems(mainItem) ]]">
                      <dorel-cta
                        gtm-parent="dorel-navigation-main"
                        gtm-parent-index="1"
                        type="tertiary"
                        on-click="closeMenu"
                        no-margin
                        class="cta"
                        link="[[ mainItem.link ]]"
                        title="[[ mainItem.title ]]">
                        <span>All [[ mainItem.title ]]</span>
                      </dorel-cta>
                    </template>

                    <ul class="sub-menu">
                      <template is="dom-repeat" items="[[ getItems(mainItem, 'dropdown_items') ]]" as="dropdownItem" filter="[[ filterDropdownItems(mainItem) ]]">
                        <li class="sub-menu__item">
                            <a on-click="closeMenu"
                              class="link"
                              gtm-parent="dorel-navigation-main"
                              gtm-parent-index="[[ index ]]"
                              active$="[[ checkIfActive(dropdownItem.link, route) ]]"
                              href="[[ dropdownItem.link ]]">
                              [[ dropdownItem.title ]]
                            </a>
                        </li>
                      </template>
                    </ul>


                  </dorel-accordion-item>
                </li>
              </template>
            </template>
        </ul>
      </nav>
    </app-drawer>

    <div class="mobile-multi-language" mobile-opened$="[[ mobileMenuOpened ]]">
      <div class="mobile-multi-language-container">
        <dorel-multilingual-select-language
            current-language="{{ currentLanguage }}"
            continents-data="[[ continentsData ]]">
        </dorel-multilingual-select-language>
      </div>
    </div>

  </template>

  <script>

    Polymer({
      is: 'dorel-navigation-main-mobile',
      properties: {

        menuItems: {
          type: Array,
          value: function() {
            return [];
          }
        },

        mobileMenuOpened: {
          type: Boolean,
          reflectToAttribute: true,
          notify: true
        },

      },

      _openAccordion: function(event) {
        var accordionId = parseInt(event.target.getAttribute('item-id'));
        //close previous opened
        var shouldCloseIndex = this._findOpenedItemIndex(this.get('menuItems'));
        var shouldOpenIndex =  this._findItemIndex(this.get('menuItems'), accordionId);
        if(shouldOpenIndex === shouldCloseIndex) {
          return;
        }
        this.set('menuItems.' + shouldCloseIndex + '.opened', false);
        this.set('menuItems.' + shouldOpenIndex + '.opened', true);
      },

      _findItemIndex: function(items, id) {
        return items.findIndex(function(item) {
          return item.id === id;
        });
      },

      _findOpenedItemIndex: function(items) {
        return items.findIndex(function(item) {
          return item.opened === true;
        });
      },

      getItems: function(item, path) {
        return item && item[path] ? item[path] : [];
      },

      checkIfCategoryItems: function(mainItem) {
        return Boolean(this.isDropdownTypeCategory(mainItem) && mainItem.sub_category_items && mainItem.sub_category_items.length);
      },

      isDropdownTypeCategory: function(mainItem) {
        return Boolean(mainItem && mainItem.dropdown_type === 'category');
      },

      filterDropdownItems: function(mainItem, index) {
        var self = this;
        return function(item) {
          // if dropdownType is category we should only show the first item
          if(self.isDropdownTypeCategory(mainItem)) {
            return mainItem.dropdown_items[0].id === item.id ? true : false;
          } else {
            return true;
          }
        };
      },

      closeMenu: function(event) {
        this.set('mobileMenuOpened', false);
        this._menuItemTap(event);
      },

      checkIfActive: function(link, route) {
        return Boolean(link && link.split('/').join('') === (window.location.origin + route.path).split('/').join(''));
      },

      /**
       * @name _menuItemTap
       * @description handles all menu item clicks
       */
      _menuItemTap: function (event) {

        var element = Polymer.dom(event).localTarget;
        var event = {
          action: 'click',
          component: 'navigation',
          structure: {
            name: 'dorel-navigation-main',
            index: Number(element.gtmParentIndex) + 1
          },
          element: element,
          event: 'polymer_event',
          things: {
            'currentPage': document.URL,
            'targetPage': element.href
          }
        };
        this.fire('setAppCache', {value: event, path: 'events'});
      }

    });

  </script>

</dom-module>
