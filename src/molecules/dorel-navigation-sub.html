<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../../bower_components/paper-menu/paper-submenu.html">

<dom-module id="dorel-navigation-sub">
  <template>
    <style>

      .section-secondary-menu {
        background-color: var(--theme-color-white);
        width: 100%;
        position: absolute;
        left: 0;
        top: 3em;
        z-index: 2;
        -webkit-box-shadow: 0px 10px 10px 0px rgba(0, 0, 0, 0.13);
        -moz-box-shadow: 0px 10px 10px 0px rgba(0, 0, 0, 0.13);
        box-shadow: 0px 10px 10px 0px rgba(0, 0, 0, 0.13);
      }

      [compact-menu] .section-secondary-menu {
        top: 2.5em;
      }

      .menu-item-container {
        position: relative;
      }

      .menu-item-container .section-secondary-menu {
        visibility: hidden;
        opacity: 0;
      }

      .menu-item-container[opened] .section-secondary-menu {
        visibility: visible;
        opacity: 1;
      }

      .sub-menu {
        list-style-type: none;
        margin: 0;
        float: left;
        padding: 0;
        width: 100%;

      }

      .sub-menu a {
        color: var(--theme-primary-text-color);
        float: left;
        width: 100%;
        padding: .75em 1.5em;
      }

      paper-submenu paper-item {
        @apply(--theme-typography-2);
        margin-top: 0;
      }

      paper-submenu paper-item.iron-selected {
        font-weight: normal !important;
      }

      paper-submenu a, .sub-menu a {
        text-transform: capitalize;
        color: var(--theme-color-black);
        text-decoration: none;
      }

      paper-submenu {
        text-transform: capitalize;
        font-weight: 100 !important;
      }

      paper-submenu .menu-content {
        background-color: var(--theme-color-monochrome-2);
        padding: 0;
      }

      dorel-tab {
        padding: .75em 0 .75em 2em;
        text-transform: capitalize;
        height: 1.5rem;
        cursor: pointer;
        transition: color .3s ease;
      }

      .has-submenu dorel-safe-html, paper-submenu a, .sub-menu a {
        transition: color .3s ease;
      }

      .has-submenu:hover dorel-safe-html,
      .has-submenu:focus dorel-safe-html,
      paper-submenu a:hover,
      .sub-menu a:hover,
      paper-submenu:hover, dorel-tab:hover {
        color: var(--theme-color-text-link-active);
        cursor: pointer;
      }

      [tablet-medium-up] .section-secondary-menu {
        top: 2.75em;
      }

      dorel-tab, dorel-safe-html {
        float: left;
        display: inline-block;
      }

      iron-icon {
        padding-left: .25em;
        margin-top: -2px;
        width: 1.5em;
        display: inline-block;
      }

    </style>

    <dorel-media-query breakpoints="{{ breakpoints }}"></dorel-media-query>

    <!-- 
      Mobile Sub 
    -->
    <template is="dom-if" if="{{ !breakpoints.desktopSmallUp }}">
      <paper-submenu opened$="{{ thisOpened }}">
        <paper-item class="menu-trigger layout horizontal justified"
                    on-click="_dropdownToggle">
          [[_unescapeHtml(menuItem.title)]]
          <template
            is="dom-if"
            if="{{ thisOpened }}">
            <iron-icon icon="dorel-icons:expand-less"></iron-icon>
          </template>
          <template
            is="dom-if"
            if="{{ !thisOpened }}">
            <iron-icon icon="dorel-icons:expand-more"></iron-icon>
          </template>
        </paper-item>
        <paper-menu class="menu-content">
          <a href="[[ menuItem.url ]]"
             on-click="_menuItemClicked"
             gtm-parent="[[ gtmParent ]]"
             gtm-child-index="[[ gtmChildIndex ]]"
             gtm-index="0">
            <paper-item>View All</paper-item>
          </a>
          <template
            is="dom-repeat"
            items="[[ menuItem.children ]]"
            as="child">
            <a href="[[ child.url ]]" title="[[ child.title ]]"
               on-click="_menuItemClicked"
               gtm-parent="[[ gtmParent ]]"
               gtm-parent-index="[[ gtmParentIndex ]]"
               gtm-child-index="[[ gtmChildIndex ]]"
               gtm-index="0">
              <paper-item>[[ _unescapeHtml(child.title) ]]</paper-item>
            </a>
          </template>
        </paper-menu>
      </paper-submenu>
    </template>

    <!-- 
      Desktop sub 
    -->
    <template is="dom-if" if="{{ breakpoints.desktopSmallUp }}">
      <div class="menu-item-container"
           compact-menu$="[[ compactMenu ]]"
           opened$="{{ thisOpened }}"
           tablet-medium-up$="{{ breakpoints.tabletMedium }}">
        <dorel-tab
          id="dropdown"
          class="has-submenu"
          name="[[ menuItem.title ]]"
          on-click="_dropdownToggle"
          gtm-parent="[[ gtmParent ]]"
          gtm-parent-index="[[ gtmParentIndex ]]">
          [[ _unescapeHtml(menuItem.title) ]]
          <template
            is="dom-if"
            if="{{ thisOpened }}">
            <iron-icon icon="dorel-icons:expand-less"></iron-icon>
          </template>
          <template
            is="dom-if"
            if="{{ !thisOpened }}">
            <iron-icon icon="dorel-icons:expand-more"></iron-icon>
          </template>
        </dorel-tab>
        <section class="section-secondary-menu layout horizontal">
          <div>
            <ul class="sub-menu">
              <li>
                <a href="[[ menuItem.url ]]"
                   class="view-all"
                   on-click="_menuItemClicked"
                   gtm-parent="[[ gtmParent ]]"
                   gtm-parent-index="[[ gtmParentIndex ]]"
                   gtm-child-index="[[ gtmChildIndex ]]"
                   gtm-index="0">View All</a>
              </li>
              <template
                is="dom-repeat"
                items="[[ menuItem.children ]]"
                as="child">
                <li>
                  <a href="[[ child.url ]]"
                     on-click="_menuItemClicked"
                     gtm-parent="[[ gtmParent ]]"
                     gtm-parent-index="[[ gtmParentIndex ]]"
                     gtm-child-index="[[ gtmChildIndex ]]"
                     gtm-index="[[ index ]]">[[ _unescapeHtml(child.title) ]]</a>
                </li>
              </template>
            </ul>
          </div>
        </section>
      </div>
    </template>
  </template>

  <script>
    Polymer({

      is: 'dorel-navigation-sub',

      properties: {

        /**
         * @attribute
         * @name subMenuOpened
         * @description variable that indicates that one of the submenus
         * is opened
         */
        subMenuOpened: {
          type: Boolean,
          value: false,
          notify: true,
          observer: '_closeThisOpened'
        },

        /**
         * @attribute
         * @name mobileMenuOpened
         * @description variable indicator for the mobile menu to be opened/closed
         */
        mobileMenuOpened: {
          type: Boolean,
          value: false,
          notify: true
        },

        /**
         * @attribute
         * @name searchOpened
         * @description variable indicator for the search to be opened/closed
         */
        searchOpened: {
          type: Boolean,
          value: false,
          notify: true
        },

        /**
         * @attribute
         * @name activeId
         * @description the active menuItem.ID, the one that should be currently
         * activated
         */
        activeId: {
          type: Number,
          notify: true,
          observer: '_setThisOpened'
        },

        /**
         * @name thisOpened
         * @description this variable determines if the current scoped
         * menuItem is opened
         */
        thisOpened: {
          type: Boolean,
          value: false
        },

        /**
         * @name menuItem
         * @description the menuItem object coming from WordPress
         */
        menuItem: {
          type: Object
        }
      },

      listeners: {
        'tap': '_onTap', // used for generic analytics
      },

      _onTap: function (event) {
        // Define parent and child gtm info
        var gtmParent = this.gtmParent;
        var gtmParentIndex = Number(this.gtmParentIndex) + 1;
        var gtmChildIndex = Number(this.gtmChildIndex) + 1;

        if (Polymer.dom(event).rootTarget.tagName === 'A') {
          // retarget to right element
          var element = Polymer.dom(event).rootTarget;

          // view all is always first
          var increment = element.classList.contains('view-all') ? 1 : 2;

          // set the elements index
          var gtmIndex = Number(element.getAttribute('gtm-index')) + increment;

          // send event data to tracking function
          var event = {
            action: 'click',
            component: 'navigation',
            structure: {
              name: gtmParent,
              index: gtmParentIndex,
              child: {
                name: 'dorel-navigation-sub',
                index: 1, // always one for submenus
                event: {
                  name: 'submenu-item',
                  index: gtmIndex
                }
              }
            },
            element: element,
            event: 'polymer_event'
          };

          this.fire('setAppCache', {value: event, path: 'events'});

        } else {
          // retarget to right element
          var element = Polymer.dom(event).localTarget;

          var event = {
            action: (this.subMenuOpened) ? 'open' : 'close',
            component: 'navigation',
            structure: {
              name: gtmParent,
              index: gtmParentIndex,
              event: {
                name: 'dorel-navigation-sub',
                index: 1 // always one for submenus
              }

            },
            element: element,
            event: 'polymer_event'
          };

          // send event data to tracking function
          this.fire('setAppCache', {value: event, path: 'events'});
        }
      },

      /**
       * @name _closeThisOpened
       * @description observer of the subMenuOpened. When this is false it should
       * set the thisOpened variable to false
       *
       * example: search is opened, it should then close the sub menu
       */
      _closeThisOpened: function (newVal, oldVal) {
        // if undefined or true stop script
        if (typeof newVal === 'undefined' || newVal) return;

        // set thisOpened to false
        this.thisOpened = newVal;
      },

      /**
       * @name _setThisOpened
       * @description observer for the activeId variable, it is used to set the
       * thisOpened variable
       */
      _setThisOpened: function (activeId) {
        // activeId or menuItem not defined stop script
        if (typeof activeId === 'undefined' || typeof this.menuItem === 'undefined') return;

        // if activeId and menuItem are the same use toggle to thisOpened
        if (activeId === this.menuItem.ID) {
          this.thisOpened = !this.thisOpened;

          // if activeId and menuItem are not the same always set thisOpened to false
        } else if (activeId !== this.menuItem.ID) {
          this.thisOpened = false;
        }
      },

      /**
       * @name _dropdownToggle
       * @description When a dropdown item is clicked this will be triggered
       */
      _dropdownToggle: function (event) {
        // disable href, if set
        event.preventDefault();

        // set self to use it in scroll function
        var self = this;

        /**
         * set the searchOpened to false because it needs to be disabled
         * otherwise it will conflict the submenu that will be opened
         */
        self.searchOpened = false;

        /**
         * if the activeId isn't currently set the subMenuOpened should be false
         * this means we can use the toggle mode
         */
        if (typeof self.activeId === 'undefined') {
          self.subMenuOpened = !self.subMenuOpened;

          /**
           * if the activeId is not the same as the menuItem.ID it means
           * not this menu item is currently active but it should become active
           * this is why the subMenuOpened should always be set to true (or stay true)
           */
        } else if (self.activeId !== self.menuItem.ID) {
          self.subMenuOpened = true;

          /**
           * if the activeId is the same as the menuItem.ID we know for sure
           * someone wants to 'close' the active open submenu and thats why we
           * set the subMenuOpened to false in this case
           */
        } else if (self.activeId === self.menuItem.ID) {
          self.subMenuOpened = false;
        }

        /**
         * After the subMenuOpened variable is set we will define the
         * activeId variable
         */
        self.setActiveId();

        /**
         * event listener to disable submenu on scroll
         */
        window.onscroll = function (events) {
          self.subMenuOpened = false;
        }
      },

      /**
       * @name setActiveId
       * @description function to set the activeId variable/attribute to the
       * one that is clicked
       */
      setActiveId: function () {
        this.activeId = (this.subMenuOpened) ? this.menuItem.ID : null;
      },

      /**
       * @name _menuItemClicked
       * @description this function will reset all states to the default (false)
       */
      _menuItemClicked: function (event) {
        // reset all handlers
        this.mobileMenuOpened = false;
        this.subMenuOpened = false;
        this.searchOpened = false;
        this.activeId = null;
      },

      /**
       * @name _unescapeHtml
       * @description decode html special chars, and output the correct string
       */
      _unescapeHtml: function (text) {
        var el = document.createElement('div');
        el.innerHTML = text;
        return el.childNodes.length === 0 ? "" : el.childNodes[0].nodeValue;
      }
    });
  </script>
</dom-module>
