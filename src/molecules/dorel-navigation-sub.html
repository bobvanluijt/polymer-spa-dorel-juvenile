<dom-module id="dorel-navigation-sub">
  <template>
    <style>
      .section-secondary-menu {
        background-color: #F5F5F5;
        width: 100%;
        left: 0;
        position: absolute;
        margin-top: 3rem;
        z-index: 1050;
      }
      .menu-item-container .section-secondary-menu {
        visibility: hidden;
        opacity: 0;
      }
      .menu-item-container[opened] .section-secondary-menu {
        visibility: visible;
        opacity: 1;
      }
      .sub-menu {
        list-style-type: none;
      }
      .sub-menu a {
        color: var(--theme-primary-text-color);
        text-decoration: none;
        text-transform: capitalize;
      }
      dorel-tab {
        padding: 5px 10px;
        margin: 0 10px;
        text-transform: capitalize;
      }
      dorel-tab a {
        color: var(--theme-primary-text-color);
        text-decoration: none;
      }
      dorel-tab:hover {
        color: var(--theme-color-hover);
      }
      dorel-tab.has-submenu:hover {
        cursor: pointer;
      }
    </style>
    <div class="menu-item-container" opened$="{{ thisOpened }}">
      <dorel-tab
        class="has-submenu" 
        name="[[ menuItem.title ]]"
        on-click="dropdownToggle">
        [[ menuItem.title ]]
        <template
          is="dom-if"
          if="{{ thisOpened }}">
          <iron-icon icon="dorel-icons:expand-less"></iron-icon>
        </template>
        <template
          is="dom-if"
          if="{{ !thisOpened }}">
          <iron-icon icon="dorel-icons:expand-more"></iron-icon>
        </template>
      </dorel-tab>
      <section class="section-secondary-menu layout horizontal">
        <!--
          @Marnix:
          TODO: Iterate through submenu's
        -->
        <div>
          <ul class="sub-menu">
            <template
              is="dom-repeat"
              items="[[ menuItem.children ]]"
              as="child">
              <li>
                <a href="[[ child.url ]]"
                  on-click="menuItemClicked">[[ child.title ]]</a>
              </li>
            </template>
          </ul>
        </div>
      </section>
    </div>
  </template>

  <script>
    Polymer({

      is: 'dorel-navigation-sub',

      properties: {
        /**
         * @name subMenuOpened
         * @description variable that indicates that one of the submenus
         * is opened
         */
        subMenuOpened: {
          type: Boolean,
          value: false,
          notify: true
        },

        /**
         * @name thisOpened
         * @description this variable determines if the current scoped
         * menuItem is opened
         */
        thisOpened: {
          type: Boolean,
          value: false
        },


        /**
         * @name menuItem
         * @description the menuItem object coming from WordPress
         */
        menuItem: {
          type: Object
        },

        /**
         * @name activeId
         * @description the active menuItem.ID, the one that should be currently
         * activated
         */
        activeId: {
          type: Number,
          notify: true,
          observer: '_setThisOpened'
        }
      },

      /** 
       * @name _setThisOpened
       * @description observer for the activeId variable, it is used to set the
       * thisOpened variable
       */
      _setThisOpened: function(activeId) {
        if (typeof activeId === 'undefined' || typeof this.menuItem === 'undefined') return;

        if (activeId === this.menuItem.ID) {
          this.thisOpened = !this.thisOpened;
        } else if (activeId !== this.menuItem.ID) {
          this.thisOpened = false;
        }
      },

      /**
       * @name dropdownToggle
       * @description When a dropdown item is clicked this will be triggered
       */
      dropdownToggle: function(event) {
        // disable href, if set
        event.preventDefault();

        // set self to use it in scroll function
        var self = this;

        /**
         * set the searchOpened to false because it needs to be disabled
         * otherwise it will conflict the submenu that will be opened
         */
        self.searchOpened = false;

        /**
         * if the activeId isn't currently set the subMenuOpened should be false
         * this means we can use the toggle mode
         */
        if (typeof self.activeId === 'undefined') {
          self.subMenuOpened = !self.subMenuOpened;

        /**
         * if the activeId is not the same as the menuItem.ID it means
         * not this menu item is currently active but it should become active
         * this is why the subMenuOpened should always be set to true (or stay true)
         */
        } else if (self.activeId !== self.menuItem.ID) {
          self.subMenuOpened = true;

        /**
         * if the activeId is the same as the menuItem.ID we know for sure
         * someone wants to 'close' the active open submenu and thats why we
         * set the subMenuOpened to false in this case
         */
        } else if (self.activeId === self.menuItem.ID) {
          self.subMenuOpened = false;
        }

        /**
         * After the subMenuOpened variable is set we will define the
         * activeId variable
         */
        self.setActiveId();

        // send tracking data
        self._eventTracking(event, 'dropdownToggle');

        /**
         * event listener to disable submenu on scroll 
         */
        window.onscroll = function(events) {
          self.subMenuOpened = false;
        }
      },

      /**
       * @name setActiveId
       * @description function to set the activeId variable/attribute to the 
       * one that is clicked
       */
      setActiveId: function() {
        this.activeId = (this.subMenuOpened) ? this.menuItem.ID : null;
      },

      /**
       * @name menuItemClicked
       * @description this function will reset all states to the default (false)
       */
      menuItemClicked: function(event) {
        // reset all handlers
        this.mobileMenuOpened = false;
        this.subMenuOpened = false;
        this.searchOpened = false;
        this.activeId = null;

        // send event to tracking
        this._eventTracking(event, 'switch');
      },

      /**
       * @name _eventTracking
       * @description sets the right properties for event tracking
       */
      _eventTracking: function(event, type) {
        var eventData = {
          action: type,
          component: 'navigation',
          element: Polymer.dom(event).localTarget,
          event: 'polymer_event'
        };

        // if dropdownToggle overwrite the state
        if (type === 'dropdownToggle') {
          eventData.action = (this.subMenuOpened) ? 'open' : 'close';
        }

        Polymer.globalsManager.set('Dorel.events', eventData);
      }
    });
  </script>
</dom-module>