<dom-module id="dorel-navigation-sub">
  <template>
    <style>
      .section-secondary-menu {
        background-color: #F5F5F5;
        width: 100%;
        left: 0;
        position: absolute;
        margin-top: 3rem;
        z-index: 1050;
      }
      .menu-item-container .section-secondary-menu {
        visibility: hidden;
        opacity: 0;
      }
      .menu-item-container[opened] .section-secondary-menu {
        visibility: visible;
        opacity: 1;
      }
      .sub-menu {
        list-style-type: none;
      }
      .sub-menu a {
        color: var(--theme-primary-text-color);
        text-decoration: none;
        text-transform: capitalize;
      }
      paper-submenu .menu-content {
        background-color: var(--theme-color-background-tertiary);
      }
      dorel-tab {
        padding: 5px 10px;
        margin: 0 10px;
        text-transform: capitalize;
      }
      dorel-tab a {
        color: var(--theme-primary-text-color);
        text-decoration: none;
      }
      dorel-tab:hover {
        color: var(--theme-color-hover);
      }
      dorel-tab.has-submenu:hover {
        cursor: pointer;
      }
    </style>

    <iron-media-query query="(max-width : 767px)"
      query-matches="{{ screenSmall }}"></iron-media-query>
    <iron-media-query query="(min-width : 768px) and (max-width : 991px)"
      query-matches="{{ screenMedium }}"></iron-media-query>
    <iron-media-query query="(min-width : 768px)"
      query-matches="{{ screenMediumUp }}"></iron-media-query>

    <!-- Desktop sub -->    
    <template is="dom-if" if="{{ screenMediumUp }}">
      <div class="menu-item-container" opened$="{{ thisOpened }}">
        <dorel-tab
          class="has-submenu" 
          name="[[ menuItem.title ]]"
          on-click="dropdownToggle">
          [[ menuItem.title ]]
          <template
            is="dom-if"
            if="{{ thisOpened }}">
            <iron-icon icon="dorel-icons:expand-less"></iron-icon>
          </template>
          <template
            is="dom-if"
            if="{{ !thisOpened }}">
            <iron-icon icon="dorel-icons:expand-more"></iron-icon>
          </template>
        </dorel-tab>
        <section class="section-secondary-menu layout horizontal">
          <!--
            @Marnix:
            TODO: Iterate through submenu's
          -->
          <div>
            <ul class="sub-menu">
              <template
                is="dom-repeat"
                items="[[ menuItem.children ]]"
                as="child">
                <li>
                  <a href="[[ child.url ]]"
                    on-click="menuItemClicked">[[ child.title ]]</a>
                </li>
              </template>
            </ul>
          </div>
        </section>
      </div>
    </template>
    
    <!-- Mobile Sub -->
    <template is="dom-if" if="{{ !screenMediumUp }}">
      <paper-submenu opened$="{{ thisOpened }}">
        <paper-item class="menu-trigger layout horizontal justified"
          on-click="dropdownToggle">
          [[ menuItem.title ]]
          <template
            is="dom-if"
            if="{{ thisOpened }}">
            <iron-icon icon="dorel-icons:expand-less"></iron-icon>
          </template>
          <template
            is="dom-if"
            if="{{ !thisOpened }}">
            <iron-icon icon="dorel-icons:expand-more"></iron-icon>
          </template>
        </paper-item>
        <paper-menu class="menu-content">
          <template
            is="dom-repeat"
            items="[[ menuItem.children ]]"
            as="child">
            <a href="[[ child.url ]]" title="[[ child.title ]]"
              on-click="menuItemClicked">
              <paper-item>[[ child.title ]]</paper-item>
            </a>
          </template>
        </paper-menu>
      </paper-submenu>
    </template>
  </template>

  <script>
    Polymer({

      is: 'dorel-navigation-sub',

      properties: {
        /**
         * @name subMenuOpened
         * @description variable that indicates that one of the submenus
         * is opened
         */
        subMenuOpened: {
          type: Boolean,
          value: false,
          notify: true,
          observer: '_closeThisOpened'
        },

        /**
         * @name mobileMenuOpened
         * @description variable indicator for the mobile menu to be opened/closed
         */
        mobileMenuOpened: {
          type: Boolean,
          value: false,
          notify: true
        },

        /**
         * @name searchOpened
         * @description variable indicator for the search to be opened/closed
         */
        searchOpened: {
          type: Boolean,
          value: false,
          notify: true
        },

        /**
         * @name thisOpened
         * @description this variable determines if the current scoped
         * menuItem is opened
         */
        thisOpened: {
          type: Boolean,
          value: false
        },

        /**
         * @name menuItem
         * @description the menuItem object coming from WordPress
         */
        menuItem: {
          type: Object
        },

        /**
         * @name activeId
         * @description the active menuItem.ID, the one that should be currently
         * activated
         */
        activeId: {
          type: Number,
          notify: true,
          observer: '_setThisOpened'
        }
      },

      /**
       * @name _closeThisOpened
       * @description observer of the subMenuOpened. When this is false it should
       * set the thisOpened variable to false
       *
       * example: search is opened, it should then close the sub menu
       */
      _closeThisOpened: function(newVal, oldVal) {
        // if undefined or true stop script
        if (typeof newVal === 'undefined' || newVal) return;

        // set thisOpened to false
        this.thisOpened = newVal;
      },

      /** 
       * @name _setThisOpened
       * @description observer for the activeId variable, it is used to set the
       * thisOpened variable
       */
      _setThisOpened: function(activeId) {
        // activeId or menuItem not defined stop script
        if (typeof activeId === 'undefined' || typeof this.menuItem === 'undefined') return;

        // if activeId and menuItem are the same use toggle to thisOpened
        if (activeId === this.menuItem.ID) {
          this.thisOpened = !this.thisOpened;

        // if activeId and menuItem are not the same always set thisOpened to false
        } else if (activeId !== this.menuItem.ID) {
          this.thisOpened = false;
        }
      },

      /**
       * @name dropdownToggle
       * @description When a dropdown item is clicked this will be triggered
       */
      dropdownToggle: function(event) {
        // disable href, if set
        event.preventDefault();

        // set self to use it in scroll function
        var self = this;

        /**
         * set the searchOpened to false because it needs to be disabled
         * otherwise it will conflict the submenu that will be opened
         */
        self.searchOpened = false;

        /**
         * if the activeId isn't currently set the subMenuOpened should be false
         * this means we can use the toggle mode
         */
        if (typeof self.activeId === 'undefined') {
          self.subMenuOpened = !self.subMenuOpened;

        /**
         * if the activeId is not the same as the menuItem.ID it means
         * not this menu item is currently active but it should become active
         * this is why the subMenuOpened should always be set to true (or stay true)
         */
        } else if (self.activeId !== self.menuItem.ID) {
          self.subMenuOpened = true;

        /**
         * if the activeId is the same as the menuItem.ID we know for sure
         * someone wants to 'close' the active open submenu and thats why we
         * set the subMenuOpened to false in this case
         */
        } else if (self.activeId === self.menuItem.ID) {
          self.subMenuOpened = false;
        }

        /**
         * After the subMenuOpened variable is set we will define the
         * activeId variable
         */
        self.setActiveId();

        // send tracking data
        self._eventTracking(event, 'dropdownToggle');

        /**
         * event listener to disable submenu on scroll 
         */
        window.onscroll = function(events) {
          self.subMenuOpened = false;
        }
      },

      /**
       * @name setActiveId
       * @description function to set the activeId variable/attribute to the 
       * one that is clicked
       */
      setActiveId: function() {
        this.activeId = (this.subMenuOpened) ? this.menuItem.ID : null;
      },

      /**
       * @name menuItemClicked
       * @description this function will reset all states to the default (false)
       */
      menuItemClicked: function(event) {
        // reset all handlers
        this.mobileMenuOpened = false;
        this.subMenuOpened = false;
        this.searchOpened = false;
        this.activeId = null;

        // send event to tracking
        this._eventTracking(event, 'switch');
      },

      /**
       * @name _eventTracking
       * @description sets the right properties for event tracking
       */
      _eventTracking: function(event, type) {
        /**
         * define element (mobile and desktop are different elements)
         * for mobile this should be parentNode, for desktop localTarget
         * is sufficient
         */
        var element = (Polymer.dom(event).localTarget.href) ? Polymer.dom(event).localTarget : Polymer.dom(event).localTarget.parentNode;

        /**
         * build up the tracking eventData
         */
        var eventData = {
          action: type,
          component: 'navigation',
          element: element,
          event: 'polymer_event',
        };

        // if dropdownToggle overwrite the state
        if (type === 'dropdownToggle') {
          eventData.action = (this.subMenuOpened) ? 'open' : 'close';
        }

        // if it is a switch type add the things object
        if (type === 'switch') {
          eventData.things = {
            'currentPage': document.URL,
            'targetPage': element.href
          }
        }

        // set the tracking data, this will trigger dorel-gtm-events
        Polymer.globalsManager.set('Dorel.events', eventData);
      }
    });
  </script>
</dom-module>