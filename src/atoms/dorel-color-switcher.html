<dom-module id="dorel-color-switcher">
  <template>
    <style>
      .color-name {
        @apply(--theme-typography-2);
        margin: 1em 0 .5em 0;
      }

      .list-group {
        list-style: none;
        float: left;
        padding: 0;
        margin: 0.1875em 0;
      }

      .list-group-item {
        float: left;
        border: 2px solid transparent;
        border-radius: 2em;
        padding: .25em;
        transition: border .3s ease;
        margin-right: .5em;
      }

      .list-group-item.active {
        border: 2px solid var(--theme-brand-color-1);
      }

      .list-group-item span {
        display: block;
        border-radius: 1em;
        width: 1.75em;
        height: 1.75em;
        border: 1px solid var(--theme-color-monochrome-3);
        cursor: pointer;
        transition: opacity .3s ease;
      }

      .list-group-item span:focus, .list-group-item span:hover {
        outline: none;
        opacity: .7;
      }

      .color-switcher {
        float: left;
        width: 100%;
      }

    </style>

    <template
      is="dom-if"
      if="[[ colorsData.length ]]">
      <div class="color-switcher">
        <div class="color-name">Color: [[ currentName ]]</div>

        <ul class="list-group">
          <template
            is="dom-repeat"
            items="[[ colorsData ]]"
            as="color"
            filter="[[ _filterChildProducts(filters.*) ]]">
            <li class$="list-group-item {{ _isCurrentColor(currentName, color.color_name) }}">
              <span on-click="_changeCurrentColor"
                    role="button"
                    tabindex="0"
                    color-image$="[[ color.color_image ]]"
                    color-name$="[[ color.color_name ]]"
                    gtm-action$="[[ gtmAction ]]"
                    gtm-child$="[[ gtmChild ]]"
                    gtm-cta-index$="[[ index ]]"
                    style$="background-color: [[ color.color_code ]];"></span>
            </li>
          </template>
        </ul>

      </div>
    </template>
  </template>

  <script>
    Polymer({
      is: 'dorel-color-switcher',

      properties: {

        /**
         * @attribute
         * @name colorsData
         * @description holds all colors
         */
        colorsData: {
          type: Array,
          value: []
        },

        /**
         * @attribute
         * @name currentImage
         * @description by default isset to the first array item
         */
        currentImage: {
          type: String,
          value: '',
          notify: true
        },

        colors: {
          type: String,
        },

        filters: {
          type: Array
        }
      },

      /**
       * @name _filterChildProducts
       * @description a filter that is used by the template
       * Additional functionality is to call _setCurrentColor whenever the filters change
       * to select a color that is included in the filtered colors
       * @param filters - Array - filters inerited by parent => from the queryParams
       */
      _filterChildProducts: function(filters) {
        var self = this;
        return function(color) {
          // if no filters are applied return true
          if(!filters || !filters.base || !filters.base.length) {
            self._setCurrentColor(self.colorsData[0]);
            return true;
          }
          // if there is no product return false
          if (!color) {
            return false;
          }
          var showProduct = self._filterHelper(color, filters);
          if(showProduct === true) {
            var selectedColor = self.colorsData.find(function(_color) {
              return _color.sku === color.sku;
            });
            self._setCurrentColor(selectedColor);
          }
          return showProduct;
        };
      },

      /**
       * @name _filterHelper
       * @param product - Object
       * @param filters - Array - filters inerited by parent => from the queryParams
       */
      _filterHelper: function(product, filters) {
        var colorObject = filters.base.find(function(filter) {
          return filter.color;
        })
        if(colorObject.color && colorObject.color.length) {
          var isMatch = colorObject.color.find(function(item) {
            return product.color_name === item.split('-').join(' ');
          });
          return isMatch ? true : false;
        } else {
          return true;
        }
      },

      _setCurrentColor: function(newColor) {
        if(!newColor) {
          return;
        }
        this.set('currentImage', newColor.color_image);
        this.set('currentName', newColor.color_name);
      },

      /**
       * @onTap
       * @name _changeCurrentColor
       * @description when a color is clicked it will change the current values
       *
       * @param e - Object - the clicked object/target
       */
      _changeCurrentColor: function (event) {
        var element = Polymer.dom(event).localTarget;

        this.newColorImage = event.target.getAttribute('color-image');
        this.newColorName = event.target.getAttribute('color-name');

        this.gtmAction = event.target.getAttribute('gtm-action');
        this.gtmChild = event.target.getAttribute('gtm-child');
        this.gtmCtaIndex = event.target.getAttribute('gtm-cta-index');

        var structure = {
          name: this.gtmParent,
          index: Number(this.gtmParentIndex) + 1,
          child: {
            name: this.gtmChild,
            index: 1,
            event: {
              name: 'color-switch',
              colorName: this.newColorName,
              colorImage: this.newColorImage,
              index: Number(this.gtmCtaIndex) + 1,
            }
          }
        };

        Polymer.globalsManager.set('Dorel.events', {
          action: this.gtmAction ? this.gtmAction : 'click',
          component: 'color-switcher',
          structure: structure,
          element: element,
          event: 'polymer_event',
          things: {
            currentColor: this.currentName,
            targetColor: this.newColorName
          }
        });

        this.currentImage = this.newColorImage;
        this.currentName = this.newColorName;
      },

      /**
       * @name _isCurrentColor
       * @description check if the item is the current one to set the active
       * class on the list-item
       *
       * @param current - String - the current color name
       * @param name - String - the name of the color item
       * @returns String - active or empty string
       */
      _isCurrentColor: function (current, name) {
        return (current === name) ? 'active' : '';
      }
    });
  </script>

</dom-module>
