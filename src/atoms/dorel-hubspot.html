<!-- hubspot needs this for the onFormReady handler -->
<script src="/bower_components/jquery/dist/jquery.slim.min.js"></script>
  
<dom-module id="dorel-hubspot">
  <template>
    <!-- The HTML for the Hubspot forms should be created consistently, or the layouts for these might not work -->
    <!-- TODO: Make sure to test all new forms! -->
    <style>

      .hbspt-form {
        padding: var(--theme-component-space-inner-xlarge) var(--theme-component-space-inner);
      }

      fieldset, .hs_recaptcha, .hs_submit, .hs-form-field {
        @apply(--theme-bodycopy-width);
        display: block;
        float: none;
        margin: 0 auto;
        border: 0;
        padding: 0;

      }

      .hs-form-field {
        padding: 0 0 var(--theme-component-space-inner-medium) 0;
      }

      .hs-input {
        @apply(--theme-ie-bodycopy);
        color: var(--theme-color-foreground-secondary);
        padding: var(--theme-component-space-micro);
        margin: var(--theme-component-space-micro) 0;
        border: 1px solid var(--theme-color-background);
        border-radius: var(--theme-input-border-radius);
        width: calc(100% - 1rem);
        transition: border-color .3s ease;
      }

      .hs-input:last-child {
        margin-bottom: 0;
      }

      .hs-input:hover, .hs-input.invalid:hover,  .hs-input.error:hover {
        border-color: var(--theme-color-hover);
      }

      input[type="file" i].hs-input {
        padding: var(--theme-component-space-inner);
        width: calc(100% - 3rem);
      }

      input[type="file" i].hs-input:hover {
        cursor: pointer;
      }

      textarea.hs-input {
        min-height: 8rem;
      }

      .hs-input.invalid,  .hs-input.error {
        border-color: var(--theme-brand-color-accent-pink);
        margin-bottom: var(--theme-component-space-micro);
      }

      .hs-button {
        @apply(--theme-cta);
        @apply(--theme-cta--primary);
      }

      .hs-button:hover, .hs-button:focus {
        @apply(--theme-cta--hover);
      }

      .form-columns-2 .hs-form-field {
        width: calc(50% - var(--theme-component-space-micro));
        float: left;
        display: inline-block;
        padding-right: var(--theme-component-space-micro);
      }

      .form-columns-2 .hs-form-field:last-child {
        padding-left: var(--theme-component-space-micro);
        padding-right: 0;
      }

      .hs_recaptcha > .hs-error-msgs {
        margin-top: var(--theme-component-space-micro);
      }

      .hs-error-msgs {
        color: var(--theme-brand-color-accent-pink);
        font-size: var(--theme-size-small);
        display: block;
        padding: 0;
        list-style: none;
        margin: 0;
      }

    </style>

    <div id="form"></div>
  
  </template>

  <script>
    Polymer({
      is: 'dorel-hubspot',

      properties: {

        /**
         * @name portalId
         * @description defines portal ID defined in the WP theme settings
         * this is retrieved through the wp-collect-options and placed in
         * the globals object
         */
        portalId: {
          type: String
        },

        /**
         * @name formid
         * @description defines form ID defined in the WP page builder component
         */
        formId: {
          type: String
        },

        /**
         * @name hubspotLoaded
         * @description this variable defines if the hubspot script is loaded
         */
        hubspotLoaded: {
          type: Boolean,
          value: false
        }
      },

      observers: [
        '_embedForm(portalId, formId, hubspotLoaded)'
      ],

      /**
       * @name _embedForm
       * @description this script observes all variables needed to inject
       * the form in the Polymer application
       */
      _embedForm: function(portalId, formId, hubspotLoaded) {

        // check if all variables needed are set, otherwise jump out
        if (typeof hubspotLoaded === 'undefined' || !hubspotLoaded ||
          typeof portalId === 'undefined' || portalId === '' || 
          typeof formId === 'undefined' || formId === '') return;

        // remove previously added forms ---- HACK ---- mandatory otherwise it will show all forms in the app
        if (this.$.form.hasChildNodes()) {
          while (this.$.form.firstChild) {
            this.$.form.removeChild(this.$.form.firstChild);
          }
        }

        // Check if a form with the ID already exists in this component
        var formIdTarget = '#hsForm_' + formId;
        var formInComponent = Polymer.dom(this.root).querySelector(formIdTarget);

        // Create the form if it's not in the component
        if(formInComponent === null)
        {
          // reference this for use in the hbspt object
          var self = this;

          // call to the forms create method of the hubspot script
          window.hbspt.forms.create({
            /*
            * On customizing Hubspot embeds:
            * http://bit.ly/2ouvaj6
            */
            css:  '' ,
            portalId: portalId,
            formId: formId,
            /**
             * TODO: only works if jQuery is included
             */
            onFormReady: function($form, ctx) {
              /**
               * create a document fragment to grab the div added by the script
               * and inject it in the form div of this component
               */
              var fragment = document.createDocumentFragment();

              // CloneNode doesn't transfer any event bindings, even if set to true
              //fragment.appendChild($form[0].parentNode.cloneNode(true));

              // Jquery's clone (hubspot dependency) doesn't transfer any event bindings, even if set to true
              //fragment.appendChild($($form[0].parentNode).clone(true, true)[0]);

              // Back to using appendChild without cloning, this works in all browsers.
              // However, Firefox and Safari will fall back on old styling if form errors appear.
              fragment.appendChild($form[0].parentNode);
              Polymer.dom(self.$.form).appendChild(fragment);
            }
          });
        }
      }
    });
  </script>
</dom-module>
