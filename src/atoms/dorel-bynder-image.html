<link rel="import" href="../utils/dorel-bynder-collect-media.html">
<dom-module id="dorel-bynder-image">
  <template>
    <style>
      :host {
        /* These can be overwritten in a encapsulating component */
        --image-mobile-width: 16em;
        --image-mobile-height: 9em;
        --image-tablet-width: 16em;
        --image-tablet-height: 9em;
        --image-width: 16em;
        --image-height: 9em;
      }

      :host([flex]) {
        display: flex;
        width: 100%;
        flex: 1;
      }

      :host([flex]) .section {
        width: 100%;
        display: flex;
        flex: 1;
      }
      section {
        margin: auto;
      }

      iron-image, section {
        width: var(--image-mobile-width);
        height: var(--image-mobile-height);
        background-color: var(--image-background-color);
      }

      [tablet-small] iron-image, section[tablet-small] {
        width: var(--image-tablet-width);
        height: var(--image-tablet-height);
      }

      [tablet-medium-up] iron-image, section[tablet-medium-up] {
        width: var(--image-width);
        height: var(--image-height);
      }
    </style>

    <!-- Handles the ajax call and returns the bynder data -->
    <dorel-bynder-collect-media media-id="[[ mediaId ]]"
                                media-content="{{ mediaContent }}"></dorel-bynder-collect-media>

    <dorel-media-query breakpoints="{{ breakpoints }}"></dorel-media-query>

    <section tablet-small$="[[ breakpoints.tabletMediumUp ]]"
             tablet-medium-up$="[[ breakpoints.desktopSmallUp ]]">

      <!-- Desktop Image -->
      <template is="dom-if" if="[[ breakpoints.tabletMediumUp ]]">
        <iron-image sizing="[[ sizing ]]"
                    fade="true"
                    preload
                    title$="[[ alt ]]"
                    alt$="[[ alt ]]"
                    placeholder$="[[ imagePlaceholder ]]"
                    src$="[[ imageSource ]]"></iron-image>
      </template>

      <!-- Mobile Image -->
      <template is="dom-if" if="[[ !breakpoints.tabletMediumUp ]]">
        <iron-image sizing="[[ sizing ]]"
                    fade="true"
                    preload
                    title$="[[ alt ]]"
                    alt$="[[ alt ]]"
                    placeholder$="[[ imagePlaceholder ]]"
                    src$="[[ mobileImageSource ]]"></iron-image>
      </template>

    </section>
  </template>
  <script>
    Polymer({
      is: 'dorel-bynder-image',
      properties: {
        /**
         * @name sizing
         * @description Sizing of the image. Defaults to cover, can be set to contain
         */
        sizing: {
          type: String,
          value: 'cover'
        },
        /**
         * @name mobileWidth
         * @description The width for displaying the image on mobile (set as a css property)
         */
        mobileWidth: {
          type: String,
          value: '16em'
        },
        /**
         * @name mobileHeight
         * @description The height for displaying the image on mobile (set as a css property)
         */
        mobileHeight: {
          type: String,
          value: '9em'
        },
        /**
         * @name tabletWidth
         * @description The width for displaying the image on tablet (set as a css property)
         */
        tabletWidth: {
          type: String,
          value: '16em'
        },
        /**
         * @name tabletHeight
         * @description The height for displaying the image on tablet (set as a css property)
         */
        tabletHeight: {
          type: String,
          value: '9em'
        },
        /**
         * @name width
         * @description The width for displaying the image (set as a css property)
         */
        width: {
          type: String,
          value: '16em'
        },
        /**
         * @name height
         * @description The height for displaying the image (set as a css property)
         */
        height: {
          type: String,
          value: '9em'
        },
        /**
         * @name mediaId
         * @description The ID used to retrieve the asset from Bynder
         */
        mediaId: {
          type: String
        },
        /**
         * @name mediaContent
         * @description data coming from Bynder.
         */
        mediaContent: {
          type: Object,
          notify: true,
          observer: '_onMediaContentChanged'
        },
        /**
         * @name derivativeIdentifier
         * @description The identifier to retrieve the correct derivative
         */
        derivativeIdentifier: {
          type: String,
          value: ''
        },

        /**
         * @name mobileDerivativeIdentifier
         * @description The identifier to retrieve the correct derivative for mobile screens
         */
        mobileDerivativeIdentifier: {
          type: String,
          value: ''
        },

        /**
         * @name imageSource
         * @description The source of the image to be displayed
         */
        imageSource: {
          type: String,
        },

        /**
         * @name mobileImagesource
         * @description The source of the image to be displayed on mobile
         */
        mobileImageSource: {
          type: String,
        },
        /**
         * @name imagePlaceholder
         * @description The image placeholder for the image
         */
        imagePlaceholder: {
          type: String,
        },
        /**
         * @name alt
         * @description Alt attribute for SEO
         */
        alt: {
          type: String,
          value: ''
        }
      },
      /**
       * @name _onMediaContentChanged
       * @description Retrieves the correct image source in the Bynder data
       */
      _onMediaContentChanged: function () {
        if (typeof this.mediaContent !== 'undefined' && this.mediaContent.hasOwnProperty('thumbnails')) {
          // Set the Bynder description to this component's alt properties, if no alt is given
          if(this.alt === '')
          {
            this.alt = this.mediaContent.description;
          }

          var bynderDerivatives = this.mediaContent.thumbnails;
          this.imagePlaceholder = bynderDerivatives.mini;

          self = this;

          // Generic identifier to set the derivative identifier sources
          var setDerivative = function (identifier, source, derivatives) {
            //Default the source to the webimage
            self.set(source, derivatives.webimage);

            //If the derivative contains the identifier, set the source
            if (derivatives.hasOwnProperty(identifier)) {
              self.set(source, derivatives[identifier]);
            }
          };

          // Set the desktop and mobile derivatives
          setDerivative(this.derivativeIdentifier, 'imageSource', bynderDerivatives);
          setDerivative(this.mobileDerivativeIdentifier, 'mobileImageSource', bynderDerivatives);
        }
      },
      /**
       * @name _setSize
       * @description Sets the image size according to given width and height properties
       */
      _setSize: function () {

        var backgroundColor = 'transparent';
        //No background color vor transparent images;
        if (this.sizing !== 'contain') {
          backgroundColor = this.getComputedStyleValue('--image-background-color');
        }


        this.updateStyles({
          '--image-mobile-width': this.mobileWidth,
          '--image-mobile-height': this.mobileHeight,
          '--image-tablet-width': this.tabletWidth,
          '--image-tablet-height': this.tabletHeight,
          '--image-width': this.width,
          '--image-height': this.height,
          '--image-background-color': backgroundColor
        });
      },
      /**
       * @name attached
       * @description Attached callback, sets the given image size
       */
      attached: function () {
        this._setSize();
      }
    });
  </script>
</dom-module>
