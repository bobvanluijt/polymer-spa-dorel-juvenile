<link rel="import" href="../organisms/product-advisory/dorel-product-advisory-nav.html">
<link rel="import" href="../organisms/product-advisory/dorel-step-car-information.html">
<link rel="import" href="../organisms/product-advisory/dorel-step-result.html">


<dom-module id="dorel-template-product-advisory-tool">
  <template>
    <style>
      :host {
        display: block;
        width: 100%;
        min-height: 100vh;
        overflow: hidden;
      }
      .loader {
        width: 100%;
        display: block;
        min-height: 4px;
      }
    </style>

    <iron-ajax
      id="results"
      handle-as="json"
      on-response="_resultResponse"></iron-ajax>

    <app-location route="{{ route }}" query-params="{{ queryParams }}"></app-location>
    <dorel-product-advisory-nav
      load-complete="[[ loadComplete ]]"
      page-title="[[ title ]]"
      previous="[[ isNotFirstStep(currentFittingPage, carFittingData) ]]"
      progress="[[ calculateProgess(carFittingData, currentFittingPage) ]]"
      brand-name="[[ brandName ]]'">
    </dorel-product-advisory-nav>

    <iron-pages
      role="main"
      selected="[[ currentFittingPage.step ]]"
      attr-for-selected="name">
      <template is="dom-if" if="[[ _equals(currentFittingPage.step, 'car-information')]]" restamp="true">
        <dorel-step-car-information
          name="car-information"
          product="[[ currentProduct ]]"
          next="[[ isNotLastStep(currentFittingPage, carFittingData) ]]"
          previous="[[ isNotFirstStep(currentFittingPage, carFittingData) ]]"
          data="[[ currentFittingPage ]]">
        </dorel-step-car-information>
      </template>
      <template is="dom-if" if="[[ _equals(currentFittingPage.step, 'fitting-results' ]]" restamp="true">
        <dorel-step-result
           name="fitting-results"
           product="[[ currentProduct ]]"
           data="[[ currentFittingPage ]]"
           next="[[ isNotLastStep(currentFittingPage, carFittingData) ]]"
           previous="[[ isNotFirstStep(currentFittingPage, carFittingData) ]]"
           results="[[ fittingResults ]]">
        </dorel-step-result>
      </template>
    </iron-pages>

  </template>

  <script>
    Polymer({
      is: 'dorel-template-product-advisory-tool',

      properties: {

        /**
         * @attribute
         * @name templateData
         * @description the data coming from ACF/Wordpress which is delegated to the page builder
         */
        templateData: {
          type: String
        },

        brandName: {
          type: String
        },

        queryParams: {
          type: Object
        },

        fittingResults: {
          type: Object
        },

        carFittingData: {
          type: Array,
          value: [
            {
              title: 'Your car information',
              step: 'car-information',
              options: {
                next: 'Next',
                previous: 'Previous'
              },
              main_section: {
                section_type: 'car-details-form',
                title: 'My car is',
                form: {
                  form_title: 'Choose your car details',
                  form_groups: [
                    { label: 'Brand', default_option: { label: 'Choose a brand', value: ''}, options: [] },
                    { label: 'Model', default_option: { label: 'Choose a Model', value: ''}, options: [] },
                    { label: 'Type/Year', default_option: { label: 'Choose a type', value: ''},  options: [] }
                  ]
                }
              },
              sub_section: {
                title: '',
                description: 'By giving us your car information we show you where you can install',
                background_image_id: '7F84BD5F-551A-4DA5-8532AB44763439AA'
              }
            },
            {
              title: 'Your car results',
              step: 'fitting-results',
              options: {
                next: 'Next',
                previous: 'Previous'
              },
              main_section: {
                section_type: 'car-details-form',
                title: 'Car Fitting'
              }
            }
          ]
        },

        currentFittingPage: {
          type: Object
        },

        currentProduct: {
          type: String
        },

        results: {
          type: Object
        }

      },

      observers: [
        '_setProductSku(queryParams)'
      ],

      listeners: {
        'next-step': '_nextStep',
        'previous-step': '_previousStep',
        'get-results': '_getResults'
      },

      ready: function() {
        this.set('currentFittingPage', this.carFittingData[0]);
      },

      _getResults: function(event) {
        var values = event.detail.value;
        this.set('results', {});
        if(values.length) {
          var resultsEl = this.$.results;
        }
      },

      _resultResponse: function(response) {

      },

      _setProductSku: function(queryParams) {
        if(queryParams && queryParams.product) {
          var product = queryParams.product;
          this.set('currentProduct', queryParams.product);
        }
      },

      calculateProgess: function(carFittingData, currentFittingPage) {
        var totalAmountOfSteps = carFittingData.length;
        var index = carFittingData.indexOf(currentFittingPage) + 1;
        var percentage = (index * 100) / totalAmountOfSteps;
        return percentage === 0 ? 100 : percentage;
      },

      _nextStep: function() {
        var self = this;
        var index = this.carFittingData.findIndex(function(step) {
          return self.currentFittingPage.step === step.step;
        });
        var nextStep = Object.assign({}, this.carFittingData[index + 1]);
        this.set('currentFittingPage', nextStep);
      },

      _previousStep: function() {
        var self = this;
        var index = this.carFittingData.findIndex(function(step) {
          return self.currentFittingPage.step === step.step;
        });
        var previousStep = Object.assign({}, this.carFittingData[index - 1]);
        this.set('currentFittingPage', previousStep);
      },

      _equals: function(step, stepName) {
        return step === stepName;
      },

      isNotLastStep: function(currentFittingPage, carFittingData) {
         var index = carFittingData.findIndex(function(step) {
           return currentFittingPage.step === step.step;
         });
         return Boolean(index !== -1 && carFittingData && (index + 1) < carFittingData.length);
      },

      isNotFirstStep: function(currentFittingPage, carFittingData) {
        var index = carFittingData.findIndex(function(step) {
          return currentFittingPage.step === step.step;
        });
        return Boolean(index !== -1 && carFittingData && index !== 0);
      }


    });
  </script>
</dom-module>
