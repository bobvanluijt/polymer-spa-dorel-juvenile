<link rel="import" href="../organisms/category/dorel-category-listing.html">
<link rel="import" href="../organisms/category/dorel-category-submenu.html">
<link rel="import" href="../organisms/category/dorel-category-filter.html">
<link rel="import" href="../organisms/dorel-section-header.html">

<dom-module id="dorel-template-product-listing">
  <template>
    <style>
      h1, h2, h3, h4 {
        @apply(--theme-header-text-transform);
      }

      :host {
        float: left;
        width: 100%;
        background-color: var(--theme-color-white);
        margin-bottom: 3em;
      }

      dorel-layout-column {
        margin-top: 0;
      }
    </style>

    <!-- section-header -->
    <template
      is="dom-if"
      if="[[templateData.acf.hero_header.length]]">
      <dorel-section-header
        section-header-data="[[heroHeader]]"
        gtm-parent="dorel-section-header"
        gtm-parent-index="[[ index ]]"></dorel-section-header>
    </template>
    <!--// section-header -->

    <dorel-section-page-nav
      breadcrumbs-toggle="true"
      rendered-count="[[ renderedCount ]]"></dorel-section-page-nav>

    <dorel-layout-container>
      <dorel-layout-row align="left">

        <!-- Sidebar -->
        <dorel-layout-column desktop-column-span="3" tablet-column-span="5" mobile-column-span="12">
          <template
            is="dom-if"
            if="[[leftSidebar.productSubCategories.toggle]]">
            <dorel-accordion-item heading="{{ localize('Subcategories') }}"
                                  opened
                                  small
                                  gtm-parent="[[ gtmParent ]]"
                                  gtm-parent-index="[[ gtmParentIndex ]]" gtm-cta-index$="[[ index ]]">
              <dorel-category-submenu
                items="[[leftSidebar.productSubCategories.sub_categories]]">
              </dorel-category-submenu>
            </dorel-accordion-item>
          </template>

          <template
            is="dom-if"
            if="[[leftSidebar.filters.toggle]]">
            <dorel-accordion-item heading="{{ localize('Filters') }}"
                                  opened
                                  small
                                  gtm-parent="[[ gtmParent ]]"
                                  gtm-parent-index="[[ gtmParentIndex ]]" gtm-cta-index$="[[ index ]]">
              <dorel-category-filter
                filter-data="[[ leftSidebar.filters.filter_groups ]]"
                retrieving-products="[[ retrievingProducts ]]"
                product-data="[[ products ]]">
              </dorel-category-filter>
            </dorel-accordion-item>
          </template>
        </dorel-layout-column>
        <!--// Sidebar -->

        <dorel-layout-column desktop-column-span="9" tablet-column-span="7" mobile-column-span="12">
          <dorel-category-listing
            products-data="[[ products ]]"
            retrieving-products="[[ retrievingProducts ]]"
            sort="[[ sort ]]"
            rendered-count="{{ renderedCount }}"
            gtm-parent="dorel-category-listing"
            gtm-parent-index="2"></dorel-category-listing>
        </dorel-layout-column>
      </dorel-layout-row>

      <template
        is="dom-if"
        if="{{ templateData.acf.title }}">
        <dorel-section-seo
          meta-title="[[ templateData.acf.title ]]"
          meta-description="[[ templateData.acf.description ]]"></dorel-section-seo>
      </template>
    </dorel-layout-container>
    <!--// container -->

  </template>
  <script>
    class DorelTemplateProductListing extends ReduxMixin(Polymer.mixinBehaviors([TemplateBehaviors, DorelMultilingualBehavior], Polymer.Element)) {

      static get is() {
        return 'dorel-template-product-listing';
      }

      static get properties() {
        return {

          /**
           * @attribute
           * @name templateData
           * @description the data coming from ACF/Wordpress which is delegated to the page builder
           */
          templateData: {
            type: Object,
            statePath: 'page.currentPage',
            observer: '_defineComponentModels'
          },

          /**
           * @attribute
           * @name products
           * @description the data coming from the collect-products component
           */
          products: {
            type: Array,
            statePath: function(state) {
              return state.product.products.filter(product => {
                return product && product.categories && product.categories.indexOf(this.category) > -1 ? true : false;
              });
            }
          },

          /**
           * @attribute
           * @name category
           * @description inherit by parent will be used by collect-products
           */
          category: {
            type: Number,
            observer: '_categoryChanged'
          },

          /**
           * @attribute
           * @name sort
           * @description define the default sorting type/order of the product listing
           */
          sort: {
            type: Object,
            value: function () {
              return {
                type: 'name',
                order: 'asc'
              };
            }
          },

          /**
           * @attribute
           * @name category
           * @description a loading indicator from the collect-products component
           * if products are retrieved it will set Boolean to false
           * if products are being retrieved it will set Boolean to true
           * initial value is true because component does not have products initially
           */
          retrievingProducts: {
            type: Boolean,
            statePath: function(state) {
              const category = state.product.requestedCategories.find(category => category.id === this.category);
              return category ? category.isLoading : true;
            }
          },

          renderedCount: Number,

          heroHeaderData: Object,

          leftSidebar: Object

        };
      }

      _categoryChanged(category) {
        if(category && category > -1) {
          this.dispatch('requestProductsByCategory', category);
        }
      }
    }
    customElements.define(DorelTemplateProductListing.is, DorelTemplateProductListing);
  </script>
</dom-module>
