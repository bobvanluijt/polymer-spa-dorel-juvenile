<link rel="import" href="../atoms/dorel-expandable-panel.html">
<link rel="import" href="../organisms/dorel-category-listing.html">
<link rel="import" href="../organisms/dorel-section-header.html">
<link rel="import" href="../organisms/dorel-section-category-sidebar.html">
<link rel="import" href="../organisms/dorel-category-submenu.html">
<link rel="import" href="../organisms/dorel-category-filter.html">
<link rel="import" href="../utils/dorel-magento-collect-products-by-category.html">

<dom-module id="dorel-template-product-category">
  <template>
    <style>
      :host {
        float: left;
        width: 100%;
        background-color: var(--theme-color-white);
      }

      .container {
        @apply(--max-width-container);
        box-sizing: border-box;
        padding-top: 0;
      }

      .row {
        @apply(--theme-grid-row);
        @apply(--layout-flex);
      }

      .content {
        width: 100%;
        @apply(--theme-grid-column);
        margin-top: 0;
      }

      .sidebar {
        width: 100%;
        @apply(--theme-grid-column);
        margin-top: 0;
      }

      [tablet-medium-up] .container {
        padding: 0 var(--theme-gutter);
      }

      [tablet-medium-up] .row {
        @apply(--theme-grid-row-margins);
      }

      [desktop-small-up] .main-content {
        display: flex;
      }

      [desktop-small-up] .content {
        -ms-flex-preferred-size: calc(var(--theme-column-width) * 9);
        flex-basis: calc(var(--theme-column-width) * 9);
        max-width: calc(var(--theme-column-width) * 9);
      }

      [desktop-small-up] .sidebar {
        -ms-flex-preferred-size: calc(var(--theme-column-width) * 3);
        flex-basis: calc(var(--theme-column-width) * 3);
        max-width: calc(var(--theme-column-width) * 3);
      }
    </style>

    <dorel-magento-collect-products-by-category
      category="[[ templateData.acf.magento_category_picker ]]"
      app-cache="[[ appCache ]]"
      retrieving-products="{{ retrievingProducts }}"
      products="{{ products }}"></dorel-magento-collect-products-by-category>


    <dorel-media-query breakpoints="{{ breakpoints }}"></dorel-media-query>

    <div tablet-medium-up$="{{ breakpoints.tabletMediumUp }}"
         desktop-small-up$="{{ breakpoints.desktopSmallUp }}">

      <!-- section-header -->
      <template
        is="dom-if"
        if="[[templateData.acf.hero_header.length]]">
        <dorel-section-header
          section-header-data="[[heroHeaderData]]"
          gtm-parent="dorel-section-header"
          gtm-parent-index="[[ index ]]"></dorel-section-header>
      </template>
      <!--// section-header -->

      <dorel-section-page-nav
        breadcrumbs-toggle="true"
        rendered-count="[[ renderedCount ]]"></dorel-section-page-nav>

      <div class="container layout horizontal center center-justified wrap">
        <div class="row">
          <div class="sidebar">
            <template
              is="dom-if"
              if="[[leftSidebar.productSubCategories.toggle]]">
              <dorel-expandable-panel header="Subcategories" opened>
                <dorel-category-submenu
                  items="[[leftSidebar.productSubCategories.sub_categories]]">
                </dorel-category-submenu>
              </dorel-expandable-panel>
            </template>

            <template
              is="dom-if"
              if="[[leftSidebar.filters.toggle]]">
              <dorel-expandable-panel header="Filters" opened>
                <dorel-category-filter
                  filter-data="[[leftSidebar.filters.filter_groups]]"
                  retrieving-products="[[ retrievingProducts ]]"
                  product-data="[[ products ]]">
                </dorel-category-filter>
              </dorel-expandable-panel>
            </template>
          </div>

          <div class="content">
            <dorel-category-listing
              products-data="[[ products ]]"
              retrieving-products="[[ retrievingProducts ]]"
              sort="[[ sort ]]"
              rendered-count="{{ renderedCount }}"
              gtm-parent="dorel-category-listing"
              gtm-parent-index="2"></dorel-category-listing>
          </div>

          <template
            is="dom-if"
            if="{{ templateData.acf.title }}">
            <dorel-section-seo
              meta-title="[[ templateData.acf.title ]]"
              meta-description="[[ templateData.acf.description ]]"></dorel-section-seo>
          </template>

        </div>
      </div>
      <!--// container -->

    </div>
    <!--// tablet div -->

  </template>
  <script>
    Polymer({
      is: 'dorel-template-product-category',

      properties: {

        /**
         * @attribute
         * @name appCache
         * @description the application cache
         */
        appCache: {
          type: Object
        },

        /**
         * @attribute
         * @name templateData
         * @description the data coming from ACF/Wordpress which is delegated to the page builder
         */
        templateData: {
          type: Object,
          value: function () {
            return {};
          },
          observer: '_defineComponentModels'
        },

        /**
         * @attribute
         * @name products
         * @description the data coming from the collect-products component
         */
        products: {
          type: Array,
          value: []
        },

        /**
         * @attribute
         * @name category
         * @description inherit by parent will be used by collect-products
         */
        category: {
          type: Number,
          value: 0
        },

        /**
         * @attribute
         * @name category
         * @description a loading indicator from the collect-products component
         * if products are retrieved it will set Boolean to false
         * if products are being retrieved it will set Boolean to true
         * initial value is true because component does not have products initially
         */
        retrievingProducts: {
          type: Boolean,
          value: true
        },

        renderedCount: Number,

        heroHeaderData: Object,

        leftSidebar: Object

      },

      behaviors: [DorelObjectHasPropertiesBehavior],

      listeners: {
        'newProducts' : '_setProducts'
      },

      /**
       * @name _defineComponentModels
       * @description Fixed WP/ACF data is defined by an array (workaround). For components
       * that always have one item in the array a new data model is created to be set on
       * component attribute level. Binding with [0] array item selector doesn't work.
       *
       * @param Object
       */
      _defineComponentModels: function(templateData) {
        // check if the templateData has content
        if(!this._hasProperty(templateData) || typeof templateData.acf === 'undefined') return;

        this._setInitialProductSorting(templateData);

        // set the homeHeaderData for the heroHeader component
        if(typeof templateData.acf.hero_header !== 'undefined') {
          this.set('heroHeaderData', templateData.acf.hero_header[0]);
        }

        if(typeof templateData.acf.left_sidebar !== 'undefined') {
          var leftSidebar = {};

          if(typeof templateData.acf.left_sidebar[0].filters[0] !== 'undefined') {
            leftSidebar.filters = templateData.acf.left_sidebar[0].filters[0];
          }

          if(typeof templateData.acf.left_sidebar[0].filters[0] !== 'undefined') {
            leftSidebar.productSubCategories = templateData.acf.left_sidebar[0].product_sub_categories[0];
          }

          this.set('leftSidebar', leftSidebar);
        }
      },

      /**
       * @name _setInitialProductSorting
       * @description will set the sort Object that will be used by the
       * category-listing component
       *
       * @param templateData - Object
       */
      _setInitialProductSorting: function (templateData) {
        if (!this._hasProperty(templateData) || typeof templateData.acf === 'undefined') return;

        var sort = {
          type: templateData.acf.product_listing_sorting || 'name',
          order: templateData.acf.product_listing_order || 'asc'
        };

        this.set('sort', sort);
      },


      _setProducts: function(event) {
        this.set('products', event.detail.products);
        this.set('retrievingProducts', false);
      },
    });
  </script>
</dom-module>
