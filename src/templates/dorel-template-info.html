<link rel="import" href="../organisms/dorel-section-header.html">
<link rel="import" href="../atoms/dorel-wysiwyg-html.html">

<dom-module id="dorel-template-info">
  <template>
    <style>

      section {
        padding-bottom: 1.5em;
        float: left;
        width: 100%;
      }

      .container {
        @apply(--max-width-container);
        width: 100%;
        margin: auto;
        float: none;
        padding: 0 var(--theme-gutter-mobile);
        box-sizing: border-box;
      }

      .max-width-container {
        width: 100%;
        max-width: var(--theme-base-paragraph-width);
        margin: auto;
        clear: both;
      }

      .image-container {
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 2.25em 0 .75em 0;
        float: left;
        width: 100%;
      }

      dorel-bynder-image {
        width: 100%;
      }

      [tablet-medium-up] .container {
        padding: 0 var(--theme-gutter);
      }

      [tablet-medium-up] .image-container {
        margin: 3em 0 1.5em 0;
      }

      section[tablet-medium-up] {
        padding-bottom: 3em;
      }

    </style>

    <dorel-media-query breakpoints="{{ breakpoints }}"></dorel-media-query>

    <section tablet-medium-up$="[[ breakpoints.tabletMediumUp ]]">
      <!-- section-hero-header -->
      <template
        is="dom-if"
        if="[[templateData.acf.hero_header.length]]">
        <dorel-section-header
          section-header-data="[[heroHeaderData]]"
          info-header="true"></dorel-section-header>
        <template
          is="dom-if"
          if="[[ templateData.acf.breadcrumbs_toggle ]]">
          <dorel-section-page-nav
            breadcrumbs-toggle="[[ templateData.acf.breadcrumbs_toggle ]]"></dorel-section-page-nav>
        </template>
      </template>

      <div class="container layout horizontal center center-justified wrap">
        <!-- show when acf.page_builder has components -->
        <template
          is="dom-if"
          if="{{ templateData.acf.page_builder.length }}">


          <!-- iterate over page_builder components -->
          <template
            is="dom-repeat"
            items="[[ templateData.acf.page_builder ]]"
            as="component"
            targetFramerate="1000">

            <!-- dorel wysiwyg content-->
            <template
              is="dom-if"
              if="[[ isPageComponent(component.acf_fc_layout, 'section_wysiwyg') ]]">
              <div class="max-width-container">
                <dorel-wysiwyg-html html="[[ component.wysiwyg ]]"></dorel-wysiwyg-html>
              </div>
            </template>

            <!-- dorel bynder image -->
            <template
              is="dom-if"
              if="[[ isPageComponent(component.acf_fc_layout, 'section_image') ]]">
              <div class="image-container">
                <dorel-bynder-image media-id="[[ component.bynder_image ]]"
                                    derivative-identifier="Fullscreen Retina landscape"
                                    mobile-derivative-identifier="Fullscreen Small landscape"
                                    alt="[[ component.image_alt ]]"
                                    mobile-width="100%"
                                    mobile-height="18em"
                                    tablet-width="100%"
                                    tablet-height="27em"
                                    width="56em"
                                    height="27em"></dorel-bynder-image>
              </div>
            </template>

            <!-- dorel section hubspot -->
            <template
              is="dom-if"
              if="[[ isPageComponent(component.acf_fc_layout, 'section_hubspot') ]]">

              <dorel-hubspot
                hubspot-loaded="[[ appCache.collect.options.hubspot_loaded ]]"
                portal-id="[[ appCache.collect.options.hubspot_portal_id ]]"
                form-id="{{ component.hubspot_form_id }}"></dorel-hubspot>

            </template>
            <!--// dorel section hubspot -->

          </template>
        </template>
      </div>
    </section>
  </template>

  <script>
    Polymer({
      is: 'dorel-template-info',

      properties: {

        appCache: {
          type: Object,
          value: function () {
            return {};
          }
        },

        /**
         * @attribute
         * @name templateData
         * @description the data coming from ACF/Wordpress which is delegated to the page builder
         */
        templateData: {
          type: Object,
          value: function () {
            return {};
          },
          observer: '_defineComponentModels'
        },

        /**
         * @name homeHeaderData
         * @description the data model used for the hero header component
         */
        heroHeaderData: Object

      },

      /**
       * @name _defineComponentModels
       * @description Fixed WP/ACF data is defined by an array (workaround). For components
       * that always have one item in the array a new data model is created to be set on
       * component attribute level. Binding with [0] array item selector doesn't work.
       *
       * @param Object
       */
      _defineComponentModels: function (templateData) {
        // check if the templateData has content
        if (!this._hasProperty(templateData) || typeof templateData.acf === 'undefined') return;

        // set the homeHeaderData for the heroHeader component
        if (typeof templateData.acf.hero_header !== 'undefined') {
          this.set('heroHeaderData', templateData.acf.hero_header[0]);
        }
      },

      /**
       * @name _hasProperty
       * @description check if an Object has properties
       *
       * @param Object
       * @returns Boolean
       */
      _hasProperty: function (obj) {
        var hasProp = false;

        for (var prop in obj) {
          var hasProp = (obj.hasOwnProperty(prop));
        }

        return hasProp;
      },

      /**
       * @name isPageComponent
       * @description compares to values to see if they match, for some
       * components they can be doubled. They will always be suffixed with
       * their number like section_multi and section_multi_2. In those
       * cases we need to treat them as section_multi's.
       *
       * @returns Boolean if the two values match or not (true/false)
       */
      isPageComponent: function (response, cname) {

        // get last char
        var lastChar = response.substr(response.length - 1);

        // find out if it is a number
        var isNumber = !isNaN(Number(lastChar));

        // if it is a number treat it accordingly
        if (isNumber) {
          var keyArr = response.split('_');
          keyArr.pop();
          strippedResponse = keyArr.join('_');

          return strippedResponse === cname;
        }

        // all other cases just compare them
        return response === cname;
      }
    });
  </script>
</dom-module>
