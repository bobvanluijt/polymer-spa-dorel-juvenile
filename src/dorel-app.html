<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">

<!-- TODO: These should only be included conditionally, based on the config.js -->
<link rel="import" href="themes/theme-dorel-shared-styles.html">
<link rel="import" href="themes/theme-maxi-cosi-shared-styles.html">

<!-- Since 'home' is the default route, eagerly load it. -->
<link rel="import" href="templates/dorel-template-home.html">

<link rel="import" href="utils/dorel-wp-collect-menu-locations.html">
<link rel="import" href="utils/dorel-wp-collect-pages.html">
<link rel="import" href="utils/dorel-wp-collect-options.html">
<link rel="import" href="utils/dorel-wp-collect-widgets.html">

<!-- enable global variables -->
<script src="/bower_components/polymer-global-variables/dist/polymer-global-variables.js"></script>


<dom-module id="dorel-app">
  <template>
    <style>
      /* 
       * Application wide styling
       * - Will define standard styling for components
       */
      :host {
	      font-family: var(--theme-font-sans-serif);
        --primary-color: var(--theme-brand-color);
        color: var(--theme-primary-text-color);
        display: block;
        position: relative;
        min-height: 100vh;
	      font-family: var(--theme-font-sans-serif);
      }

      :root {
        /* global input colors */
        --paper-input-container-underline: {
          border-bottom: 2px solid var(--theme-brand-color);
        };

        --paper-input-container-focus-color: var(--theme-brand-color-royal-blue);

        --paper-input-container-label-focus: {
          color: var(--theme-brand-color-royal-blue);
        };

      }

      iron-pages {
        margin: 0 auto;
      }

      .announcer {
        position: fixed;
        height: 0;
        overflow: hidden;
      }
    </style>
    
    <!-- retrieve all menu items from wordpress (uses rest api menus plugin) -->
    <dorel-wp-collect-menu-locations
      wp-url="[[ globals.Dorel.wpUrl ]]"></dorel-wp-collect-menu-locations>

    <!-- collect all pages from wordpress -->
    <dorel-wp-collect-pages></dorel-wp-collect-pages>
    <!-- <dorel-wp-collect-page page-slug="{{ page }}"></dorel-wp-collect-page> -->

    <!-- collect the options pages -->
    <dorel-wp-collect-options
      wp-url="[[ globals.Dorel.wpUrl ]]"></dorel-wp-collect-options>

    <!-- collect the widgets from wordpress (uses rest api sidebars plugin) -->
    <dorel-wp-collect-widgets></dorel-wp-collect-widgets>

    <!-- analytics -->
    <google-tag-manager cid="GTM-TW3TM86"></google-tag-manager>
    <dorel-gtm-events
      gtm-data="[[ globals.Dorel ]]"></dorel-gtm-events>

    <dorel-third-party
      hubspot-toggle="{{ globals.Dorel.collect.options.hubspot_toggle }}"
      hubspot-portal-id="{{ globals.Dorel.collect.options.hubspot_portal_id }}"
      zendesk-toggle="[[ globals.Dorel.collect.options.zendesk_toggle ]]"
      zendesk-host="[[ globals.Dorel.collect.options.zendesk_host ]]"></dorel-third-party>

    <!-- define routing -->
    <app-location route="{{ route }}"></app-location>
    <app-route
        route="{{ route }}"
        pattern="/:page"
        data="{{ routeData }}"
        tail="{{ subroute }}"></app-route>
  
    <dorel-header
      load-complete="[[ loadComplete ]]"
      page="[[ page ]]"></dorel-header>

    <!-- content pages -->
    <main id="main" role="main">

      <iron-pages role="main"
        selected="[[ currentPage.template ]]"
        attr-for-selected="name">
        
        <dorel-template-home 
          name="home" 
          template-data="[[ currentPage ]]"></dorel-template-home>

        <dorel-template-info 
          name="info" 
          template-data="[[ currentPage ]]"></dorel-template-info>

        <dorel-template-products
          name="products"
          route="[[ subroute ]]"
          template-data="[[ currentPage ]]"></dorel-template-products>

        <dorel-template-404 name="404"></dorel-template-404>
      </iron-pages>
    </main>

    <dorel-footer></dorel-footer>
    
    <!-- a11y announcer -->
    <div class="announcer" aria-live="assertive">[[ _a11yLabel ]]</div>
  </template>

  <script>
    // performance logging
    window.performance && performance.mark && performance.mark('dorel-app - before register');

    Polymer({
      is: 'dorel-app',

      /** 
       * @name properties
       * @description all properties this component uses
       */
      properties: {

        /**
         * @name route
         * @description defines the current route
         */
        route: {
          type: String
        },

        /**
         * @name page
         * @description define the current page
         */
        page: {
          type: String
        },

        /**
         * @name currentPage
         * @description defines the currentPage
         */
        currentPage: {
          type: Object
        }

      },

      /**
       * @name observers
       * @description observe if a function is called
       */
      observers: [
        '_routePageChanged(routeData.page, globals.Dorel.collect.pages)',
        '_pageChanged(page, currentPage)',
        '_setCurrentPage(currentPage)'
      ],

      /**
       * @name listeners
       * @description listens to all different fires
       */
      listeners: {
        'change-section': '_onChangeSection',
        'announce': '_onAnnounce',
        'dom-change': '_domChange'
      },

      created: function() {
        window.performance && performance.mark && performance.mark('dorel-app.created');
        
        // Create the Dorel global https://github.com/ivanrod/polymer-global-variables-demo
        Polymer.globalsManager.set('Dorel', {
          wpUrl: {}, // will be a string later (bug inside globalsManager)
          collect: {},
          current: {},
          events: {}
        });

        // Custom elements polyfill safe way to indicate an element has been upgraded.
        this.removeAttribute('unresolved');
      },

      ready: function() {

        // Define the wpUrl in the globals (object becomes string)
        Polymer.globalsManager.set('Dorel.wpUrl', CONFIG.CMS_URL);

        // listen for online/offline
        Polymer.RenderStatus.afterNextRender(this, function() {
          this.listen(window, 'online', '_notifyNetworkStatus');
          this.listen(window, 'offline', '_notifyNetworkStatus');
        });

        // Checks the apps config, and sets the according brand theme   
        var brandTheme = ['theme', CONFIG.BRAND_NAME, 'shared-styles'].join('-');
        var myDomModule = document.createElement('style', 'custom-style');
        myDomModule.setAttribute('include', brandTheme);
        Polymer.dom(this.root).appendChild(myDomModule);
      },

      /**
       * @observer
       * @name _routePageChanged
       * @description on url/route change get the first segment of the url
       * then set it as the page. With those settings start the setCurrentPage
       * which will change the iron-pages selected
       *
       * @param page - String - the route page string
       * @param pages - Array - all the retrieved pages from WP
       */
      _routePageChanged: function(page, pages) {

        // if the route is undefined
        if (typeof page === 'undefined' || typeof pages === 'undefined' || !pages.length) return;

        // refer to this for find function
        var self = this;

        /** 
         * if last segment is undefined or empty string set too home, 
         * all others to segment
         */
        this.page = page || 'home';

        // map the page variable to the item in the menu array and set it
        this.currentPage = pages.find(function(item) {
          return item.slug === self.page;
        });

        // when the page cannot be matched, it is always the 404
        if (typeof this.currentPage === 'undefined') {

          // set the page to 404
          this.page = '404';

          // set the currentPage to 404
          this.currentPage = {
            template: '404'
          };
        }
      },

      /**
       * @observer
       * @name _pageChanged
       * @description when the page variable changes lazyload the page
       * or retrieve it all the way.
       * @param page - string - the page we need to transition to
       * @param currentPage - Object - the previous page
       */
      _pageChanged: function(page, currentPage) {

        if (typeof page === 'undefined' || page === '' ||
          typeof currentPage === 'undefined' || currentPage === '') return;
          
        // home route is eagerly loaded
        if (page === 'home') {

          this._ensureLazyLoaded();

        // other routes are lazy loaded
        } else {

          // import the template on demand
          this.importHref(
            this.resolveUrl('templates/dorel-template-' + currentPage.template + '.html'),
            function() {
              this._ensureLazyLoaded();
            }, null, false);

        }

      },

      /**
       * @listener
       * @name _setCurrentPage
       * @description set the current page in the globals
       */
      _setCurrentPage: function(currentPage) {
        // set the global currentPage
        Polymer.globalsManager.set('Dorel.current.page', currentPage);

        // tracking of the pageload
        this._eventTracking();
      },

      /**
       * @name _ensureLazyLoaded
       * @description if the load is completed we will add the resources
       * the service worker will kick in after that.
       */
      _ensureLazyLoaded: function() {
        var self = this;
        // load lazy resources after render and set `loadComplete` when done.
        if (!this.loadComplete) {
          Polymer.RenderStatus.afterNextRender(this, function() {
            this.importHref(this.resolveUrl('dorel-app-resources.html'), function() {

              // Register service worker if supported.
              if ('serviceWorker' in navigator) {
                // navigator.serviceWorker.register('../service-worker.js');
              }

              this._notifyNetworkStatus();
              this.loadComplete = true;
              this._removeLoadPlaceholder();

              // import the footer after the pages are loaded
              this.importHref(this.resolveUrl('organisms/dorel-footer.html'), null, null, false);
            });
          });
        }

      },

      /**
       * @name _removeLoadPlaceholder
       * @description removes loading spinner and placeholders before the page is loaded
       */
      _removeLoadPlaceholder: function() {
        var placeholder = document.getElementById('load-placeholder');
        placeholder.remove();
      },

      /**
       * @listener
       * @name _currentPageChanged
       * @description fire the change-section event, that will set the given
       * title to its title tag
       */
      _currentPageChanged: function(newVal) {
        if(typeof newVal === 'undefined') return;

        this.currentPage = newVal;

        this.fire('change-section', { 
          title: newVal.title.rendered
        });

      },

      /**
       * @name _notifyNetworkStatus
       * @description checks to see if we have internet connection and
       * sends notification to the user if offline
       */
      _notifyNetworkStatus: function() {
        var oldOffline = this.offline;
        this.offline =  !navigator.onLine;

        // Show the snackbar if the user is offline when starting a new session
        // or if the network status changed.
        if (this.offline || (!this.offline && oldOffline === true)) {
          if (!this._networkSnackbar) {
            this._networkSnackbar = document.createElement('dorel-snackbar');
            Polymer.dom(this.root).appendChild(this._networkSnackbar);
          }
          Polymer.dom(this._networkSnackbar).innerHTML = this.offline ?
              'You are offline' : 'You are online';
          this._networkSnackbar.open();
        }
      },

      /**
       * @name _onChangeSection
       * @description Elements in the app can notify section changes. Response 
       * by a11y announcing the section and syncronizing the category.
       */
      _onChangeSection: function(event) {
        var detail = event.detail;
        this.categoryName = detail.category || '';

        // Announce the page's title
        if (detail.title) {
          document.title = detail.title + ' - Maxi Cosi';
          this._announce(detail.title + ', loaded');
        }
      },

      /**
       * @name _onAnnounce
       * @description starts announcing and setting the label
       */
      _onAnnounce: function(e) {
        this._announce(e.detail);
      },

      /**
       * @name _announce
       * @description A11y announce the given message.
       */
      _announce: function(message) {
        this._a11yLabel = '';
        this.debounce('_a11yAnnouncer', function() {
          this._a11yLabel = message;
        }, 100);
      },

      /**
       * @name _setCurrentMenuItem
       * @description set the current menu item by matching the slug
       * to the menu items url
       * TODO: refactor for better use
       */
      _setCurrentMenuItem: function(page, mainMenuItems) {

        // if menu array has no items
        if( !mainMenuItems.length ) { return; }

        // map the page variable to the item in the mainMenuItems array and set it 
        this.currentMenuItem = mainMenuItems.find(function(item) {
          return (page === item.url.substring(1)) ? item.object_id : false;
        });

        // set the global currentMenuItem
        Polymer.globalsManager.set('Dorel.current.menuItem', this.currentMenuItem);
      },

      /**
       * @name _domChange
       * @description This is for performance logging only.
       */
      _domChange: function(e) {
        if (window.performance && performance.mark && !this.__loggedDomChange) {
          var target = Polymer.dom(e).rootTarget;
          if (target.domHost.is.match(this.page)) {
            this.__loggedDomChange = true;
            performance.mark(target.domHost.is + '.domChange');
          }
        }
      },

      /**
       * @name _eventTracking
       * @description this is for pageload tracking only
       * more info http://bit.ly/2nb6I7G
       */
      _eventTracking: function() {
        var globalsObj = Polymer.globalsManager.get('Dorel');
        var globalsCopy = this._cloneObj(globalsObj);

        /** 
         * Tracking on pageload
         */
        Polymer.globalsManager.set('Dorel.events', {
          action: 'loaded',
          component: 'page',
          element: this,
          event: 'polymer_event',
          things: {
            'currentPage': (typeof globalsCopy.current.page === 'undefined') ?
              document.URL : globalsCopy.current.page,
            'globals': globalsCopy
          }
        });
      },

      /**
       * @name _cloneObj
       * @description creates a clone of an object
       *
       * @parameter Object - object to clone
       */
      _cloneObj: function(obj) {

        // if object is not defined or not an object, jump out
        if (null == obj || "object" != typeof obj) return obj;

        // make a reference to the object's constructor
        var copy = obj.constructor();

        // iterate over every attribute in the object and make a copy
        for (var attr in obj) {
            if (obj.hasOwnProperty(attr)) copy[attr] = obj[attr];
        }

        // return the copied object
        return copy;
      },

      /**
       * @name _getLastSegment
       * @description strips the last segment from the url
       *
       * @parameter String - current document url
       */
      _getLastSegment: function(url) {
        url = url.replace(/(^\w+:|^)\/\//, '');

        if ( url.lastIndexOf('/') === (url.length -1) ) {
          url = url.substr(0,url.lastIndexOf('/'));
        }
        
        return url.substr(url.lastIndexOf('/') +1, url.length);
      }

    });
  </script>
</dom-module>
