<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="utils/dorel-global-variables.html">
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../bower_components/iron-media-query/iron-media-query.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">

<!-- used by store locator -->
<link rel="import" href="atoms/dorel-safe-html.html">

<!-- TODO: These should only be included conditionally, based on the app-config.js AVAILABLE_BRANDS -->
<link rel="import" href="themes/theme-maxi-cosi-shared-styles.html">
<link rel="import" href="themes/theme-dorel-shared-styles.html">
<link rel="import" href="themes/theme-quinny-shared-styles.html">

<!-- Header has priority for perceived initial load -->
<link rel="import" href="organisms/dorel-header.html">

<!-- Since 'home' is the default route, eagerly load it. -->
<link rel="import" href="templates/dorel-template-home.html">

<!-- Load the breakpoints early as well -->
<link rel="import" href="atoms/dorel-media-query.html">

<!-- Load the magento authentication eagerly -->
<link rel="import" href="utils/dorel-magento-auth.html">

<link rel="import" href="utils/dorel-wp-collect-menu-locations.html">
<link rel="import" href="utils/dorel-wp-collect-pages.html">
<link rel="import" href="utils/dorel-wp-collect-options.html">
<link rel="import" href="utils/dorel-wp-collect-widgets.html">
<link rel="import" href="utils/dorel-wp-collect-categories.html">
<link rel="import" href="utils/dorel-meta-manager.html">
<link rel="import" href="utils/dorel-main-routing.html">
<link rel="import" href="utils/dorel-product-category-manager.html">

<link rel="import" href="atoms/dorel-grid-overlay.html">

<dom-module id="dorel-app">
  <template>
    <style>
      /*
       * Application wide styling
       * - Will define standard styling for components
       */
      :host {
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        @apply(--theme-typography-2);
        margin: 0;
        --primary-color: var(--theme-brand-color-1);
        color: var(--theme-color-black);
        display: block;
        min-height: 100vh;
      }

      :root {
        /* global input colors */
        --paper-input-container-underline: {
          border-bottom: 2px solid var(--theme-brand-color-1);
        };

      }

      main {
        min-height: calc(100vh - 155px);
      }

      iron-pages {
        margin: 0 auto;
        min-height: 100vh;
      }

    </style>

    <!-- retrieve all menu items from wordpress (uses rest api menus plugin) -->
    <dorel-wp-collect-menu-locations
      wp-url="{{ globals.Dorel.wpUrl }}"></dorel-wp-collect-menu-locations>

    <!-- collect all pages from wordpress -->
    <dorel-wp-collect-pages></dorel-wp-collect-pages>

    <!-- collect the options pages -->
    <dorel-wp-collect-options
      wp-url="[[ globals.Dorel.wpUrl ]]"></dorel-wp-collect-options>

    <!-- collect the widgets from wordpress (uses rest api sidebars plugin) -->
    <dorel-wp-collect-widgets></dorel-wp-collect-widgets>

    <dorel-wp-collect-categories></dorel-wp-collect-categories>

    <!-- analytics -->
    <google-tag-manager cid="GTM-TW3TM86"></google-tag-manager>
    <dorel-gtm-events
      gtm-data="[[ globals.Dorel ]]"></dorel-gtm-events>

    <dorel-third-party
      hubspot-toggle="{{ globals.Dorel.collect.options.hubspot_toggle }}"
      hubspot-portal-id="{{ globals.Dorel.collect.options.hubspot_portal_id }}"
      zendesk-toggle="[[ globals.Dorel.collect.options.zendesk_toggle ]]"
      zendesk-host="[[ globals.Dorel.collect.options.zendesk_host ]]"></dorel-third-party>

    <!-- define routing -->
    <app-location route="{{ route }}"></app-location>
    <app-route
      route="{{ route }}"
      pattern="/:page"
      data="{{ routeData }}"
      tail="{{ subroute }}"></app-route>

    <dorel-main-routing
      route="[[ route ]]"
      category-page="{{ categoryPage }}"
      previous-states="{{ previousStates }}"
      current-page="{{ currentPage }}">
    </dorel-main-routing>

    <dorel-meta-manager
      brand-name="[[ brand.label ]]"
      current-page="[[ currentPage ]]"
      id="metaManager">
    </dorel-meta-manager>

    <dorel-product-category-manager
      category-page="[[ categoryPage ]]"
      sort="{{ sort }}"
      category="{{ category }}">
    </dorel-product-category-manager>

    <template is="dom-if" if="[[ shouldShowHeader(currentPage) ]]">
      <dorel-header
        load-complete="[[ loadComplete ]]"
        page="[[ page ]]"
        brand-name="[[ brand.label ]]"></dorel-header>
    </template>

    <!-- content pages -->
    <main id="main" role="main">

      <iron-pages role="main"
                  selected="[[ currentPage.template ]]"
                  attr-for-selected="name">

        <dorel-template-home
          name="home"
          template-data="[[ currentPage ]]"></dorel-template-home>

        <dorel-template-info
          name="info"
          template-data="[[ currentPage ]]"></dorel-template-info>

        <dorel-template-store-locator
          name="store-locator"
          template-data="[[ currentPage ]]"></dorel-template-store-locator>

        <dorel-template-products
          name="products"
          route="[[ subroute ]]"
          template-data="[[ currentPage ]]"></dorel-template-products>

        <dorel-template-product-detail
          name="product-detail"
          route="[[ subroute ]]"
          category="[[ category ]]"
          template-data="[[ currentPage ]]"></dorel-template-product-detail>

        <dorel-template-product-category
          name="product-category"
          route="[[ subroute ]]"
          category="[[ category ]]"
          template-data="[[ currentPage ]]"></dorel-template-product-category>

        <dorel-template-product-advisory-tool
          name="product-advisory-tool"
          brand-name="[[ brand.label ]]"
          template-data="[[ currentPage ]]"></dorel-template-product-advisory-tool>

        <dorel-template-component-guide
          name="component-guide"
          brand="{{ brand }}"
          available-brands="{{ brandNames }}"
          route="{{ subroute }}"></dorel-template-component-guide>

        <dorel-template-404 name="404"></dorel-template-404>

      </iron-pages>
    </main>

    <template is="dom-if" if="[[ shouldShow(currentPage) ]]">
      <dorel-footer></dorel-footer>
    </template>

    <dorel-grid-overlay available-brands="{{ brandNames }}"
                        selected-brand="{{ brand }}"
                        page-route-path="{{ route.path }}"></dorel-grid-overlay>
  </template>

  <script>
    // performance logging
    window.performance && performance.mark && performance.mark('dorel-app - before register');

    Polymer({
      is: 'dorel-app',

      /**
       * @name properties
       * @description all properties this component uses
       */
      properties: {

        /**
         * @name route
         * @description defines the current route
         */
        route: {
          type: String
        },

        /**
         * @name page
         * @description define the current page
         */
        page: {
          type: String,
          notify: true,
          readOnly: false,
        },

        /**
         * @name brandNames
         * @description available brand names (from config), used for switching between brands
         */
        brandNames: {
          type: Array,
          value: []
        },

        /**
         * @name currentPage
         * @description defines the currentPage
         */
        currentPage: {
          type: Object
        },

        categoryPage: {
          type: Object
        },

        category: {
          type: Number
        }

      },

      /**
       * @name observers
       * @description observe if a function is called
       */
      observers: [
        '_pageChanged(currentPage)',
        '_brandChanged(brand)'
      ],

      created: function () {
        window.performance && performance.mark && performance.mark('dorel-app.created');

        // Create the Dorel global https://github.com/ivanrod/polymer-global-variables-demo
        Polymer.globalsManager.set('Dorel', {
          wpUrl: {}, // will be a string later (bug inside globalsManager)
          dioApiUrl: {},
          locale: {},
          collect: {},
          current: {
            brandName: ''
          },
          product: {
            products: [],
            attributes: {
              accordions: [],
              features: [],
              usps: []
            },
            retrievedCategories: [],
            auth: {
              token: '',
              timestamp: ''
            },
            colorMap: []
          },
          events: {},
          grid: {
            horizontal: false,
            vertical: false
          }
        });

        // Custom elements polyfill safe way to indicate an element has been upgraded.
        this.removeAttribute('unresolved');
      },

      ready: function () {

        // Define the wpUrl in the globals (object becomes string)
        Polymer.globalsManager.set('Dorel.wpUrl', CONFIG.CMS_URL);

        // Define the custom api in the globals (obj becomes string)
        Polymer.globalsManager.set('Dorel.dioApiUrl', CONFIG.DIO_API_URL);
        Polymer.globalsManager.set('Dorel.locale', CONFIG.LOCALE);

        this.brandNames = CONFIG.AVAILABLE_BRANDS;
        this.brand = this.brandNames[CONFIG.SELECTED_BRAND];
        Polymer.globalsManager.set('Dorel.current.brandName', this.brand);
      },


      /**
       * @observer
       * @name _brandChanged
       * @description the brand was changed, triggers a change in shared styles
       *
       * @param page - String - the string of the current active brand
       */
      _brandChanged: function (brand) {
        //Removed the current shared style from the dom, if it exists.
        var currentSharedStyle = Polymer.dom(this.root).querySelector('#brand-shared-style');
        if (currentSharedStyle != undefined) {
          currentSharedStyle.remove();
        }

        // Checks the apps config, and sets the according brand theme
        var brandTheme = ['theme', brand.label, 'shared-styles'].join('-').toLowerCase();
        var domModule = document.createElement('style', 'custom-style');
        domModule.setAttribute('include', brandTheme);
        domModule.setAttribute('id', 'brand-shared-style');
        Polymer.dom(this.root).appendChild(domModule);
        Polymer.updateStyles();
      },

      /**
       * @observer
       * @name _pageChanged
       * @description when the page variable changes lazyload the page
       * or retrieve it all the way.
       * @param currentPage - Object - the previous page
       */
      _pageChanged: function(currentPage) {
        if (typeof currentPage === 'undefined' || currentPage === '') {
          return;
        }

        if(currentPage.template === 'home') {
          this._ensureLazyLoaded();
        } else {
          this.importHref(
            this.resolveUrl('templates/dorel-template-' + currentPage.template + '.html'),
            function () {
              this._ensureLazyLoaded();
            }, null, false);
        }

        // tracking of the pageload
        this._eventTracking();
      },

      /**
       * @name _ensureLazyLoaded
       * @description if the load is completed we will add the resources
       * the service worker will kick in after that.
       */
      _ensureLazyLoaded: function () {
        var self = this;

        // scroll up when a page is changed
        window.scrollTo(0, 0);

        // load lazy resources after render and set `loadComplete` when done.
        if (!this.loadComplete) {
          Polymer.RenderStatus.afterNextRender(this, function () {
            this.importHref(this.resolveUrl('dorel-app-resources.html'), function () {

              // Register service worker if supported.
              if ('serviceWorker' in navigator) {
                // navigator.serviceWorker.register('/service-worker.js');
              }

              this.loadComplete = true;
              this._removeLoadPlaceholder();
              // import the footer after the pages are loaded
              this.importHref(this.resolveUrl('organisms/dorel-footer.html'), null, null, false);
            });
          });
        }
      },

      /**
       * @name _removeLoadPlaceholder
       * @description removes loading spinner and placeholders before the page is loaded
       */
      _removeLoadPlaceholder: function () {
        var placeholder = document.getElementById('load-placeholder');
        placeholder.remove();
      },

      /**
       * @name _eventTracking
       * @description this is for pageload tracking only
       * more info http://bit.ly/2nb6I7G
       */
      _eventTracking: function () {
        var globalsObj = Polymer.globalsManager.get('Dorel');
        var globalsCopy = this._cloneObj(globalsObj);

        /**
         * Tracking on pageload
         */
        Polymer.globalsManager.set('Dorel.events', {
          action: 'loaded',
          component: 'page',
          element: this,
          event: 'polymer_event',
          things: {
            'currentPage': (typeof globalsCopy.current.page === 'undefined') ?
              document.URL : globalsCopy.current.page,
            'globals': globalsCopy
          }
        });
      },

      /**
       * @name _cloneObj
       * @description creates a clone of an object
       *
       * @parameter Object - object to clone
       */
      _cloneObj: function (obj) {

        // if object is not defined or not an object, jump out
        if (null == obj || "object" != typeof obj) return obj;

        // make a reference to the object's constructor
        var copy = obj.constructor();

        // iterate over every attribute in the object and make a copy
        for (var attr in obj) {
          if (obj.hasOwnProperty(attr)) copy[attr] = obj[attr];
        }

        // return the copied object
        return copy;
      },

      shouldShowHeader: function(currentPage) {
        return Boolean(currentPage && currentPage.template !== 'product-advisory-tool');
      }

    });
  </script>
</dom-module>
