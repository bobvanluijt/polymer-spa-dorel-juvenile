<link rel="import" href="../node_modules/polymer/polymer.html">
<link rel="import" href="../node_modules/app-route/app-location.html">
<link rel="import" href="../node_modules/app-route/app-route.html">
<link rel="import" href="../node_modules/iron-ajax/iron-ajax.html">
<link rel="import" href="../node_modules/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../node_modules/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../node_modules/iron-media-query/iron-media-query.html">
<link rel="import" href="../node_modules/iron-pages/iron-pages.html">

<!-- Header has priority for perceived initial load -->
<link rel="import" href="organisms/dorel-header.html">
<link rel="import" href="atoms/dorel-safe-html.html">

<!-- Layout, responsive components -->
<link rel="import" href="atoms/dorel-media-query.html">
<link rel="import" href="atoms/layout/dorel-layout-container.html">
<link rel="import" href="atoms/layout/dorel-layout-column.html">
<link rel="import" href="atoms/layout/dorel-layout-row.html">

<!-- SHARED BEHAVIORS -->
<link rel="import" href="utils/behaviors/specific/dorel-app-cache-behavior.html">
<link rel="import" href="utils/behaviors/bundled/dorel-conditional-behaviors.html">
<link rel="import" href="utils/behaviors/bundled/dorel-template-behaviors.html">
<link rel="import" href="utils/behaviors/single/dorel-multilingual-behavior.html">
<link rel="import" href="utils/behaviors/single/dorel-social-behavior.html">

<!-- Load the magento authentication eagerly -->
<link rel="import" href="utils/dorel-magento-auth.html">
<link rel="import" href="utils/dorel-gmt-collect-faqs.html">
<link rel="import" href="utils/dorel-wp-collect-menu-locations.html">
<link rel="import" href="utils/dorel-wp-collect-pages.html">
<link rel="import" href="utils/dorel-wp-collect-options.html">
<link rel="import" href="utils/dorel-wp-collect-widgets.html">
<link rel="import" href="utils/dorel-wp-collect-templates.html">
<link rel="import" href="utils/dorel-multilingual-manager.html">
<link rel="import" href="utils/dorel-wp-collect-categories.html">
<link rel="import" href="utils/dorel-meta-manager.html">
<link rel="import" href="utils/dorel-routing.html">
<link rel="import" href="utils/dorel-brand-manager.html">
<link rel="import" href="utils/dorel-main-menu-creator.html">


<!-- SHARED ORGANISMS -->
<link rel="import" href="organisms/dorel-header.html">
<link rel="import" href="organisms/dorel-section-hero-header.html">
<link rel="import" href="organisms/dorel-section-cta.html">
<link rel="import" href="organisms/dorel-section-heroes.html">
<link rel="import" href="organisms/dorel-section-cards.html">

<!-- Since 'home' is the default route, eagerly load it. -->
<link rel="import" href="templates/dorel-template-home.html">

<link rel="import" href="atoms/dorel-grid-overlay.html">

<dom-module id="dorel-app" mobile-menu-opened$="{{ mobileMenuOpened }}">
  <template>
    <custom-style>
      <style include="theme-shared-styles"></style>

      <style is="custom-style">
        :host > * {
          -webkit-font-smoothing: antialiased;
          -moz-osx-font-smoothing: grayscale;
          @apply(--theme-typography-2);
          margin: 0;
          color: var(--theme-color-black);
        }

        main {
          min-height: calc(100vh - 155px);
        }

        iron-pages {
          margin: 0 auto;
          min-height: 100vh;
        }
      </style>
    </custom-style>
    <!-- define routing -->
    <app-location route="{{ route }}"></app-location>

    <app-route
      route="{{ route }}"
      pattern="/:language"
      query-params="{{ queryParams }}"
      tail="{{ tail }}"></app-route>

    <app-route
      route="{{ tail }}"
      pattern="/:page"
      tail="{{ subroute }}"></app-route>

    <dorel-multilingual-manager
      route="[[ route ]]"
      current-language="[[ appCache.currentLanguage ]]"
      continents-data="{{ continentsData }}">
    </dorel-multilingual-manager>

    <!-- collect all pages from wordpress -->
    <dorel-wp-collect-page app-cache="[[ appCache ]]"></dorel-wp-collect-page>

    <!-- collect the options pages -->
    <dorel-wp-collect-options app-cache="[[ appCache ]]"></dorel-wp-collect-options>

    <!-- create datamodel for the main menu -->
    <dorel-main-menu-creator app-cache="[[ appCache ]]"></dorel-main-menu-creator>

    <!-- analytics -->
    <google-tag-manager cid="GTM-TW3TM86"></google-tag-manager>

    <dorel-gtm-events gtm-data="[[ appCache ]]"></dorel-gtm-events>

    <dorel-third-party app-cache="[[ appCache ]]"></dorel-third-party>

    <dorel-brand-manager
      query-params="[[ queryParams ]]"
      brandNames="{{ brandNames }}"
      brand="{{ brand }}">
    </dorel-brand-manager>

    <dorel-meta-manager
      brand-name="[[ brand.label ]]"
      current-page="[[ currentPage ]]"
      app-cache="[[ appCache ]]"
      route="[[ route ]]"
      id="metaManager">
    </dorel-meta-manager>

    <dorel-routing
      app-cache="[[ appCache ]]"
      full-route="[[ route ]]">
    </dorel-routing>

    <template is="dom-if" if="[[ shouldShow(currentPage) ]]">
      <dorel-header
        app-cache="[[ appCache ]]"
        load-complete="[[ loadComplete ]]"
        route="[[ route ]]"
        continents-data="[[ continentsData ]]"
        current-language="[[ appCache.currentLanguage ]]"
        mobile-menu-opened="{{ mobileMenuOpened }}"
        page="[[ page ]]"
        brand-name="[[ brand.label ]]">
      </dorel-header>
    </template>

    <!-- content pages -->
    <main id="main" role="main">

      <iron-pages role="main"
                  selected="[[ currentPage.template ]]"
                  attr-for-selected="name">

        <dorel-template-product-about
          name="product-about"
          template-data="[[ currentPage ]]"></dorel-template-product-about>

        <dorel-template-home
          name="home"
          template-data="[[ currentPage ]]"></dorel-template-home>

        <dorel-template-info
          name="info"
          app-cache="[[ appCache ]]"
          template-data="[[ currentPage ]]"></dorel-template-info>

        <dorel-template-info-overview
          name="info-overview"
          app-cache="[[ appCache ]]"
          template-data="[[ currentPage ]]"></dorel-template-info-overview>

        <dorel-template-store-locator
          name="store-locator"
          app-cache="[[ appCache ]]"
          template-data="[[ currentPage ]]"></dorel-template-store-locator>

        <dorel-template-marketing-campaign
          name="marketing-campaign"
          app-cache="[[ appCache ]]"
          template-data="[[ currentPage ]]"></dorel-template-marketing-campaign>

        <dorel-template-products
          name="products"
          route="[[ subroute ]]"
          template-data="[[ currentPage ]]"></dorel-template-products>

        <dorel-template-product-detail
          name="product-detail"
          route="[[ subroute ]]"
          app-cache="[[ appCache ]]"
          category="[[ category ]]"
          template-data="[[ currentPage ]]"></dorel-template-product-detail>

        <dorel-template-accessory-detail
          name="accessory-detail"
          route="[[ subroute ]]"
          app-cache="[[ appCache ]]"
          category="[[ category ]]"
          template-data="[[ currentPage ]]"></dorel-template-accessory-detail>

        <dorel-template-product-listing
          name="product-listing"
          route="[[ subroute ]]"
          app-cache="[[ appCache ]]"
          category="[[ category ]]"></dorel-template-product-listing>

        <dorel-template-faq-overview
          name="faq-overview"
          app-cache="[[ appCache ]]"
          route="[[ subroute ]]"
          template-data="[[ currentPage ]]"></dorel-template-faq-overview>

        <dorel-template-faq-detail
          name="faq-detail"
          app-cache="[[ appCache ]]"
          route="[[ subroute ]]"
          template-data="[[ currentPage ]]"></dorel-template-faq-detail>

        <dorel-template-product-advisory-tool
          name="product-advisory-tool"
          app-cache="[[ appCache ]]"
          brand-name="[[ brand.label ]]"
          template-data="[[ currentPage ]]"></dorel-template-product-advisory-tool>

        <dorel-template-component-guide
          name="component-guide"
          app-cache="[[ appCache ]]"
          brand="{{ brand }}"
          available-brands="{{ brandNames }}"
          route="{{ subroute }}"></dorel-template-component-guide>

        <dorel-template-404 name="404"></dorel-template-404>

      </iron-pages>
    </main>

    <template
      is="dom-if"
      if="[[ shouldShow(currentPage) ]]">
      <dorel-footer
        id="footer"
        app-cache="[[ appCache ]]"
        continents-data="[[ continentsData ]]"
        current-language="[[ appCache.currentLanguage ]]">
      </dorel-footer>
    </template>

    <dorel-grid-overlay
      app-cache="[[ appCache ]]"
      available-brands="{{ brandNames }}"
      selected-brand="{{ brand }}"
      page-route-path="{{ route.path }}"></dorel-grid-overlay>
  </template>

  <script>
    // performance logging
    window.performance && performance.mark && performance.mark('dorel-app - before register');

    class DorelApp extends ReduxMixin(Polymer.mixinBehaviors([appCacheBehavior], Polymer.Element)) {

      static get is() {
        return 'dorel-app';
      }

      static get properties() {
        return {
          /**
           * @name route
           * @description defines the current route
           */
          route: {
            type: String
          },

          /**
           * @name page
           * @description define the current page
           */
          page: {
            type: String,
            notify: true,
            readOnly: false,
          },

          mobileMenuOpened: {
            type: Boolean,
            reflectToAttribute: true,
            value: false
          },

          /**
           * @name brand
           * @description The currently selected brand
           */
          brand: {
            type: Object,
            value: function () {
              return CONFIG.AVAILABLE_BRANDS[CONFIG.SELECTED_BRAND];
            }
          },

          /**
           * @name brandNames
           * @description available brand names (from config), used for switching between brands
           */
          brandNames: {
            type: Array,
            value: function () {
              return CONFIG.AVAILABLE_BRANDS;
            }
          },

          /**
           * @name currentPage
           * @description defines the currentPage
           */
          currentPage: {
            type: Object,
            statePath: 'page.currentPage'
          },

          category: {
            type: Number,
            statePath: 'product.productCategoryPage'
          }
        };
      }

      static get observers () {
        return [
          '_pageChanged(currentPage)',
          '_brandChanged(brand)'
        ]
      }

      constructor() {
        super();
      }

      connectedCallback() {
        super.connectedCallback();
        window.performance && performance.mark && performance.mark('dorel-app.created');

        // Custom elements polyfill safe way to indicate an element has been upgraded.
        this.removeAttribute('unresolved');
      }

      ready() {
        super.ready();
        window.app = this;
      }

      /**
       * @observer
       * @name _pageChanged
       * @description when the page variable changes lazyload the page
       * or retrieve it all the way.
       * @param currentPage - Object - the previous page
       */
      _pageChanged(currentPage) {
        if (typeof currentPage === 'undefined' || currentPage === '' || !currentPage || !currentPage.template) {
          return;
        }

        if (currentPage.template === 'home') {
          this._ensureLazyLoaded();
        } else {
          this.importHref(
            this.resolveUrl('templates/dorel-template-' + currentPage.template + '.html'),
            function () {
              this._ensureLazyLoaded();
            }, null, false);
        }

        // tracking of the pageload
        this._eventTracking();
      }

      /**
       * @name _ensureLazyLoaded
       * @description if the load is completed we will add the resources
       * the service worker will kick in after that.
       */
      _ensureLazyLoaded() {
        var self = this;

        // scroll up when a page is changed
        window.scrollTo(0, 0);

        // load lazy resources after render and set `loadComplete` when done.
        if (!this.loadComplete) {
          Polymer.RenderStatus.afterNextRender(this, function () {
            this.importHref(this.resolveUrl('dorel-app-resources.html'), function () {

              // Register service worker if supported.
              if ('serviceWorker' in navigator) {
                // navigator.serviceWorker.register('/service-worker.js');
              }

              this.loadComplete = true;
              this._removeLoadPlaceholder();
              // import the footer after the pages are loaded
              this.importHref(this.resolveUrl('organisms/dorel-footer.html'), null, null, false);
            });
          });
        }
      }

      /**
       * @name _removeLoadPlaceholder
       * @description removes loading spinner and placeholders before the page is loaded
       */
      _removeLoadPlaceholder() {
        var placeholder = document.getElementById('load-placeholder');
        placeholder.remove();
      }

      /**
       * @name _eventTracking
       * @description this is for pageload tracking only
       * more info http://bit.ly/2nb6I7G
       */
      _eventTracking() {
        var globalsObj = this.get('appCache');
        var globalsCopy = Object.assign({}, globalsObj);


        /**
         * Tracking on pageload
         */
        var event = {
          action: 'loaded',
          component: 'page',
          element: this,
          event: 'polymer_event',
          things: {
            'currentPage': (typeof globalsCopy.current.page === 'undefined') ?
              document.URL : globalsCopy.current.page,
            'globals': globalsCopy
          }
        };

        this.fire('setAppCache', {value: event, path: 'events'});
      }


      shouldShow(currentPage) {
        return Boolean(currentPage && currentPage.template !== 'product-advisory-tool');
      }

      /**
       * @observer
       * @name _brandChanged
       * @description the brand was changed, imports the right styles and triggers a change in shared styles
       * @param brand - Object - the object containing the brand index and label
       */
      _brandChanged(brand) {
        //TODO: This doesn't work well in Polymer 2, hardcoded the maxicosi style for now.
        /*var self = this;

         // Create the brand identifier string
         self.brandTheme = ['theme', brand.label, 'shared-styles'].join('-').toLowerCase();
         // Create the brand path using the brand identifier string
         self.brandThemeUrl = 'themes/' + self.brandTheme + '.html';

         // First import and load the theme
         this.importHref(this.resolveUrl(self.brandThemeUrl), function () {
         //Removed the current shared style from the dom, if it exists.
         var currentSharedStyle = this.shadowRoot.querySelector('#brand-shared-style');

         if (currentSharedStyle !== null) {
         currentSharedStyle.parentNode.removeChild(currentSharedStyle);
         }

         // Build up the right DOM elements to use the stule.
         var domModuleChild = document.createElement('style');
         domModuleChild.setAttribute('include', self.brandTheme);

         var domModule = document.createElement('custom-style');
         domModule.setAttribute('id', 'brand-shared-style');
         domModule.appendChild(domModuleChild);

         // Add the style to the DOM
         this.shadowRoot.appendChild(domModule);

         //Render the styles
         console.log('Rendering new styles');
         //Polymer.updateStyles();
         //Polymer.dom.flush();
         });*/
      }

  };
  customElements.define(DorelApp.is, DorelApp);
  </script>
</dom-module>
