<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../bower_components/app-layout/app-scroll-effects/effects/waterfall.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../bower_components/app-layout/helpers/helpers.html">
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../bower_components/iron-media-query/iron-media-query.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<!-- <link rel="import" href="../bower_components/iron-selector/iron-selector.html"> -->
<link rel="import" href="../bower_components/polymer-bootstrap/polymer-bootstrap-min.html">

<link rel="import" href="../assets/cdn/theme-dorel-shared-styles.html">
<link rel="import" href="../assets/cdn/theme-maxicosi-shared-styles.html">

<link rel="import" href="atoms/dorel-gtm-events.html">
<link rel="import" href="organisms/dorel-page-builder.html">
<link rel="import" href="templates/dorel-template.html">

<link rel="import" href="dorel-app-placeholder.html">

<!-- enable global variables -->
<script src="/bower_components/polymer-global-variables/dist/polymer-global-variables.js"></script>

<dom-module id="dorel-app">
  <template>
    <style include="theme-maxicosi-shared-styles polymer-bootstrap-min iron-flex iron-flex-alignment">
      /* 
       * Application wide styling
       * - Will define standard styling for components
       */
      :host {
        --primary-color: var(--theme-brand-color);
        color: var(--theme-primary-text-color);
        display: block;
        position: relative;
        min-height: 100vh;
      }

      :root {
        /* global input colors */
        --paper-input-container-underline: {
          border-bottom: 2px solid var(--theme-brand-color);
        };

        --paper-input-container-focus-color: var(--theme-brand-color-royal-blue);

        --paper-input-container-label-focus: {
          color: var(--theme-brand-color-royal-blue);
        };

      }
      
      /*#main[mobile-small],
      #main[mobile-medium] {
        padding-top: 160px;
      }
      #main[tablets] {
        padding-top: 227px;
      }
      #main[desktop-small],
      #main[desktop-full] {
        padding-top: 160px;
      }*/

      iron-pages {
        margin: 0 auto;
      }

      .announcer {
        position: fixed;
        height: 0;
        overflow: hidden;
      }
    </style>

    <!-- analytics -->
    <google-tag-manager cid="GTM-TW3TM86"></google-tag-manager>

    <dorel-gtm-events
      gtm-data="{{ globals.Dorel }}"></dorel-gtm-events>

    <!-- media queries -->
    <iron-media-query query="(max-width : 479px)" 
      query-matches="{{ mobileSmall }}"></iron-media-query>
    <iron-media-query query="(min-width : 480px) and (max-width : 767px)"
      query-matches="{{ mobileMedium }}"></iron-media-query>
    <iron-media-query query="(min-width : 768px) and (max-width : 991px)"
      query-matches="{{ tablets }}"></iron-media-query>
    <iron-media-query query="(min-width : 992px) and (max-width : 1199px)" 
      query-matches="{{ desktopSmall }}"></iron-media-query>
    <iron-media-query query="(min-width : 1200px)" 
      query-matches="{{ desktopFull }}"></iron-media-query>
  
    <!-- define routing -->
    <app-location route="{{ route }}"></app-location>
    <app-route
        route="{{ route }}"
        pattern="/:page"
        data="{{ routeData }}"
        tail="{{ subroute }}"></app-route>

    <!-- loading placeholder -->
    <!-- <dorel-app-placeholder id="placeholder"></dorel-app-placeholder> -->

    <!-- retrieve all menu items from wordpress (uses rest api menus plugin) -->
    <dorel-wp-collect-menu-locations
      wp-url="[[ globals.Dorel.wpUrl ]]"></dorel-wp-collect-menu-locations>

    <!-- collect the options pages -->
    <dorel-wp-collect-options
      wp-url="[[ globals.Dorel.wpUrl ]]"></dorel-wp-collect-options>

    <!-- collect all pages from wordpress -->
    <dorel-wp-collect-pages
      wp-url="[[ globals.Dorel.wpUrl ]]"></dorel-wp-collect-pages>

    <!-- collect the widgets from wordpress (uses rest api sidebars plugin) -->
    <dorel-wp-collect-widgets
      wp-url="[[ globals.Dorel.wpUrl ]]"></dorel-wp-collect-widgets>
  
    <dorel-header
      load-complete="{{ loadComplete }}"
      page="{{ page }}"></dorel-header>

    <!-- content pages -->
    <main id="main" role="main"
      mobile-small$="{{ mobileSmall }}"
      mobile-medium$="{{ mobileMedium }}"
      tablets$="{{ tablets }}"
      desktop-small$="{{ desktopSmall }}"
      desktop-full$="{{ desktopFull }}">

      <iron-pages role="main"
        selected="{{ globals.Dorel.current.page.id }}"
        attr-for-selected="page-id">
        <template
          is="dom-repeat"
          items="{{ globals.Dorel.collect.pages }}"
          as="page">
          
          <dorel-template
            page-id="[[ page.id ]]"
            template-name="[[ page.template ]]"
            template-data="[[ page ]]"></dorel-template>

        </template>

      </iron-pages>
    </section>

    <dorel-footer></dorel-footer>

    <!-- a11y announcer -->
    <div class="announcer" aria-live="assertive">[[ _a11yLabel ]]</div>

  </template>

  <script>

    // performance logging
    window.performance && performance.mark && performance.mark('dorel-app - before register');

    Polymer({
      is: 'dorel-app',

      /** 
       * @name properties
       * @description all properties this component uses
       */
      properties: {

        /**
         * Variable to define the url of the WP REST API calls
         * TODO: refactor so this gets retrieved from external file
         */
        debug: {
          type: Boolean,
          value: false // Set to false for production reasons
        },

        /**
         * Define the current page
         */
        page: {
          type: String,
          observer: '_pageChanged' // when this var changes call this function
        },

        /**
         * Defines the current route
         */
        route: {
          type: String,
          observer: '_routeChanged'
        },
        
        /**
         * Defines the menuItems
         */
        menuData: {
          type: Array
        },

        /**
         * Defines the currentPage
         */
        currentPage: {
          type: Object
        }
      },

      /**
       * @name observers
       * @description observe if a function is called
       */
      observers: [
        '_setCurrentMenuItem(page, globals.Dorel.collect.menus.main_menu.items)',
        '_setCurrentPage(page, globals.Dorel.collect.pages)',
        '_currentPageChanged(globals.Dorel.current.page)'
      ],

      listeners: {
        'change-section': '_onChangeSection',
        'announce': '_onAnnounce',
        'dom-change': '_domChange'
      },

      created: function() {
        window.performance && performance.mark && performance.mark('dorel-app.created');
        
        // Create the Dorel global https://github.com/ivanrod/polymer-global-variables-demo
        Polymer.globalsManager.set('Dorel', {
          wpUrl: {}, // will be a string later (bug inside globalsManager)
          collect: {},
          current: {},
          events: {}
        });

        // Custom elements polyfill safe way to indicate an element has been upgraded.
        this.removeAttribute('unresolved');
      },

      ready: function() {
        // Define the wpUrl in the globals (object becomes string)
        Polymer.globalsManager.set('Dorel.wpUrl',
          
          // (this.debug) ? '../../assets/data' : '//polymer-wp.dev/wp-json');
          (this.debug) ? '../../assets/data' : '//wrps.api.dryrun.dorel-app.net/wp-json');

        // listen for online/offline
        Polymer.RenderStatus.afterNextRender(this, function() {
          this.listen(window, 'online', '_notifyNetworkStatus');
          this.listen(window, 'offline', '_notifyNetworkStatus');
        });

        /**
         * TODO: DIO-322
        // window.addEventListener('dorel-template-loaded', function() {
        //   this.$.placeholder.remove();
        // }.bind(this));
         */
      },

      /**
       * @name _routeChanged
       * @description TODO
       * @param route object
       */
      _routeChanged: function(route) {
        var segmentArr = route.path.split('/');
        var lastSegment = segmentArr[segmentArr.length - 2];
        this.page = lastSegment || 'home';

        // tracking of the pageload
        this._eventTracking();
      },

      /** 
       * @name _pageChanged
       * @description when the page variable changes lazyload the page
       * or retrieve it all the way.
       * @param page the page we need to transition to
       * @param oldPage the previous page
       *
       * TODO: check correct prpl pattern implementation
       */
      _pageChanged: function(page, oldPage) {
        if (page !== null) {
          this._ensureLazyLoaded();

          // TODO prpl pattern
          // this.importHref(
          //   this.resolveUrl('templates/dorel-template.html'),
          //   function() {
          //     this._pageLoaded(Boolean(oldPage));
          //   }, null, true);

          // TODO if fixed menu
          // var shouldResetLayout = Boolean(oldPage);
          // if (shouldResetLayout) {
          //   // The size of the header depends on the page (e.g. on some pages the tabs
          //   // do not appear), so reset the header's layout only when switching pages.
          //   this.async(function() {
          //     this.$.header.resetLayout();
          //   }, 1);
          // }
        }
      },

      /**
       * @name: _ensureLazyLoaded
       * @description: if the load is completed we will add the resources
       * the service worker will kick in after that.
       */
      _ensureLazyLoaded: function() {
        // load lazy resources after render and set `loadComplete` when done.
        if (!this.loadComplete) {
          Polymer.RenderStatus.afterNextRender(this, function() {
            this.importHref(this.resolveUrl('dorel-app-resources.html'), function() {

              // Register service worker if supported.
              if ('serviceWorker' in navigator) {
                // navigator.serviceWorker.register('../service-worker.js');
              }

              this._notifyNetworkStatus();
              this.loadComplete = true;
            });
          });
        }
      },

      /**
       * @name: _notifyNetworkStatus
       * @description: checks to see if we have internet connection and
       * sends notification to the user if offline
       */
      _notifyNetworkStatus: function() {
        var oldOffline = this.offline;
        this.offline =  !navigator.onLine;

        // Show the snackbar if the user is offline when starting a new session
        // or if the network status changed.
        if (this.offline || (!this.offline && oldOffline === true)) {
          if (!this._networkSnackbar) {
            this._networkSnackbar = document.createElement('dorel-snackbar');
            Polymer.dom(this.root).appendChild(this._networkSnackbar);
          }
          Polymer.dom(this._networkSnackbar).innerHTML = this.offline ?
              'You are offline' : 'You are online';
          this._networkSnackbar.open();
        }
      },

      /**
       * @name: _onChangeSection
       * @description: Elements in the app can notify section changes. Response 
       * by a11y announcing the section and syncronizing the category.
       */
      _onChangeSection: function(event) {
        var detail = event.detail;
        this.categoryName = detail.category || '';

        // Announce the page's title
        if (detail.title) {
          document.title = detail.title + ' - Maxi Cosi';
          this._announce(detail.title + ', loaded');
        }
      },

      /**
       * @name: _onAnnounce
       * @description: starts announcing and setting the label
       */
      _onAnnounce: function(e) {
        this._announce(e.detail);
      },

      /**
       * @name: _announce
       * @description: A11y announce the given message.
       */
      _announce: function(message) {
        this._a11yLabel = '';
        this.debounce('_a11yAnnouncer', function() {
          this._a11yLabel = message;
        }, 100);
      },

      /** 
       * @name _showPage404
       * @description sets the page variable to the 404 page
       */
      _showPage404: function() {
        this.page = '404';
      },

      /**
       * @name _setCurrentMenuItem
       * @description set the current menu item by matching the slug
       * to the menu items url
       * TODO: refactor for better use
       */
      _setCurrentMenuItem: function(page, mainMenuItems) {

        // if menu array has no items
        if( !mainMenuItems.length ) { return; }

        // map the page variable to the item in the mainMenuItems array and set it 
        this.currentMenuItem = mainMenuItems.find(function(item) {
          return (page === item.url.substring(1)) ? item.object_id : false;
        });

        // set the global currentMenuItem
        Polymer.globalsManager.set('Dorel.current.menuItem', this.currentMenuItem);
      },

      /**
       * @name _setCurrentPage
       * @description set the current page in the globals
       */
      _setCurrentPage: function(page, pages) {
        var self = this;
        var pages = Polymer.globalsManager.get('Dorel.collect.pages');
        
        // if menu array has no items
        if( !pages.length ) { return; }

        // map the page variable to the item in the menu array and set it 
        self.currentPage = pages.find(function(item) {
          switch (page) {

            // when we are dealing with multiple segments define them here
            case 'products':
              /**
               * self.route - toRoute
               * self.subroute - fromRoute
               * self.routeData - current first segment
               */
              var segmentArr = self.route.path.split('/');
              var lastSegment = segmentArr[segmentArr.length - 2];

              return (lastSegment === item.slug) ? item : null;
              break;

            default:
              return (page === item.slug) ? item : null;
          }
        });
        
        // set the global currentPage
        Polymer.globalsManager.set('Dorel.current.page', self.currentPage);
      },

      /**
       * @name: _currentPageChanged
       * @description: fire the change-section event, that will set the given
       * title to its title tag
       */
      _currentPageChanged: function(newVal) {
        if(typeof newVal === 'undefined') return;

        this.fire('change-section', { 
          title: newVal.title.rendered
        });
      },

      /**
       * @name: _domChange
       * @description: This is for performance logging only.
       */
      _domChange: function(e) {
        if (window.performance && performance.mark && !this.__loggedDomChange) {
          var target = Polymer.dom(e).rootTarget;
          if (target.domHost.is.match(this.page)) {
            this.__loggedDomChange = true;
            performance.mark(target.domHost.is + '.domChange');
          }
        }
      },

      /**
       * @name: _eventTracking
       * @description: this is for pageload tracking only
       * more info: https://docs.google.com/presentation/d/1x5JfMGGglyHD8acEXpgSXfVGuXcUuSixbhZM6CTkSQo/edit#slide=id.p
       */
      _eventTracking: function() {
        /** 
         * Tracking on pageload
         */
        Polymer.globalsManager.set('Dorel.events', {
          action: 'loaded',
          component: this.page,
          element: this,
          event: 'polymer_event'
        });
      }
    });


  </script>
</dom-module>
