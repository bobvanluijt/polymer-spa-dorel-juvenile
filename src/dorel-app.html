<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../bower_components/iron-media-query/iron-media-query.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">

<!-- SHARED BEHAVIORS -->
<link rel="import" href="utils/behaviors/single/dorel-has-value-behavior.html">
<link rel="import" href="utils/behaviors/single/dorel-object-has-properties-behavior.html">

<!-- used by store locator -->
<link rel="import" href="atoms/dorel-safe-html.html">

<!-- TODO: These should only be included conditionally, based on the app-config.js AVAILABLE_BRANDS -->
<link rel="import" href="themes/theme-maxi-cosi-shared-styles.html">
<link rel="import" href="themes/theme-dorel-shared-styles.html">
<link rel="import" href="themes/theme-quinny-shared-styles.html">

<!-- Header has priority for perceived initial load -->
<link rel="import" href="organisms/dorel-header.html">

<!-- Since 'home' is the default route, eagerly load it. -->
<link rel="import" href="templates/dorel-template-home.html">

<!-- Load the breakpoints early as well -->
<link rel="import" href="atoms/dorel-media-query.html">

<!-- Load the magento authentication eagerly -->
<link rel="import" href="utils/dorel-magento-auth.html">

<link rel="import" href="utils/dorel-gmt-collect-faqs.html">
<link rel="import" href="utils/dorel-wp-collect-menu-locations.html">
<link rel="import" href="utils/dorel-wp-collect-pages.html">
<link rel="import" href="utils/dorel-wp-collect-options.html">
<link rel="import" href="utils/dorel-wp-collect-widgets.html">
<link rel="import" href="utils/dorel-multilingual-manager.html">
<link rel="import" href="utils/dorel-wp-collect-categories.html">
<link rel="import" href="utils/dorel-meta-manager.html">
<link rel="import" href="utils/dorel-main-routing.html">
<link rel="import" href="utils/dorel-product-category-manager.html">
<link rel="import" href="utils/dorel-brand-manager.html">

<link rel="import" href="atoms/dorel-grid-overlay.html">

<dom-module id="dorel-app">
  <template>
    <style>
      /*
       * Application wide styling
       * - Will define standard styling for components
       */
      :host {
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        @apply(--theme-typography-2);
        margin: 0;
        --primary-color: var(--theme-brand-color-1);
        color: var(--theme-color-black);
        display: block;
        min-height: 100vh;
      }

      :root {
        /* global input colors */
        --paper-input-container-underline: {
          border-bottom: 2px solid var(--theme-brand-color-1);
        };

      }

      main {
        min-height: calc(100vh - 155px);
      }

      iron-pages {
        margin: 0 auto;
        min-height: 100vh;
      }

    </style>

    <!-- retrieve all menu items from wordpress (uses rest api menus plugin) -->
    <dorel-wp-collect-menu-locations app-cache="[[ appCache ]]"></dorel-wp-collect-menu-locations>

    <!-- collect all pages from wordpress -->
    <dorel-wp-collect-pages app-cache="[[ appCache ]]"></dorel-wp-collect-pages>

    <!-- collect the options pages -->
    <dorel-wp-collect-options app-cache="[[ appCache ]]"></dorel-wp-collect-options>

    <!-- collect the widgets from wordpress (uses rest api sidebars plugin) -->
    <dorel-wp-collect-widgets app-cache="[[ appCache ]]"></dorel-wp-collect-widgets>

    <!-- analytics -->
    <google-tag-manager cid="GTM-TW3TM86"></google-tag-manager>

    <dorel-gtm-events gtm-data="[[ appCache ]]"></dorel-gtm-events>

    <dorel-third-party app-cache="[[ appCache ]]"></dorel-third-party>

    <!-- define routing -->
    <app-location route="{{ route }}"></app-location>
    <app-route
      route="{{ route }}"
      pattern="/:page"
      data="{{ routeData }}"
      query-params="{{ queryParams }}"
      tail="{{ subroute }}"></app-route>

    <dorel-brand-manager
      query-params="[[ queryParams ]]"
      brandNames="{{ brandNames }}"
      brand="{{ brand }}">
    </dorel-brand-manager>

    <dorel-main-routing
      app-cache="[[ appCache ]]"
      route="[[ route ]]"
      category-page="{{ categoryPage }}"
      previous-states="{{ previousStates }}"
      current-page="{{ currentPage }}">
    </dorel-main-routing>

    <dorel-meta-manager
      brand-name="[[ brand.label ]]"
      current-page="[[ currentPage ]]"
      app-cache="[[ appCache ]]"
      id="metaManager">
    </dorel-meta-manager>

    <dorel-multilingual-manager
      current-language="{{ currentLanguage }}"
      continents-data="{{ continentsData }}">
    </dorel-multilingual-manager>

    <dorel-product-category-manager
      category-page="[[ categoryPage ]]"
      sort="{{ sort }}"
      category="{{ category }}">
    </dorel-product-category-manager>

    <template is="dom-if" if="[[ shouldShow(currentPage) ]]">
      <dorel-header
        app-cache="[[ appCache ]]"
        load-complete="[[ loadComplete ]]"
        continents-data="[[ continentsData ]]"
        current-language="[[ currentLanguage ]]"
        page="[[ page ]]"
        brand-name="[[ brand.label ]]"></dorel-header>
    </template>

    <!-- content pages -->
    <main id="main" role="main">

      <iron-pages role="main"
                  selected="[[ currentPage.template ]]"
                  attr-for-selected="name">

        <dorel-template-product-category-about
          name="product-category-about"
          template-data="[[ currentPage ]]"></dorel-template-product-category-about>

        <dorel-template-home
          name="home"
          template-data="[[ currentPage ]]"></dorel-template-home>

        <dorel-template-info
          name="info"
          app-cache="[[ appCache ]]"
          template-data="[[ currentPage ]]"></dorel-template-info>

        <dorel-template-info-overview
          name="info-overview"
          app-cache="[[ appCache ]]"
          template-data="[[ currentPage ]]"></dorel-template-info-overview>

        <dorel-template-store-locator
          name="store-locator"
          app-cache="[[ appCache ]]"
          template-data="[[ currentPage ]]"></dorel-template-store-locator>

        <dorel-template-products
          name="products"
          route="[[ subroute ]]"
          template-data="[[ currentPage ]]"></dorel-template-products>

        <dorel-template-product-detail
          name="product-detail"
          route="[[ subroute ]]"
          app-cache="[[ appCache ]]"
          category="[[ category ]]"
          template-data="[[ currentPage ]]"></dorel-template-product-detail>

        <dorel-template-product-category
          name="product-category"
          route="[[ subroute ]]"
          app-cache="[[ appCache ]]"
          category="[[ category ]]"
          template-data="[[ currentPage ]]"></dorel-template-product-category>

        <dorel-template-faq-overview
          name="faq-overview"
          app-cache="[[ appCache ]]"
          route="[[ subroute ]]"
          template-data="[[ currentPage ]]"></dorel-template-faq-overview>

        <dorel-template-faq-detail
          name="faq-detail"
          app-cache="[[ appCache ]]"
          route="[[ subroute ]]"
          template-data="[[ currentPage ]]"></dorel-template-faq-detail>

        <dorel-template-product-advisory-tool
          name="product-advisory-tool"
          app-cache="[[ appCache ]]"
          brand-name="[[ brand.label ]]"
          template-data="[[ currentPage ]]"></dorel-template-product-advisory-tool>

        <dorel-template-component-guide
          name="component-guide"
          app-cache="[[ appCache ]]"
          brand="{{ brand }}"
          available-brands="{{ brandNames }}"
          route="{{ subroute }}"></dorel-template-component-guide>

        <dorel-template-404 name="404"></dorel-template-404>

      </iron-pages>
    </main>

    <template
      is="dom-if"
      if="[[ shouldShow(currentPage) ]]">
      <dorel-footer
        app-cache="[[ appCache ]]"
        continents-data="[[ continentsData ]]"
        current-language="[[ currentLanguage ]]">
      </dorel-footer>
    </template>

    <dorel-grid-overlay
      app-cache="[[ appCache ]]"
      available-brands="{{ brandNames }}"
      selected-brand="{{ brand }}"
      page-route-path="{{ route.path }}"></dorel-grid-overlay>
  </template>

  <script>
    // performance logging
    window.performance && performance.mark && performance.mark('dorel-app - before register');

    Polymer({
      is: 'dorel-app',

      /**
       * @name properties
       * @description all properties this component uses
       */
      properties: {

        /**
         * @name route
         * @description defines the current route
         */
        route: {
          type: String
        },

        /**
         * @name page
         * @description define the current page
         */
        page: {
          type: String,
          notify: true,
          readOnly: false,
        },

        /**
         * @name brand
         * @description The currently selected brand
         */
        brand: {
          type: Object,
          value: function () {
            return CONFIG.AVAILABLE_BRANDS[CONFIG.SELECTED_BRAND];
          }
        },

        /**
         * @name brandNames
         * @description available brand names (from config), used for switching between brands
         */
        brandNames: {
          type: Array,
          value: function () {
            return CONFIG.AVAILABLE_BRANDS;
          }
        },

        /**
         * @name currentPage
         * @description defines the currentPage
         */
        currentPage: {
          type: Object
        },

        categoryPage: {
          type: Object
        },

        category: {
          type: Number
        },

        /**
         * @attribute
         * @name appCache
         * @description the temporary cache of the application,
         * contains data that used to be contained by the globalsManager
         */
        appCache: {
          type: Object
        },

      },

      /**
       * @name observers
       * @description observe if a function is called
       */
      observers: [
        '_pageChanged(currentPage)'
      ],

      created: function () {
        window.performance && performance.mark && performance.mark('dorel-app.created');

        // Custom elements polyfill safe way to indicate an element has been upgraded.
        this.removeAttribute('unresolved');
      },

      listeners: {
        'setAppCache': '_setAppCache'
      },

      _setAppCache: function (event) {
        var data = event.detail;
        var path = data.path;
        var value = data.value;
        if (data && path) {
          this.set('appCache.' + path, value);
        }
      },

      ready: function () {

        var appCache = {
          wpUrl: CONFIG.CMS_URL, // DONE
          dioApiUrl: CONFIG.DIO_API_URL, // marnix
          collect: {}, // marnix
          current: {}, // DONE
          product: {
            products: [], // aron | DONE
            attributes: {
              accordions: [], // aron | DONE
              features: [], // aron | DONE
              usps: [] // aron | DONE
            },
            retrievedCategories: [], // aron | DONE
            auth: {
              token: '', // aron | DONE
              timestamp: '' // // aron | DONE
            },
            colorMap: [] // aron | DONE
          },
          faqs: [], // aron | DONE
          events: {}, // DONE
          grid: { // DONE
            horizontal: false,
            vertical: false
          },
          previousState: {}
        };

        this.set('appCache', appCache);
      },

      /**
       * @observer
       * @name _pageChanged
       * @description when the page variable changes lazyload the page
       * or retrieve it all the way.
       * @param currentPage - Object - the previous page
       */
      _pageChanged: function (currentPage) {
        if (typeof currentPage === 'undefined' || currentPage === '') {
          return;
        }

        if (currentPage.template === 'home') {
          this._ensureLazyLoaded();
        } else {
          this.importHref(
            this.resolveUrl('templates/dorel-template-' + currentPage.template + '.html'),
            function () {
              this._ensureLazyLoaded();
            }, null, false);
        }

        // tracking of the pageload
        this._eventTracking();
      },

      /**
       * @name _ensureLazyLoaded
       * @description if the load is completed we will add the resources
       * the service worker will kick in after that.
       */
      _ensureLazyLoaded: function () {
        var self = this;

        // scroll up when a page is changed
        window.scrollTo(0, 0);

        // load lazy resources after render and set `loadComplete` when done.
        if (!this.loadComplete) {
          Polymer.RenderStatus.afterNextRender(this, function () {
            this.importHref(this.resolveUrl('dorel-app-resources.html'), function () {

              // Register service worker if supported.
              if ('serviceWorker' in navigator) {
                // navigator.serviceWorker.register('/service-worker.js');
              }

              this.loadComplete = true;
              this._removeLoadPlaceholder();
              // import the footer after the pages are loaded
              this.importHref(this.resolveUrl('organisms/dorel-footer.html'), null, null, false);
            });
          });
        }
      },

      /**
       * @name _removeLoadPlaceholder
       * @description removes loading spinner and placeholders before the page is loaded
       */
      _removeLoadPlaceholder: function () {
        var placeholder = document.getElementById('load-placeholder');
        placeholder.remove();
      },

      /**
       * @name _eventTracking
       * @description this is for pageload tracking only
       * more info http://bit.ly/2nb6I7G
       */
      _eventTracking: function () {
        var globalsObj = this.get('appCache');
        var globalsCopy = Object.assign({}, globalsObj);


        /**
         * Tracking on pageload
         */
        var event = {
          action: 'loaded',
          component: 'page',
          element: this,
          event: 'polymer_event',
          things: {
            'currentPage': (typeof globalsCopy.current.page === 'undefined') ?
              document.URL : globalsCopy.current.page,
            'globals': globalsCopy
          }
        };

        this.fire('setAppCache', { value: event, path: 'events' });
      },


      shouldShow: function (currentPage) {
        return Boolean(currentPage && currentPage.template !== 'product-advisory-tool');
      }

    });
  </script>
</dom-module>
